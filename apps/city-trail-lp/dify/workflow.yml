app:
  description: ''
  icon: ğŸ¤–
  icon_background: '#FFEAD5'
  mode: workflow
  name: tomoshibi
  use_icon_as_answer_icon: false
dependencies:
- current_identifier: null
  type: marketplace
  value:
    marketplace_plugin_unique_identifier: langgenius/gemini:0.7.4@5faf411e694e0da130a337347a625a3812b1b7502a0183382d66d92c841bf05a
    version: null
kind: app
version: 0.5.0
workflow:
  conversation_variables: []
  environment_variables: []
  features:
    file_upload:
      allowed_file_extensions:
      - .JPG
      - .JPEG
      - .PNG
      - .GIF
      - .WEBP
      - .SVG
      allowed_file_types:
      - image
      allowed_file_upload_methods:
      - local_file
      - remote_url
      enabled: false
      fileUploadConfig:
        attachment_image_file_size_limit: 2
        audio_file_size_limit: 50
        batch_count_limit: 5
        file_size_limit: 15
        file_upload_limit: 50
        image_file_batch_limit: 10
        image_file_size_limit: 10
        single_chunk_attachment_limit: 10
        video_file_size_limit: 100
        workflow_file_upload_limit: 10
      image:
        enabled: false
        number_limits: 3
        transfer_methods:
        - local_file
        - remote_url
      number_limits: 3
    opening_statement: ''
    retriever_resource:
      enabled: true
    sensitive_word_avoidance:
      enabled: false
    speech_to_text:
      enabled: false
    suggested_questions: []
    suggested_questions_after_answer:
      enabled: false
    text_to_speech:
      enabled: false
      language: ''
      voice: ''
  graph:
    edges:
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: start
        targetType: llm
      id: 1768558472266-source-1768597790579-target
      source: '1768558472266'
      sourceHandle: source
      target: '1768597790579'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: llm
        targetType: code
      id: 1768597790579-source-1768599287614-target
      source: '1768597790579'
      sourceHandle: source
      target: '1768599287614'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: code
        targetType: llm
      id: 1768599287614-source-1768599416646-target
      source: '1768599287614'
      sourceHandle: source
      target: '1768599416646'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: llm
        targetType: http-request
      id: 1768599416646-source-1768600394819-target
      source: '1768599416646'
      sourceHandle: source
      target: '1768600394819'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: http-request
        targetType: code
      id: 1768600394819-source-1768601299799-target
      source: '1768600394819'
      sourceHandle: source
      target: '1768601299799'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: code
        targetType: llm
      id: 1768601299799-source-1768601846740-target
      source: '1768601299799'
      sourceHandle: source
      target: '1768601846740'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: llm
        targetType: code
      id: 1768601846740-source-1768602035766-target
      source: '1768601846740'
      sourceHandle: source
      target: '1768602035766'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: code
        targetType: code
      id: 1768602035766-source-1768602131448-target
      source: '1768602035766'
      sourceHandle: source
      target: '1768602131448'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: code
        targetType: llm
      id: 1768602131448-source-1768602371187-target
      source: '1768602131448'
      sourceHandle: source
      target: '1768602371187'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: llm
        targetType: code
      id: 1768602371187-source-1768602505042-target
      source: '1768602371187'
      sourceHandle: source
      target: '1768602505042'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: code
        targetType: llm
      id: 1768602505042-source-1768602602678-target
      source: '1768602505042'
      sourceHandle: source
      target: '1768602602678'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: llm
        targetType: code
      id: 1768602602678-source-1768602757091-target
      source: '1768602602678'
      sourceHandle: source
      target: '1768602757091'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: code
        targetType: llm
      id: 1768602757091-source-1768603485259-target
      source: '1768602757091'
      sourceHandle: source
      target: '1768603485259'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: llm
        targetType: code
      id: 1768603485259-source-1768603594197-target
      source: '1768603485259'
      sourceHandle: source
      target: '1768603594197'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: code
        targetType: llm
      id: 1768603594197-source-1768603666915-target
      source: '1768603594197'
      sourceHandle: source
      target: '1768603666915'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: llm
        targetType: code
      id: 1768603666915-source-1768603767065-target
      source: '1768603666915'
      sourceHandle: source
      target: '1768603767065'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: code
        targetType: code
      id: 1768603767065-source-1768603843069-target
      source: '1768603767065'
      sourceHandle: source
      target: '1768603843069'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: code
        targetType: llm
      id: 1768603843069-source-1768603963490-target
      source: '1768603843069'
      sourceHandle: source
      target: '1768603963490'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: llm
        targetType: code
      id: 1768603963490-source-1768604146459-target
      source: '1768603963490'
      sourceHandle: source
      target: '1768604146459'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: code
        targetType: code
      id: 1768604146459-source-1768605957312-target
      source: '1768604146459'
      sourceHandle: source
      target: '1768605957312'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: code
        targetType: end
      id: 1768605957312-source-1768604222640-target
      source: '1768605957312'
      sourceHandle: source
      target: '1768604222640'
      targetHandle: target
      type: custom
      zIndex: 0
    nodes:
    - data:
        selected: false
        title: ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›
        type: start
        variables:
        - hint: ''
          label: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
          max_length: 2000
          options: []
          placeholder: ''
          required: true
          type: paragraph
          variable: prompt
        - default: medium
          hint: ''
          label: difficulty
          max_length: 48
          options:
          - easy
          - medium
          - hard
          placeholder: ''
          required: true
          type: select
          variable: difficulty
        - default: '7'
          hint: ''
          label: spot_count
          max_length: 48
          options: []
          placeholder: ''
          required: true
          type: number
          variable: spot_count
        - hint: ''
          label: theme_tags
          max_length: 256
          options: []
          placeholder: ''
          required: false
          type: text-input
          variable: theme_tags
        - hint: ''
          label: genre_support
          max_length: 100
          options: []
          placeholder: ''
          required: false
          type: text-input
          variable: genre_support
        - hint: ''
          label: tone_support
          max_length: 100
          options: []
          placeholder: ''
          required: false
          type: text-input
          variable: tone_support
        - hint: ''
          label: protagonist
          max_length: 200
          options: []
          placeholder: ''
          required: false
          type: text-input
          variable: protagonist
        - hint: ''
          label: objective
          max_length: 200
          options: []
          placeholder: ''
          required: false
          type: text-input
          variable: objective
        - hint: ''
          label: ending
          max_length: 200
          options: []
          placeholder: ''
          required: false
          type: text-input
          variable: ending
        - hint: ''
          label: when
          max_length: 100
          options: []
          placeholder: ''
          required: false
          type: text-input
          variable: when
        - hint: ''
          label: where
          max_length: 200
          options: []
          placeholder: ''
          required: false
          type: text-input
          variable: where
        - hint: ''
          label: purpose
          max_length: 200
          options: []
          placeholder: ''
          required: false
          type: text-input
          variable: purpose
        - hint: ''
          label: with_whom
          max_length: 100
          options: []
          placeholder: ''
          required: false
          type: text-input
          variable: with_whom
        - hint: ''
          label: center_lat
          max_length: 20
          options: []
          placeholder: ''
          required: false
          type: text-input
          variable: center_lat
        - hint: ''
          label: center_lng
          max_length: 20
          options: []
          placeholder: ''
          required: false
          type: text-input
          variable: center_lng
        - hint: ''
          label: radius_km
          max_length: 10
          options: []
          placeholder: ''
          required: false
          type: text-input
          variable: radius_km
      height: 499
      id: '1768558472266'
      position:
        x: 81.99365959572805
        y: 281.04736200195606
      positionAbsolute:
        x: 81.99365959572805
        y: 281.04736200195606
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        context:
          enabled: false
          variable_selector: []
        model:
          completion_params:
            max_output_tokens: 8192
            temperature: 0.3
            thinking_level: Low
          mode: chat
          name: gemini-3-flash-preview
          provider: langgenius/gemini/google
        prompt_template:
        - id: 0f5a1135-ce08-449f-b126-d96707e6967b
          role: system
          text: 'ã‚ãªãŸã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“è¨­è¨ˆã®å°‚é–€å®¶ã§ã™ã€‚

            ã‚¯ã‚¨ã‚¹ãƒˆç”Ÿæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’åˆ†æã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæœ¬å½“ã«æ±‚ã‚ã¦ã„ã‚‹ä½“é¨“ã‚’ç†è§£ã—ã¦ãã ã•ã„ã€‚

            å‡ºåŠ›ã¯å¿…ãšJSONå½¢å¼ã§è¡Œã£ã¦ãã ã•ã„ã€‚'
        - id: 46db2956-1745-4cd3-aa4a-bcd7c8fb97ca
          role: user
          text: "ä»¥ä¸‹ã®ã‚¯ã‚¨ã‚¹ãƒˆç”Ÿæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚\n\n\nã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆã€‘\nãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: {{#1768558472266.prompt#}}\n\
            é›£æ˜“åº¦: {{#1768558472266.difficulty#}}\nã‚¹ãƒãƒƒãƒˆæ•°: {{#1768558472266.spot_count#}}\n\
            ã‚¸ãƒ£ãƒ³ãƒ«: {{#1768558472266.genre_support#}}\nãƒˆãƒ¼ãƒ³: {{#1768558472266.tone_support#}}\n\
            ã„ã¤: {{#1768558472266.when#}}\nã©ã“ã§: {{#1768558472266.where#}}\nç›®çš„: {{#1768558472266.purpose#}}\n\
            èª°ã¨: {{#1768558472266.with_whom#}}\n\n\nã€åˆ†æé …ç›®ã€‘\n1. experience_type: å­¦ç¿’/å†’é™º/ãƒ­ãƒãƒ³ãƒãƒƒã‚¯/ãƒ•ã‚¡ãƒŸãƒªãƒ¼/ã²ã¨ã‚Šæ—…\
            \ ã®ã©ã‚Œã‹\n2. primary_themes: æ­´å²/ã‚¢ãƒ¼ãƒˆ/ã‚°ãƒ«ãƒ¡/è‡ªç„¶/å»ºç¯‰/æ–‡å­¦/ç§‘å­¦ ã‹ã‚‰æœ€å¤§3ã¤\n3. fitness_level:\
            \ è»½ã‚/æ™®é€š/ã—ã£ã‹ã‚Š\n4. learning_depth: è»½ã„è±†çŸ¥è­˜/ã—ã£ã‹ã‚Šå­¦ç¿’\n5. puzzle_expectation:\
            \ ç°¡å˜ã«è§£ããŸã„/ã˜ã£ãã‚Šè€ƒãˆãŸã„\n6. mood_keywords: ã“ã®ã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡¨ã™å½¢å®¹è©3ã¤\n7. must_include:\
            \ å¿…é ˆè¦ç´ \n8. must_avoid: é¿ã‘ã‚‹ã¹ãè¦ç´ \n9. inferred_area: æ¨æ¸¬ã•ã‚Œã‚‹ã‚¨ãƒªã‚¢å\n\n\nã€å‡ºåŠ›å½¢å¼ã€‘JSON\n\
            {\n  \"experience_type\": \"string\",\n  \"primary_themes\": [\"string\"\
            ],\n  \"fitness_level\": \"string\",\n  \"learning_depth\": \"string\"\
            ,\n  \"puzzle_expectation\": \"string\",\n  \"mood_keywords\": [\"string\"\
            ],\n  \"must_include\": [\"string\"],\n  \"must_avoid\": [\"string\"],\n\
            \  \"inferred_area\": \"string\",\n  \"analysis_summary\": \"string\"\n\
            }"
        selected: false
        title: LLM_ãƒ¦ãƒ¼ã‚¶ãƒ¼æ„å›³åˆ†æ
        type: llm
        vision:
          enabled: false
      height: 88
      id: '1768597790579'
      position:
        x: 387.25450374209146
        y: 302.04736200195606
      positionAbsolute:
        x: 387.25450374209146
        y: 302.04736200195606
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        code: "import json\nimport re\n\ndef main(llm_output: str) -> dict:\n    #\
          \ JSONéƒ¨åˆ†ã‚’æŠ½å‡º\n    json_match = re.search(r'\\{[\\s\\S]*\\}', llm_output)\n\
          \    if json_match:\n        try:\n            parsed = json.loads(json_match.group())\n\
          \            # å€‹åˆ¥ã®å¤‰æ•°ã¨ã—ã¦å‡ºåŠ›ï¼ˆDifyã®åˆ¶é™å¯¾å¿œï¼‰\n            return {\n           \
          \     \"experience_type\": parsed.get(\"experience_type\", \"å†’é™º\"),\n  \
          \              \"primary_themes\": \", \".join(parsed.get(\"primary_themes\"\
          , [\"æ­´å²\"])),\n                \"fitness_level\": parsed.get(\"fitness_level\"\
          , \"æ™®é€š\"),\n                \"learning_depth\": parsed.get(\"learning_depth\"\
          , \"è»½ã„è±†çŸ¥è­˜\"),\n                \"puzzle_expectation\": parsed.get(\"puzzle_expectation\"\
          , \"ç°¡å˜ã«è§£ããŸã„\"),\n                \"mood_keywords\": \", \".join(parsed.get(\"\
          mood_keywords\", [\"ãƒŸã‚¹ãƒ†ãƒªã‚¢ã‚¹\"])),\n                \"must_include\": \",\
          \ \".join(parsed.get(\"must_include\", [])),\n                \"must_avoid\"\
          : \", \".join(parsed.get(\"must_avoid\", [])),\n                \"inferred_area\"\
          : parsed.get(\"inferred_area\", \"\"),\n                \"analysis_summary\"\
          : parsed.get(\"analysis_summary\", \"\")\n            }\n        except:\n\
          \            pass\n    \n    # ãƒ‘ãƒ¼ã‚¹å¤±æ•—æ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ\n    return {\n        \"experience_type\"\
          : \"å†’é™º\",\n        \"primary_themes\": \"æ­´å²\",\n        \"fitness_level\"\
          : \"æ™®é€š\",\n        \"learning_depth\": \"è»½ã„è±†çŸ¥è­˜\",\n        \"puzzle_expectation\"\
          : \"ç°¡å˜ã«è§£ããŸã„\",\n        \"mood_keywords\": \"ãƒŸã‚¹ãƒ†ãƒªã‚¢ã‚¹\",\n        \"must_include\"\
          : \"\",\n        \"must_avoid\": \"\",\n        \"inferred_area\": \"\"\
          ,\n        \"analysis_summary\": \"åˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ\"\n    }"
        code_language: python3
        outputs:
          analysis_summary:
            children: null
            type: string
          experience_type:
            children: null
            type: string
          fitness_level:
            children: null
            type: string
          inferred_area:
            children: null
            type: string
          learning_depth:
            children: null
            type: string
          mood_keywords:
            children: null
            type: string
          must_avoid:
            children: null
            type: string
          must_include:
            children: null
            type: string
          primary_themes:
            children: null
            type: string
          puzzle_expectation:
            children: null
            type: string
        selected: false
        title: code_æ„å›³è§£æçµæœãƒ‘ãƒ¼ã‚¹
        type: code
        variables:
        - value_selector:
          - '1768597790579'
          - text
          value_type: string
          variable: llm_output
      height: 52
      id: '1768599287614'
      position:
        x: 689.2545037420914
        y: 302.04736200195606
      positionAbsolute:
        x: 689.2545037420914
        y: 302.04736200195606
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        context:
          enabled: false
          variable_selector: []
        model:
          completion_params:
            max_output_tokens: 8192
            temperature: 0.3
            thinking_level: Low
          mode: chat
          name: gemini-3-flash-preview
          provider: langgenius/gemini/google
        prompt_template:
        - id: 72c5350b-9813-4e99-a96c-81edf38a45ee
          role: system
          text: 'ã‚ãªãŸã¯æ—¥æœ¬ã®åœ°ç†ã¨æ­´å²ã«è©³ã—ã„å°‚é–€å®¶ã§ã™ã€‚

            æŒ‡å®šã•ã‚ŒãŸã‚¨ãƒªã‚¢ã«ã¤ã„ã¦ã€è¡—æ­©ãã‚¯ã‚¨ã‚¹ãƒˆã«å½¹ç«‹ã¤æƒ…å ±ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚

            å‡ºåŠ›ã¯å¿…ãšJSONå½¢å¼ã§è¡Œã£ã¦ãã ã•ã„ã€‚'
        - id: 780f826a-e979-4a5d-88b4-e1dbf7433398
          role: user
          text: "ä»¥ä¸‹ã®ã‚¨ãƒªã‚¢ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚\n\n\nã€ã‚¨ãƒªã‚¢æƒ…å ±ã€‘\næ¨æ¸¬ã‚¨ãƒªã‚¢å: {{#1768599287614.inferred_area#}}\n\
            å…¥åŠ›ã•ã‚ŒãŸå ´æ‰€: {{#1768558472266.where#}}\nãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: {{#1768558472266.prompt#}}\n\
            ä¸­å¿ƒåº§æ¨™: ç·¯åº¦{{#1768558472266.center_lat#}}, çµŒåº¦{{#1768558472266.center_lng#}}\n\
            æ¤œç´¢åŠå¾„: {{#1768558472266.radius_km#}}km\næ±‚ã‚ã‚‰ã‚Œã‚‹ãƒ†ãƒ¼ãƒ: {{#1768599287614.primary_themes#}}\n\
            \n\nã€åˆ†æé …ç›®ã€‘\n1. area_name: æ­£å¼ãªã‚¨ãƒªã‚¢å\n2. area_history: æ­´å²çš„èƒŒæ™¯ï¼ˆ100-200å­—ï¼‰\n\
            3. cultural_significance: æ–‡åŒ–çš„ãªé‡è¦æ€§\n4. typical_spots: å…¸å‹çš„ãªã‚¹ãƒãƒƒãƒˆã‚¿ã‚¤ãƒ—\n5. hidden_gems:\
            \ ç©´å ´çš„è¦ç´ \n6. walking_characteristics: æ­©è¡Œã®ç‰¹å¾´\n7. local_stories: ä¼èª¬ã‚„é€¸è©±\n\
            8. connection_points: ã‚¹ãƒãƒƒãƒˆã‚’ç¹‹ããƒ†ãƒ¼ãƒ\n\n\nã€å‡ºåŠ›å½¢å¼ã€‘JSON\n{\n  \"area_name\":\
            \ \"string\",\n  \"area_history\": \"string\",\n  \"cultural_significance\"\
            : \"string\",\n  \"typical_spots\": [\"string\"],\n  \"hidden_gems\":\
            \ [\"string\"],\n  \"walking_characteristics\": \"string\",\n  \"local_stories\"\
            : [\"string\"],\n  \"connection_points\": [\"string\"]\n}"
        selected: false
        title: LLM_ã‚¨ãƒªã‚¢ç‰¹æ€§åˆ†æ
        type: llm
        vision:
          enabled: false
      height: 88
      id: '1768599416646'
      position:
        x: 991.2723824179543
        y: 302.04736200195606
      positionAbsolute:
        x: 991.2723824179543
        y: 302.04736200195606
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        authorization:
          config: null
          type: no-auth
        body:
          data: []
          type: none
        headers: ''
        method: get
        params: 'location:{{#1768558472266.center_lat#}},{{#1768558472266.center_lng#}}

          radius:1000

          type:tourist_attraction

          language:ja

          key:AIzaSyBdjMNtxtVjl2rivvMSkBnhqMGJAeLYwGQ'
        retry_config:
          max_retries: 3
          retry_enabled: true
          retry_interval: 100
        selected: false
        ssl_verify: true
        timeout:
          connect: 10
          max_connect_timeout: 0
          max_read_timeout: 0
          max_write_timeout: 0
          read: 10
          write: 10
        title: HTTP_å®Ÿåœ¨ã‚¹ãƒãƒƒãƒˆæ¤œç´¢
        type: http-request
        url: https://maps.googleapis.com/maps/api/place/nearbysearch/json
        variables: []
      height: 153
      id: '1768600394819'
      position:
        x: 1294.7143112894146
        y: 302.04736200195606
      positionAbsolute:
        x: 1294.7143112894146
        y: 302.04736200195606
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        code: "import json\n\ndef main(body: str) -> dict:\n    data = json.loads(body)\n\
          \    spots = []\n    \n    for result in data.get(\"results\", []):\n  \
          \      spot = {\n            \"name\": result.get(\"name\", \"\"),\n   \
          \         \"lat\": result.get(\"geometry\", {}).get(\"location\", {}).get(\"\
          lat\", 0),\n            \"lng\": result.get(\"geometry\", {}).get(\"location\"\
          , {}).get(\"lng\", 0),\n            \"place_id\": result.get(\"place_id\"\
          , \"\"),\n            \"rating\": result.get(\"rating\", 0),\n         \
          \   \"reviews\": result.get(\"user_ratings_total\", 0),\n            \"\
          types\": \", \".join(result.get(\"types\", [])),\n            \"address\"\
          : result.get(\"vicinity\", \"\")\n        }\n        spots.append(spot)\n\
          \    \n    # ã‚¹ãƒãƒƒãƒˆã®æƒ…å ±ã‚’å€‹åˆ¥å¤‰æ•°ã¨ã—ã¦å‡ºåŠ›\n    spots_summary = \"\"\n    for i, s in\
          \ enumerate(spots):\n        spots_summary += f\"{i+1}. {s['name']} (è©•ä¾¡:\
          \ {s['rating']}, {s['address']})\\n\"\n    \n    return {\n        \"spots_json\"\
          : json.dumps(spots, ensure_ascii=False),\n        \"spots_count\": len(spots),\n\
          \        \"spots_summary\": spots_summary\n    }"
        code_language: python3
        outputs:
          spots_count:
            children: null
            type: number
          spots_json:
            children: null
            type: string
          spots_summary:
            children: null
            type: string
        selected: false
        title: CODE_å®Ÿåœ¨ã‚¹ãƒãƒƒãƒˆæ¤œç´¢ãƒ‘ãƒ¼ã‚¹
        type: code
        variables:
        - value_selector:
          - '1768600394819'
          - body
          value_type: string
          variable: body
      height: 52
      id: '1768601299799'
      position:
        x: 1596.7143112894146
        y: 302.04736200195606
      positionAbsolute:
        x: 1596.7143112894146
        y: 302.04736200195606
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        context:
          enabled: false
          variable_selector: []
        model:
          completion_params:
            max_output_tokens: 8192
            temperature: 0.3
            thinking_level: Low
          mode: chat
          name: gemini-3-flash-preview
          provider: langgenius/gemini/google
        prompt_template:
        - id: 9056441e-e9cf-4194-a354-32cb56ec70fa
          role: system
          text: 'ã‚ãªãŸã¯ã‚¯ã‚¨ã‚¹ãƒˆãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼ã§ã™ã€‚

            è¦³å…‰ã‚¹ãƒãƒƒãƒˆã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ±‚ã‚ã‚‹ä½“é¨“ã¨ã®é©åˆåº¦ã§ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã—ã¾ã™ã€‚

            å‡ºåŠ›ã¯å¿…ãšJSONå½¢å¼ã§è¡Œã£ã¦ãã ã•ã„ã€‚'
        - id: 3739734d-7858-49c7-bfc2-7f6e8908a2e5
          role: user
          text: "ä»¥ä¸‹ã®ã‚¹ãƒãƒƒãƒˆå€™è£œã‚’ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ±‚ã‚ã‚‹ä½“é¨“ã¨ã®é©åˆåº¦ã§ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã—ã¦ãã ã•ã„ã€‚\n\n\nã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ±‚ã‚ã‚‹ä½“é¨“ã€‘\nä½“é¨“ã‚¿ã‚¤ãƒ—:\
            \ {{#1768599287614.experience_type#}}\nä¸»è¦ãƒ†ãƒ¼ãƒ: {{#1768599287614.primary_themes#}}\n\
            å­¦ã³ã®æ·±ã•: {{#1768599287614.fitness_level#}}\nè¬ã®æœŸå¾…: {{#1768599287614.puzzle_expectation#}}\n\
            å¿…é ˆè¦ç´ : {{#1768599287614.must_include#}}\né¿ã‘ã‚‹ã¹ãè¦ç´ : {{#1768599287614.must_avoid#}}\n\
            \n\nã€ã‚¨ãƒªã‚¢æƒ…å ±ã€‘\n{{#1768599416646.text#}}\n\n\nã€ã‚¹ãƒãƒƒãƒˆå€™è£œã€‘\n{{#1768601299799.spots_summary#}}\n\
            \n\nã€å¿…è¦ãªã‚¹ãƒãƒƒãƒˆæ•°ã€‘\n{{#1768558472266.spot_count#}}ä»¶\n\n\nã€ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°åŸºæº–ï¼ˆå„0-100ç‚¹ï¼‰ã€‘\n\
            1. theme_fit: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ±‚ã‚ã‚‹ãƒ†ãƒ¼ãƒã¨ã®ä¸€è‡´åº¦\n2. educational_value: ã€Œã¸ã‡ï¼ã€ã¨æ€ãˆã‚‹å­¦ã³ãŒã‚ã‚‹ã‹\n\
            3. puzzle_potential: è¬è§£ãã®ãƒã‚¿ã«ãªã‚Šãã†ã‹\n4. walkability: ãƒ«ãƒ¼ãƒˆã«çµ„ã¿è¾¼ã¿ã‚„ã™ã„ã‹ï¼ˆä½ç½®é–¢ä¿‚ï¼‰\n\
            5. uniqueness: ã“ã®ã‚¹ãƒãƒƒãƒˆãªã‚‰ã§ã¯ã®ç‰¹åˆ¥æ„Ÿ\n\n\nã€å‡ºåŠ›å½¢å¼ã€‘JSONé…åˆ—\nå¿…è¦ãªã‚¹ãƒãƒƒãƒˆæ•° + äºˆå‚™3ä»¶ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚\n\
            \n\n[\n  {\n    \"name\": \"ã‚¹ãƒãƒƒãƒˆå\",\n    \"lat\": ç·¯åº¦,\n    \"lng\": çµŒåº¦,\n\
            \    \"place_id\": \"place_id\",\n    \"address\": \"ä½æ‰€\",\n    \"theme_fit\"\
            : ç‚¹æ•°,\n    \"educational_value\": ç‚¹æ•°,\n    \"puzzle_potential\": ç‚¹æ•°,\n\
            \    \"walkability\": ç‚¹æ•°,\n    \"uniqueness\": ç‚¹æ•°,\n    \"total\": åˆè¨ˆç‚¹,\n\
            \    \"selection_reason\": \"ã“ã®ã‚¹ãƒãƒƒãƒˆã‚’é¸ã‚“ã ç†ç”±ï¼ˆ1æ–‡ï¼‰\",\n    \"historical_facts\"\
            : [\"ã“ã®ã‚¹ãƒãƒƒãƒˆã®æ­´å²çš„äº‹å®Ÿ1\", \"äº‹å®Ÿ2\"],\n    \"puzzle_ideas\": [\"è¬ã®ã‚¢ã‚¤ãƒ‡ã‚¢1\", \"\
            ã‚¢ã‚¤ãƒ‡ã‚¢2\"]\n  }\n]\n\n\ntotalãŒé«˜ã„é †ã«ä¸¦ã¹ã¦ãã ã•ã„ã€‚"
        selected: false
        title: LLM_ãƒ†ãƒ¼ãƒã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°
        type: llm
        vision:
          enabled: false
      height: 88
      id: '1768601846740'
      position:
        x: 1898.7143112894146
        y: 302.04736200195606
      positionAbsolute:
        x: 1898.7143112894146
        y: 302.04736200195606
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        code: "import json\nimport re\n\ndef main(llm_output: str) -> dict:\n    #\
          \ JSONéƒ¨åˆ†ã‚’æŠ½å‡º\n    json_match = re.search(r'\\[[\\s\\S]*\\]', llm_output)\n\
          \    if json_match:\n        try:\n            spots = json.loads(json_match.group())\n\
          \            \n            # ã‚¹ãƒãƒƒãƒˆä¸€è¦§ã‚’ãƒ†ã‚­ã‚¹ãƒˆåŒ–\n            spots_text = \"\"\
          \n            for i, s in enumerate(spots):\n                spots_text\
          \ += f\"{i+1}. {s.get('name', '')} (ã‚¹ã‚³ã‚¢: {s.get('total', 0)})\\n\"\n   \
          \         \n            return {\n                \"scored_spots_json\"\
          : json.dumps(spots, ensure_ascii=False),\n                \"scored_spots_count\"\
          : len(spots),\n                \"scored_spots_text\": spots_text\n     \
          \       }\n        except:\n            pass\n    \n    return {\n     \
          \   \"scored_spots_json\": \"[]\",\n        \"scored_spots_count\": 0,\n\
          \        \"scored_spots_text\": \"ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ\"\n    }"
        code_language: python3
        outputs:
          scored_spots_count:
            children: null
            type: number
          scored_spots_json:
            children: null
            type: string
          scored_spots_text:
            children: null
            type: string
        selected: false
        title: CODE_ãƒ†ãƒ¼ãƒã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ãƒ‘ãƒ¼ã‚¹
        type: code
        variables:
        - value_selector:
          - '1768601846740'
          - text
          value_type: string
          variable: llm_output
      height: 52
      id: '1768602035766'
      position:
        x: 2200.7143112894146
        y: 302.04736200195606
      positionAbsolute:
        x: 2200.7143112894146
        y: 302.04736200195606
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        code: "import json\nimport math\n\ndef haversine_distance(lat1, lng1, lat2,\
          \ lng2):\n    R = 6371000\n    phi1 = math.radians(float(lat1))\n    phi2\
          \ = math.radians(float(lat2))\n    delta_phi = math.radians(float(lat2)\
          \ - float(lat1))\n    delta_lambda = math.radians(float(lng2) - float(lng1))\n\
          \    \n    a = math.sin(delta_phi/2)**2 + math.cos(phi1) * math.cos(phi2)\
          \ * math.sin(delta_lambda/2)**2\n    c = 2 * math.atan2(math.sqrt(a), math.sqrt(1-a))\n\
          \    return R * c\n\ndef optimize_route(spots, start_lat, start_lng):\n\
          \    if not spots:\n        return []\n    remaining = spots.copy()\n  \
          \  route = []\n    current_lat, current_lng = float(start_lat), float(start_lng)\n\
          \    \n    while remaining:\n        nearest = min(remaining, key=lambda\
          \ s: haversine_distance(\n            current_lat, current_lng, s.get('lat',\
          \ 0), s.get('lng', 0)\n        ))\n        route.append(nearest)\n     \
          \   remaining.remove(nearest)\n        current_lat = nearest.get('lat',\
          \ current_lat)\n        current_lng = nearest.get('lng', current_lng)\n\
          \    return route\n\ndef main(scored_spots_json: str, spot_count: int, center_lat:\
          \ str, center_lng: str) -> dict:\n    spots = json.loads(scored_spots_json)\n\
          \    \n    if not spots:\n        return {\n            \"optimized_spots_json\"\
          : \"[]\",\n            \"optimized_spots_text\": \"ã‚¹ãƒãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“\",\n     \
          \       \"total_distance_m\": 0,\n            \"walking_time_min\": 0\n\
          \        }\n    \n    # ä¸Šä½ã‚¹ãƒãƒƒãƒˆã‚’å–å¾—\n    top_spots = spots[:int(spot_count)\
          \ + 2]\n    \n    # ãƒ«ãƒ¼ãƒˆæœ€é©åŒ–\n    start_lat = center_lat if center_lat else\
          \ \"35.7148\"\n    start_lng = center_lng if center_lng else \"139.7967\"\
          \n    optimized = optimize_route(top_spots, start_lat, start_lng)\n    \n\
          \    # å¿…è¦æ•°ã«çµã‚Šè¾¼ã¿\n    final_route = optimized[:int(spot_count)]\n    \n \
          \   # ã‚¹ãƒãƒƒãƒˆIDä»˜ä¸\n    for i, spot in enumerate(final_route):\n        spot['spot_index']\
          \ = i + 1\n        spot['spot_id'] = f\"S{i + 1}\"\n    \n    # ç·è·é›¢è¨ˆç®—\n\
          \    total_distance = 0\n    for i in range(1, len(final_route)):\n    \
          \    total_distance += haversine_distance(\n            final_route[i-1].get('lat',\
          \ 0), final_route[i-1].get('lng', 0),\n            final_route[i].get('lat',\
          \ 0), final_route[i].get('lng', 0)\n        )\n    \n    # ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼\n    spots_text\
          \ = \"\"\n    for s in final_route:\n        spots_text += f\"{s['spot_id']}:\
          \ {s['name']} ({s.get('address', '')})\\n\"\n        spots_text += f\" \
          \  - é¸å®šç†ç”±: {s.get('selection_reason', '')}\\n\"\n        spots_text += f\"\
          \   - æ­´å²: {', '.join(s.get('historical_facts', []))}\\n\"\n        spots_text\
          \ += f\"   - è¬ã‚¢ã‚¤ãƒ‡ã‚¢: {', '.join(s.get('puzzle_ideas', []))}\\n\\n\"\n   \
          \ \n    return {\n        \"optimized_spots_json\": json.dumps(final_route,\
          \ ensure_ascii=False),\n        \"optimized_spots_text\": spots_text,\n\
          \        \"total_distance_m\": int(total_distance),\n        \"walking_time_min\"\
          : int(total_distance / 80)\n    }"
        code_language: python3
        outputs:
          optimized_spots_json:
            children: null
            type: string
          optimized_spots_text:
            children: null
            type: string
          total_distance_m:
            children: null
            type: number
          walking_time_min:
            children: null
            type: number
        selected: false
        title: CODE_ãƒ«ãƒ¼ãƒˆæœ€é©åŒ–
        type: code
        variables:
        - value_selector:
          - '1768602035766'
          - scored_spots_json
          value_type: string
          variable: scored_spots_json
        - value_selector:
          - '1768558472266'
          - spot_count
          value_type: number
          variable: spot_count
        - value_selector:
          - '1768558472266'
          - center_lat
          value_type: string
          variable: center_lat
        - value_selector:
          - '1768558472266'
          - center_lng
          value_type: string
          variable: center_lng
      height: 52
      id: '1768602131448'
      position:
        x: 2502.7143112894146
        y: 302.04736200195606
      positionAbsolute:
        x: 2502.7143112894146
        y: 302.04736200195606
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        context:
          enabled: false
          variable_selector: []
        model:
          completion_params:
            max_output_tokens: 8192
            temperature: 0.3
            thinking_level: Low
          mode: chat
          name: gemini-3-flash-preview
          provider: langgenius/gemini/google
        prompt_template:
        - id: 3c994e36-28b1-420b-911c-6b112e4c2ef4
          role: system
          text: 'ã‚ãªãŸã¯è¬è§£ãã‚²ãƒ¼ãƒ ã®ç‰©èªæ§‹æˆã®å°‚é–€å®¶ã§ã™ã€‚

            å„ã‚¹ãƒãƒƒãƒˆã«ç‰©èªä¸Šã®å½¹å‰²ã¨è¬ã®ã‚¿ã‚¤ãƒ—ã‚’å‰²ã‚Šå½“ã¦ã¾ã™ã€‚

            å‡ºåŠ›ã¯å¿…ãšJSONå½¢å¼ã§è¡Œã£ã¦ãã ã•ã„ã€‚'
        - id: c097160a-c146-4b61-aab6-00ff1309abdb
          role: user
          text: "ä»¥ä¸‹ã®ã‚¹ãƒãƒƒãƒˆã‚’ä½¿ã£ã¦ã€ä¸€è²«ã—ãŸè¬è§£ãç‰©èªã‚’æ§‹ç¯‰ã™ã‚‹ãŸã‚ã€å„ã‚¹ãƒãƒƒãƒˆã®å½¹å‰²ã‚’æ±ºå®šã—ã¦ãã ã•ã„ã€‚\n\n\nã€æœ€é©åŒ–ã•ã‚ŒãŸã‚¹ãƒãƒƒãƒˆä¸€è¦§ã€‘\n\
            {{#1768602131448.optimized_spots_text#}}\n\n\nã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ±‚ã‚ã‚‹ä½“é¨“ã€‘\nä½“é¨“ã‚¿ã‚¤ãƒ—: {{#1768599287614.experience_type#}}\n\
            ãƒ†ãƒ¼ãƒ: {{#1768599287614.primary_themes#}}\nå­¦ã³: {{#1768599287614.learning_depth#}}\n\
            é›°å›²æ°—: {{#1768599287614.mood_keywords#}}\n\nã€scene_roleã®ç¨®é¡ã¨èª¬æ˜ã€‘\n- å°å…¥: ç‰©èªã®å§‹ã¾ã‚Šã€‚ä¸–ç•Œè¦³ã‚’æç¤ºã™ã‚‹ã€‚å¿…ãšæœ€åˆã®ã‚¹ãƒãƒƒãƒˆã€‚\n\
            - å±•é–‹: æƒ…å ±åé›†ãƒ•ã‚§ãƒ¼ã‚ºã€‚è¬ãŒæ·±ã¾ã‚Šã€æ‰‹ãŒã‹ã‚ŠãŒå¢—ãˆã‚‹ã€‚\n- è»¢æ›: çŠ¶æ³ãŒå¤‰ã‚ã‚‹é‡è¦åœ°ç‚¹ã€‚æ–°äº‹å®ŸãŒåˆ¤æ˜ã™ã‚‹ã€‚ä¸­ç›¤ã«1-2å€‹ã€‚\n-\
            \ çœŸç›¸æ¥è¿‘: æ ¸å¿ƒã«è¿«ã‚‹ã€‚ç­”ãˆã«è¿‘ã¥ã„ã¦ã„ã‚‹ç·Šå¼µæ„Ÿã€‚\n- çµæœ«: ç‰©èªã®ç· ã‚ããã‚Šã€‚é”æˆæ„Ÿã¨ä½™éŸ»ã€‚å¿…ãšæœ€å¾Œã®ã‚¹ãƒãƒƒãƒˆã€‚\n\n\nã€puzzle_typeã®ç¨®é¡ã€‘\n\
            - logic: è«–ç†ãƒ‘ã‚ºãƒ«ï¼ˆè¨¼è¨€æ•´ç†ã€æ¡ä»¶åˆ†å²ï¼‰\n- pattern: ãƒ‘ã‚¿ãƒ¼ãƒ³èªè­˜ï¼ˆæ•°åˆ—ã€å›³å½¢ï¼‰\n- cipher: æš—å·è§£èª­ï¼ˆæ›å­—å¼ã€ä½ç½®æš—å·ï¼‰\n\
            - wordplay: è¨€è‘‰éŠã³ï¼ˆæ¼¢å­—åˆ†è§£ã€ã‚¢ãƒŠã‚°ãƒ©ãƒ ï¼‰\n- observation: è¦³å¯Ÿãƒ‘ã‚ºãƒ«ï¼ˆç¾åœ°ã§è¦‹ã¤ã‘ã‚‹ï¼‰\n\n\nã€plot_key_typeã®ç¨®é¡ã€‘\n\
            - keyword: ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰\n- number: æ•°å­—ãƒ»å¹´å·\n- name: äººç‰©åãƒ»åœ°å\n- symbol: è¨˜å·ãƒ»ç´‹ç« \n\n\
            \nã€å‡ºåŠ›å½¢å¼ã€‘JSON\n{\n  \"motifs\": [\n    {\n      \"spot_id\": \"S1\",\n\
            \      \"spot_name\": \"ã‚¹ãƒãƒƒãƒˆå\",\n      \"scene_role\": \"å°å…¥\",\n    \
            \  \"puzzle_type\": \"observation\",\n      \"plot_key_type\": \"keyword\"\
            ,\n      \"learning_elements\": [\"ã“ã®ã‚¹ãƒãƒƒãƒˆã§å­¦ã¹ã‚‹ã“ã¨1\", \"å­¦ã¹ã‚‹ã“ã¨2\"],\n   \
            \   \"story_beat\": \"ç‰©èªä¸Šã€ã“ã®ã‚¹ãƒãƒƒãƒˆã§èµ·ã“ã‚‹ã“ã¨ï¼ˆ1æ–‡ï¼‰\",\n      \"puzzle_concept\"\
            : \"ã“ã®è¬ã®åŸºæœ¬ã‚³ãƒ³ã‚»ãƒ—ãƒˆï¼ˆ1æ–‡ï¼‰\"\n    }\n  ],\n  \"overall_narrative\": \"ç‰©èªå…¨ä½“ã®æµã‚Œï¼ˆ3-4æ–‡ï¼‰\"\
            ,\n  \"meta_puzzle_concept\": \"æœ€çµ‚è¬ã®åŸºæœ¬ã‚¢ã‚¤ãƒ‡ã‚¢\"\n}\n\n\nã€é‡è¦ãƒ«ãƒ¼ãƒ«ã€‘\n- æœ€åˆã®ã‚¹ãƒãƒƒãƒˆã¯å¿…ãšã€Œå°å…¥ã€\n\
            - æœ€å¾Œã®ã‚¹ãƒãƒƒãƒˆã¯å¿…ãšã€Œçµæœ«ã€\n- ã€Œè»¢æ›ã€ã¯ä¸­ç›¤ã«1-2å€‹"
        selected: false
        title: LLMãƒ¢ãƒãƒ¼ãƒ•é¸å®š
        type: llm
        vision:
          enabled: false
      height: 88
      id: '1768602371187'
      position:
        x: 2804.7143112894146
        y: 302.04736200195606
      positionAbsolute:
        x: 2804.7143112894146
        y: 302.04736200195606
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        code: "import json\nimport re\n\ndef main(llm_output: str) -> dict:\n    json_match\
          \ = re.search(r'\\{[\\s\\S]*\\}', llm_output)\n    if json_match:\n    \
          \    try:\n            data = json.loads(json_match.group())\n         \
          \   motifs = data.get(\"motifs\", [])\n            \n            # ãƒ¢ãƒãƒ¼ãƒ•ãƒ†ã‚­ã‚¹ãƒˆåŒ–\n\
          \            motifs_text = \"\"\n            for m in motifs:\n        \
          \        motifs_text += f\"{m.get('spot_id')}: {m.get('spot_name')}\\n\"\
          \n                motifs_text += f\"  å½¹å‰²: {m.get('scene_role')}\\n\"\n \
          \               motifs_text += f\"  è¬ã‚¿ã‚¤ãƒ—: {m.get('puzzle_type')}\\n\"\n\
          \                motifs_text += f\"  éµã‚¿ã‚¤ãƒ—: {m.get('plot_key_type')}\\n\"\
          \n                motifs_text += f\"  å­¦ã³: {', '.join(m.get('learning_elements',\
          \ []))}\\n\"\n                motifs_text += f\"  ç‰©èª: {m.get('story_beat')}\\\
          n\"\n                motifs_text += f\"  è¬ã‚³ãƒ³ã‚»ãƒ—ãƒˆ: {m.get('puzzle_concept')}\\\
          n\\n\"\n            \n            return {\n                \"motifs_json\"\
          : json.dumps(motifs, ensure_ascii=False),\n                \"motifs_text\"\
          : motifs_text,\n                \"overall_narrative\": data.get(\"overall_narrative\"\
          , \"\"),\n                \"meta_puzzle_concept\": data.get(\"meta_puzzle_concept\"\
          , \"\"),\n                \"motifs_count\": len(motifs)\n            }\n\
          \        except:\n            pass\n    \n    return {\n        \"motifs_json\"\
          : \"[]\",\n        \"motifs_text\": \"ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ\",\n        \"overall_narrative\"\
          : \"\",\n        \"meta_puzzle_concept\": \"\",\n        \"motifs_count\"\
          : 0\n    }"
        code_language: python3
        outputs:
          meta_puzzle_concept:
            children: null
            type: string
          motifs_count:
            children: null
            type: number
          motifs_json:
            children: null
            type: string
          motifs_text:
            children: null
            type: string
          overall_narrative:
            children: null
            type: string
        selected: false
        title: CODE_ãƒ¢ãƒãƒ¼ãƒ•é¸å®šãƒ‘ãƒ¼ã‚¹
        type: code
        variables:
        - value_selector:
          - '1768602371187'
          - text
          value_type: string
          variable: llm_output
      height: 52
      id: '1768602505042'
      position:
        x: 3106.7143112894146
        y: 302.04736200195606
      positionAbsolute:
        x: 3106.7143112894146
        y: 302.04736200195606
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        context:
          enabled: false
          variable_selector: []
        model:
          completion_params:
            max_output_tokens: 8192
            temperature: 0.3
            thinking_level: Low
          mode: chat
          name: gemini-3-flash-preview
          provider: langgenius/gemini/google
        prompt_template:
        - id: 7659cb48-ffe5-4179-8f71-b2216b5825db
          role: system
          text: 'ã‚ãªãŸã¯ã€Œæ˜ ç”»äºˆå‘Šç·¨ã®ã‚ˆã†ã«æ²¡å…¥æ„Ÿã‚’ä½œã‚‹ã€ãƒˆãƒƒãƒ—ã‚³ãƒ”ãƒ¼ãƒ©ã‚¤ã‚¿ãƒ¼å…¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼è¨­è¨ˆè€…ã§ã™ã€‚

            è¡—æ­©ãè¬è§£ãã‚¯ã‚¨ã‚¹ãƒˆã®ç‰©èªéª¨æ ¼ã‚’æ§‹ç¯‰ã—ã¦ãã ã•ã„ã€‚

            å‡ºåŠ›ã¯å¿…ãšJSONå½¢å¼ã§è¡Œã£ã¦ãã ã•ã„ã€‚'
        - id: 31be4b35-8c27-45ae-bcbe-995b273aba67
          role: user
          text: "ä»¥ä¸‹ã®æƒ…å ±ã‚’ä½¿ã£ã¦ã€è¡—æ­©ãè¬è§£ãã‚¯ã‚¨ã‚¹ãƒˆã®ç‰©èªéª¨æ ¼ã‚’æ§‹ç¯‰ã—ã¦ãã ã•ã„ã€‚\n\n\nã€ã‚¹ãƒãƒƒãƒˆã¨ãƒ¢ãƒãƒ¼ãƒ•ã€‘\n{{#1768602505042.motifs_text#}}\n\
            \n\nã€ç‰©èªå…¨ä½“ã®æµã‚Œã€‘\n{{#1768602505042.overall_narrative#}}\n\n\nã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ±‚ã‚ã‚‹ä½“é¨“ã€‘\n\
            ä½“é¨“ã‚¿ã‚¤ãƒ—: {{#1768599287614.experience_type#}}\nãƒ†ãƒ¼ãƒ: {{#1768599287614.primary_themes#}}\n\
            é›°å›²æ°—: {{#1768599287614.mood_keywords#}}\n\n\nã€ã‚¨ãƒªã‚¢ã®æ­´å²ã€‘\n{{#1768599416646.text#}}\n\
            \n\nã€premiseï¼ˆå‰æèª¬æ˜ï¼‰ã®å¿…é ˆãƒ«ãƒ¼ãƒ«ã€‘\n- 500ã€œ800å­—ã€3ã€œ5æ®µè½\n- äºŒäººç§°ï¼ˆã‚ãªãŸï¼‰ä¸­å¿ƒã€ç¾åœ¨å½¢\n- æ®µè½ã¯æ”¹è¡Œã§åŒºåˆ‡ã‚‹\n\
            - æœ€å¾Œã®1æ–‡ã¯å•ã„ã‹ã‘ã§ç· ã‚ã‚‹\n- ãƒã‚¿ãƒãƒ¬ç¦æ­¢ï¼ˆç­”ãˆã€çŠ¯äººã€ã©ã‚“ã§ã‚“è¿”ã—ã¯æ›¸ã‹ãªã„ï¼‰\n- æ­´å²çš„äº‹å®Ÿã‹ã‚‰é€¸è„±ã—ãªã„\n\n\nã€premiseã«å¿…ãšå«ã‚ã‚‹8è¦ç´ ã€‘\n\
            1. é›°å›²æ°—ã®ä¸€æ’ƒç›®ï¼ˆæ˜ ç”»ã®ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°æ„Ÿï¼‰\n2. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å½¹å‰²ï¼ˆãªã‚Šãã‚Šï¼‰\n3. èˆå°ã®æå†™ï¼ˆå…·ä½“çš„ãªå ´æ‰€ï¼‰\n4. äº‹ä»¶ãƒ»ç•°å¤‰ï¼ˆå°å…¥ãƒ•ãƒƒã‚¯ï¼‰\n\
            5. ç—•è·¡ï¼ˆã‚·ãƒ³ãƒœãƒ«/æš—å·/ä¼æ‰¿/æ‰‹ãŒã‹ã‚Šï¼‰\n6. è³­ã‘é‡‘ï¼ˆã‚¿ã‚¤ãƒ ãƒªãƒŸãƒƒãƒˆ/å±æ©Ÿ/å¤±æ•—ç¤ºå”†ï¼‰\n7. ä½“é¨“ã®ç´„æŸï¼ˆãŸã ã®æ•£æ­©ã§ã¯ãªã„ï¼‰\n\
            8. CTAï¼ˆå•ã„ã‹ã‘ã§ç· ã‚ï¼‰\n\n\nã€å‡ºåŠ›å½¢å¼ã€‘JSON\n{\n  \"main_plot\": {\n    \"premise\"\
            : \"500ã€œ800å­—ã®å°å…¥æ–‡\",\n    \"goal\": \"ä¸»äººå…¬ã®ç›®çš„ï¼ˆ1ã€œ2æ–‡ï¼‰\",\n    \"antagonist_or_mystery\"\
            : \"å¯¾ç«‹è¦ç´ ã¾ãŸã¯ä¸­å¿ƒã®è¬ï¼ˆ1ã€œ2æ–‡ï¼‰\",\n    \"final_reveal_outline\": \"æœ€çµ‚çš„ãªçœŸç›¸ã®æ¦‚è¦ï¼ˆãƒã‚¿ãƒãƒ¬æ³¨æ„ã€æ›–æ˜§ã«ï¼‰\"\
            \n  },\n  \"spot_story_beats\": [\n    {\n      \"spot_id\": \"S1\",\n\
            \      \"story_beat\": \"ã“ã®åœ°ç‚¹ã§èµ·ã“ã‚‹ç‰©èªä¸Šã®å‡ºæ¥äº‹\",\n      \"emotional_arc\":\
            \ \"ã“ã®åœ°ç‚¹ã§ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ„Ÿæƒ…\",\n      \"key_discovery\": \"ã“ã®åœ°ç‚¹ã§ç™ºè¦‹ã™ã‚‹é‡è¦ãªã“ã¨\"\n \
            \   }\n  ]\n}"
        selected: false
        title: LLM_ç‰©èªéª¨æ ¼ç”Ÿæˆ
        type: llm
        vision:
          enabled: false
      height: 88
      id: '1768602602678'
      position:
        x: 3408.7143112894146
        y: 302.04736200195606
      positionAbsolute:
        x: 3408.7143112894146
        y: 302.04736200195606
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        code: "import json\nimport re\n\ndef main(llm_output: str) -> dict:\n    json_match\
          \ = re.search(r'\\{[\\s\\S]*\\}', llm_output)\n    if json_match:\n    \
          \    try:\n            data = json.loads(json_match.group())\n         \
          \   main_plot = data.get(\"main_plot\", {})\n            spot_beats = data.get(\"\
          spot_story_beats\", [])\n            \n            # ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ“ãƒ¼ãƒˆãƒ†ã‚­ã‚¹ãƒˆåŒ–\n   \
          \         beats_text = \"\"\n            for b in spot_beats:\n        \
          \        beats_text += f\"{b.get('spot_id')}: {b.get('story_beat')}\\n\"\
          \n                beats_text += f\"  æ„Ÿæƒ…: {b.get('emotional_arc')}\\n\"\n\
          \                beats_text += f\"  ç™ºè¦‹: {b.get('key_discovery')}\\n\\n\"\
          \n            \n            return {\n                \"premise\": main_plot.get(\"\
          premise\", \"\"),\n                \"goal\": main_plot.get(\"goal\", \"\"\
          ),\n                \"mystery\": main_plot.get(\"antagonist_or_mystery\"\
          , \"\"),\n                \"final_reveal\": main_plot.get(\"final_reveal_outline\"\
          , \"\"),\n                \"spot_beats_json\": json.dumps(spot_beats, ensure_ascii=False),\n\
          \                \"spot_beats_text\": beats_text\n            }\n      \
          \  except:\n            pass\n    \n    return {\n        \"premise\": \"\
          ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ\",\n        \"goal\": \"\",\n        \"mystery\": \"\",\n   \
          \     \"final_reveal\": \"\",\n        \"spot_beats_json\": \"[]\",\n  \
          \      \"spot_beats_text\": \"\"\n    }"
        code_language: python3
        outputs:
          final_reveal:
            children: null
            type: string
          goal:
            children: null
            type: string
          mystery:
            children: null
            type: string
          premise:
            children: null
            type: string
          spot_beats_json:
            children: null
            type: string
          spot_beats_text:
            children: null
            type: string
        selected: false
        title: CODE_ç‰©èªéª¨æ ¼ç”Ÿæˆãƒ‘ãƒ¼ã‚¹
        type: code
        variables:
        - value_selector:
          - '1768602602678'
          - text
          value_type: string
          variable: llm_output
      height: 52
      id: '1768602757091'
      position:
        x: 3710.7143112894146
        y: 302.04736200195606
      positionAbsolute:
        x: 3710.7143112894146
        y: 302.04736200195606
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        context:
          enabled: false
          variable_selector: []
        model:
          completion_params:
            max_output_tokens: 8192
            temperature: 0.3
            thinking_level: Low
          mode: chat
          name: gemini-3-flash-preview
          provider: langgenius/gemini/google
        prompt_template:
        - id: 06727bcd-26e0-4eae-bf9c-095f88e2b36e
          role: system
          text: 'ã‚ãªãŸã¯ã²ã‚‰ã‚ãå‹ãƒ‘ã‚ºãƒ«ã®è¬ä½œå®¶ã§ã™ã€‚

            ã€Œè§£ã = å­¦ã¶ã€ã‚’å®Ÿç¾ã™ã‚‹ã€ç¾ã—ã„è¬ã‚’è¨­è¨ˆã—ã¦ãã ã•ã„ã€‚

            å‡ºåŠ›ã¯å¿…ãšJSONå½¢å¼ã§è¡Œã£ã¦ãã ã•ã„ã€‚'
        - id: f6252950-9da1-4e16-877d-43ad42f02e1d
          role: user
          text: "ä»¥ä¸‹ã®å…¨ã‚¹ãƒãƒƒãƒˆã«å¯¾ã—ã¦ã€æ•™è‚²çš„ä¾¡å€¤ã®ã‚ã‚‹è¬ã‚’è¨­è¨ˆã—ã¦ãã ã•ã„ã€‚\n\n\nã€ç‰©èªã®å‰æã€‘\n{{#1768602757091.premise#}}\n\
            \n\nã€ç‰©èªã®ç›®çš„ã€‘\n{{#1768602757091.goal#}}\n\n\nã€ä¸­å¿ƒã®è¬ã€‘\n{{#1768602757091.mystery#}}\n\
            \n\nã€ã‚¹ãƒãƒƒãƒˆã¨ãƒ¢ãƒãƒ¼ãƒ•ã€‘\n{{#1768602505042.motifs_text#}}\n\n\nã€å„ã‚¹ãƒãƒƒãƒˆã®ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ“ãƒ¼ãƒˆã€‘\n\
            {{#1768602757091.spot_beats_text#}}\n\n\nã€è¬è¨­è¨ˆã®çµ¶å¯¾ãƒ«ãƒ¼ãƒ«ã€‘\n1. player_handoutï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è³‡æ–™ï¼‰ã ã‘ã§è§£ã‘ã‚‹ã“ã¨\n\
            2. å¤–éƒ¨çŸ¥è­˜ï¼ˆãƒãƒƒãƒˆæ¤œç´¢ã€æš—è¨˜ï¼‰ã¯ä¸è¦\n3. è§£ã„ãŸç¬é–“ã«ã€Œãã†ã‹ï¼ã€ã¨å­¦ã³ãŒã‚ã‚‹ã“ã¨\n4. ã‚¹ãƒãƒƒãƒˆã®æ­´å²/æ–‡åŒ–ã¨ç›´æ¥ã¤ãªãŒã£ã¦ã„ã‚‹ã“ã¨\n\
            5. ä¸­å­¦ç”Ÿã§ã‚‚èª­ã‚ã‚‹è¨€è‘‰ã§æ›¸ãã“ã¨\n\n\nã€ç¦æ­¢äº‹é …ã€‘\n- ã€Œâ—‹â—‹ã‚’å»ºã¦ãŸã®ã¯èª°ï¼Ÿã€ç³»ã®æš—è¨˜ã‚¯ã‚¤ã‚º\n- ã‚¹ãƒãƒƒãƒˆã¨é–¢ä¿‚ãªã„ä¸€èˆ¬ãƒ‘ã‚ºãƒ«\n\
            - ç­”ãˆãŒè¤‡æ•°é€šã‚Šã‚ã‚‹æ›–æ˜§ãªå•é¡Œ\n\n\nã€å‡ºåŠ›å½¢å¼ã€‘JSONé…åˆ—\n[\n  {\n    \"spot_id\": \"S1\",\n\
            \    \"spot_name\": \"ã‚¹ãƒãƒƒãƒˆå\",\n    \"scene_role\": \"å°å…¥\",\n    \"lore_card\"\
            : {\n      \"short_story_text\": \"ç‰©èªæ–‡ï¼ˆ2-4æ–‡ã€ã“ã®ã‚¹ãƒãƒƒãƒˆã®æ„å‘³ã¥ã‘ï¼‰\",\n      \"\
            player_handout\": \"ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç”¨è³‡æ–™ï¼ˆ100-200å­—ã€è¬ã‚’è§£ããƒ’ãƒ³ãƒˆå«ã‚€ï¼‰\"\n    },\n    \"puzzle\"\
            : {\n      \"type\": \"observation\",\n      \"prompt\": \"å‡ºé¡Œæ–‡ï¼ˆ50-100å­—ã€ç¾ã—ãè¬ã‚ã„ãŸèªã‚Šå£ã§ï¼‰\"\
            ,\n      \"answer\": \"ç­”ãˆï¼ˆæ˜ç¢ºã«ï¼‰\",\n      \"solution_steps\": [\n     \
            \   \"ã‚¹ãƒ†ãƒƒãƒ—1: ã¾ãšâ—‹â—‹ã‚’ç¢ºèªã™ã‚‹\",\n        \"ã‚¹ãƒ†ãƒƒãƒ—2: æ¬¡ã«â–³â–³ã‚’æ¯”è¼ƒã™ã‚‹\",\n        \"ã‚¹ãƒ†ãƒƒãƒ—3:\
            \ æœ€å¾Œã«â–¡â–¡ã‚’å°ãå‡ºã™\"\n      ],\n      \"hints\": [\n        \"æŠ½è±¡çš„ãªãƒ’ãƒ³ãƒˆ\",\n \
            \       \"å…·ä½“çš„ãªãƒ’ãƒ³ãƒˆ\",\n        \"æ•‘æ¸ˆãƒ’ãƒ³ãƒˆï¼ˆã»ã¼ç­”ãˆï¼‰\"\n      ],\n      \"difficulty\"\
            : 2\n    },\n    \"reward\": {\n      \"lore_reveal\": \"è¬ã‚’è§£ãã¨åˆ†ã‹ã‚‹èƒŒæ™¯ï¼ˆ2-3æ–‡ï¼‰\"\
            ,\n      \"plot_key\": \"ç‰©èªã®éµï¼ˆ1-5æ–‡å­—ï¼‰\",\n      \"next_hook\": \"æ¬¡ã®ã‚¹ãƒãƒƒãƒˆã¸è¡ŒããŸããªã‚‹ä¸€æ–‡\"\
            \n    }\n  }\n]\n\nå…¨ã‚¹ãƒãƒƒãƒˆåˆ†ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚"
        selected: true
        title: LLM_è¬è¨­è¨ˆãƒ«ãƒ¼ãƒ—
        type: llm
        vision:
          enabled: false
      height: 88
      id: '1768603485259'
      position:
        x: 4012.7143112894146
        y: 302.04736200195606
      positionAbsolute:
        x: 4012.7143112894146
        y: 302.04736200195606
      selected: true
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        code: "import json\nimport re\n\ndef main(llm_output: str) -> dict:\n    json_match\
          \ = re.search(r'\\[[\\s\\S]*\\]', llm_output)\n    if json_match:\n    \
          \    try:\n            spots = json.loads(json_match.group())\n        \
          \    \n            # plot_keysã‚’åé›†\n            plot_keys = []\n        \
          \    spots_summary = \"\"\n            \n            for s in spots:\n \
          \               spot_id = s.get('spot_id', '')\n                spot_name\
          \ = s.get('spot_name', '')\n                plot_key = s.get('reward', {}).get('plot_key',\
          \ '')\n                puzzle_prompt = s.get('puzzle', {}).get('prompt',\
          \ '')\n                answer = s.get('puzzle', {}).get('answer', '')\n\
          \                \n                plot_keys.append(f\"{spot_id}: {plot_key}\"\
          )\n                spots_summary += f\"{spot_id} ({spot_name})\\n\"\n  \
          \              spots_summary += f\"  è¬: {puzzle_prompt}\\n\"\n         \
          \       spots_summary += f\"  ç­”ãˆ: {answer}\\n\"\n                spots_summary\
          \ += f\"  éµ: {plot_key}\\n\\n\"\n            \n            return {\n  \
          \              \"spot_scenes_json\": json.dumps(spots, ensure_ascii=False),\n\
          \                \"spot_scenes_count\": len(spots),\n                \"\
          plot_keys_text\": \"\\n\".join(plot_keys),\n                \"spots_summary\"\
          : spots_summary\n            }\n        except:\n            pass\n    \n\
          \    return {\n        \"spot_scenes_json\": \"[]\",\n        \"spot_scenes_count\"\
          : 0,\n        \"plot_keys_text\": \"ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ\",\n        \"spots_summary\"\
          : \"\"\n    }\n"
        code_language: python3
        outputs:
          plot_keys_text:
            children: null
            type: string
          spot_scenes_count:
            children: null
            type: number
          spot_scenes_json:
            children: null
            type: string
          spots_summary:
            children: null
            type: string
        selected: false
        title: CODE_è¬è¨­è¨ˆçµæœçµåˆ
        type: code
        variables:
        - value_selector:
          - '1768603485259'
          - text
          value_type: string
          variable: llm_output
      height: 52
      id: '1768603594197'
      position:
        x: 4314.714311289415
        y: 302.04736200195606
      positionAbsolute:
        x: 4314.714311289415
        y: 302.04736200195606
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        context:
          enabled: false
          variable_selector: []
        model:
          completion_params:
            max_output_tokens: 8192
            temperature: 0.3
            thinking_level: Low
          mode: chat
          name: gemini-3-flash-preview
          provider: langgenius/gemini/google
        prompt_template:
        - id: dafc3445-0350-4b98-9b93-3b4d78991d8b
          role: system
          text: 'ã‚ãªãŸã¯ã²ã‚‰ã‚ãå‹ãƒ‘ã‚ºãƒ«ã®è¬ä½œå®¶ã§ã™ã€‚

            å…¨ã‚¹ãƒãƒƒãƒˆã§é›†ã‚ãŸã€Œéµã€ã‚’ä½¿ã£ã¦è§£ãã€æ„Ÿå‹•ã®æœ€çµ‚è¬ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

            å‡ºåŠ›ã¯å¿…ãšJSONå½¢å¼ã§è¡Œã£ã¦ãã ã•ã„ã€‚'
        - id: e6d6a840-9132-41d3-8bad-82aecbb32abc
          role: user
          text: "ã“ã‚Œã¾ã§ã®ã‚¹ãƒãƒƒãƒˆã§é›†ã‚ãŸã€Œéµã€ã‚’å…¨ã¦ä½¿ã£ã¦è§£ãã€æœ€çµ‚è¬ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚\n\n\nã€é›†ã‚ãŸéµã€‘\n{{#1768603594197.plot_keys_text#}}\n\
            \n\nã€ç‰©èªã®çœŸç›¸ã€‘\n{{#1768602757091.final_reveal#}}\n\n\nã€ãƒ¡ã‚¿ãƒ‘ã‚ºãƒ«ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆã€‘\n{{#1768602505042.meta_puzzle_concept#}}\n\
            \n\nã€è¨­è¨ˆåŸå‰‡ã€‘\n1. å…¨ã¦ã®plot_keyã‚’ä½¿ã†ã“ã¨\n2. è§£ã‘ãŸæ™‚ã«ã€Œãã†ã„ã†ã“ã¨ã ã£ãŸã®ã‹ï¼ã€ã¨å…¨ä½“ãŒç¹‹ãŒã‚‹æ„Ÿè¦š\n3. è¬è‡ªä½“ã¯é›£ã—ã™ããªã„ï¼ˆéµã‚’ä¸¦ã¹ã‚Œã°è¦‹ãˆã¦ãã‚‹ï¼‰\n\
            4. çœŸç›¸ãŒæ•™è‚²çš„ä¾¡å€¤ã‚’æŒã¤ã“ã¨\n\n\nã€å‡ºåŠ›å½¢å¼ã€‘JSON\n{\n  \"meta_puzzle\": {\n    \"inputs\"\
            : [\"S1ã®éµ\", \"S2ã®éµ\", ...],\n    \"prompt\": \"æœ€çµ‚è¬ã®å‡ºé¡Œæ–‡ï¼ˆ50-100å­—ï¼‰\",\n\
            \    \"answer\": \"æœ€çµ‚çš„ãªç­”ãˆ\",\n    \"solution_steps\": [\n      \"ã‚¹ãƒ†ãƒƒãƒ—1\"\
            ,\n      \"ã‚¹ãƒ†ãƒƒãƒ—2\",\n      \"ã‚¹ãƒ†ãƒƒãƒ—3\"\n    ],\n    \"explanation\": \"\
            çœŸç›¸ã¨ã®æ¥ç¶šèª¬æ˜ï¼ˆ2-3æ–‡ï¼‰\"\n  }\n}"
        selected: false
        title: LLM_ãƒ¡ã‚¿ãƒ‘ã‚ºãƒ«ç”Ÿæˆ
        type: llm
        vision:
          enabled: false
      height: 88
      id: '1768603666915'
      position:
        x: 4618.539442266502
        y: 302.04736200195606
      positionAbsolute:
        x: 4618.539442266502
        y: 302.04736200195606
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        code: "import json\nimport re\n\ndef main(llm_output: str) -> dict:\n    json_match\
          \ = re.search(r'\\{[\\s\\S]*\\}', llm_output)\n    if json_match:\n    \
          \    try:\n            data = json.loads(json_match.group())\n         \
          \   meta = data.get(\"meta_puzzle\", data)\n            \n            return\
          \ {\n                \"meta_puzzle_json\": json.dumps(meta, ensure_ascii=False),\n\
          \                \"meta_prompt\": meta.get(\"prompt\", \"\"),\n        \
          \        \"meta_answer\": meta.get(\"answer\", \"\"),\n                \"\
          meta_explanation\": meta.get(\"explanation\", \"\")\n            }\n   \
          \     except:\n            pass\n    \n    return {\n        \"meta_puzzle_json\"\
          : \"{}\",\n        \"meta_prompt\": \"ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ\",\n        \"meta_answer\"\
          : \"\",\n        \"meta_explanation\": \"\"\n    }"
        code_language: python3
        outputs:
          meta_answer:
            children: null
            type: string
          meta_explanation:
            children: null
            type: string
          meta_prompt:
            children: null
            type: string
          meta_puzzle_json:
            children: null
            type: string
        selected: false
        title: CODE_ãƒ¡ã‚¿ãƒ‘ã‚ºãƒ«ç”Ÿæˆãƒ‘ãƒ¼ã‚¹
        type: code
        variables:
        - value_selector:
          - '1768603666915'
          - text
          value_type: string
          variable: llm_output
      height: 52
      id: '1768603767065'
      position:
        x: 4918.714311289415
        y: 302.04736200195606
      positionAbsolute:
        x: 4918.714311289415
        y: 302.04736200195606
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        code: "import json\n\ndef main(spot_scenes_json: str, meta_puzzle_json: str,\
          \ spot_count: int) -> dict:\n    errors = []\n    warnings = []\n    \n\
          \    try:\n        spots = json.loads(spot_scenes_json)\n        meta =\
          \ json.loads(meta_puzzle_json)\n    except:\n        return {\n        \
          \    \"validation_passed\": False,\n            \"errors_text\": \"JSONãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—\"\
          ,\n            \"warnings_text\": \"\",\n            \"quality_score\":\
          \ 0\n        }\n    \n    # ã‚¹ãƒãƒƒãƒˆæ•°ãƒã‚§ãƒƒã‚¯\n    if len(spots) < int(spot_count):\n\
          \        errors.append(f\"ã‚¹ãƒãƒƒãƒˆæ•°ãŒä¸è¶³: {len(spots)} / {spot_count}\")\n   \
          \ \n    # å„ã‚¹ãƒãƒƒãƒˆæ¤œè¨¼\n    for scene in spots:\n        spot_id = scene.get('spot_id',\
          \ 'unknown')\n        \n        # player_handoutãƒã‚§ãƒƒã‚¯\n        handout =\
          \ scene.get('lore_card', {}).get('player_handout', '')\n        if len(handout)\
          \ < 30:\n            warnings.append(f\"{spot_id}: player_handoutãŒçŸ­ã„\")\n\
          \        \n        # ç­”ãˆãƒã‚§ãƒƒã‚¯\n        answer = scene.get('puzzle', {}).get('answer',\
          \ '')\n        if not answer:\n            errors.append(f\"{spot_id}: ç­”ãˆãŒãªã„\"\
          )\n        \n        # plot_keyãƒã‚§ãƒƒã‚¯\n        plot_key = scene.get('reward',\
          \ {}).get('plot_key', '')\n        if not plot_key:\n            errors.append(f\"\
          {spot_id}: plot_keyãŒãªã„\")\n    \n    # ãƒ¡ã‚¿ãƒ‘ã‚ºãƒ«ãƒã‚§ãƒƒã‚¯\n    if not meta.get('answer'):\n\
          \        errors.append(\"ãƒ¡ã‚¿ãƒ‘ã‚ºãƒ«ã®ç­”ãˆãŒãªã„\")\n    \n    # ã‚¹ã‚³ã‚¢è¨ˆç®—\n    score =\
          \ 100 - (len(errors) * 20) - (len(warnings) * 5)\n    score = max(0, score)\n\
          \    \n    return {\n        \"validation_passed\": len(errors) == 0,\n\
          \        \"errors_text\": \"\\n\".join(errors) if errors else \"ãªã—\",\n\
          \        \"warnings_text\": \"\\n\".join(warnings) if warnings else \"ãªã—\"\
          ,\n        \"quality_score\": score\n    }"
        code_language: python3
        outputs:
          errors_text:
            children: null
            type: string
          quality_score:
            children: null
            type: number
          validation_passed:
            children: null
            type: boolean
          warnings_text:
            children: null
            type: string
        selected: false
        title: CODE_æ¤œè¨¼
        type: code
        variables:
        - value_selector:
          - '1768603594197'
          - spot_scenes_json
          value_type: string
          variable: spot_scenes_json
        - value_selector:
          - '1768603767065'
          - meta_puzzle_json
          value_type: string
          variable: meta_puzzle_json
        - value_selector:
          - '1768558472266'
          - spot_count
          value_type: number
          variable: spot_count
      height: 52
      id: '1768603843069'
      position:
        x: 5220.714311289415
        y: 302.04736200195606
      positionAbsolute:
        x: 5220.714311289415
        y: 302.04736200195606
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        context:
          enabled: false
          variable_selector: []
        model:
          completion_params:
            max_output_tokens: 8192
            temperature: 0.3
            thinking_level: Low
          mode: chat
          name: gemini-3-flash-preview
          provider: langgenius/gemini/google
        prompt_template:
        - id: 957b4dd1-bae4-4b16-bab2-8583c9e68797
          role: system
          text: 'ã‚ãªãŸã¯ã€Œãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒ"ã‚„ã£ã¦ã¿ãŸã„ï¼"ã¨æ€ãˆã‚‹ã€ã‚¯ã‚¨ã‚¹ãƒˆç´¹ä»‹æ–‡ã‚’ä½œã‚‹å°‚é–€å®¶ã§ã™ã€‚

            ãƒã‚¿ãƒãƒ¬ã¯çµ¶å¯¾ã«ç¦æ­¢ã§ã™ã€‚

            å‡ºåŠ›ã¯å¿…ãšJSONå½¢å¼ã§è¡Œã£ã¦ãã ã•ã„ã€‚'
        - id: 7e53383b-10a8-4410-9bd8-72d951a5c735
          role: user
          text: "ãƒã‚¿ãƒãƒ¬ãªã—ã®é­…åŠ›çš„ãªãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚\n\n\nã€é‡è¦ãƒ«ãƒ¼ãƒ«ï¼šãƒã‚¿ãƒãƒ¬ç¦æ­¢ã€‘\n- è¬ã®å•é¡Œæ–‡ãƒ»ç­”ãˆãƒ»ãƒ’ãƒ³ãƒˆã®å…·ä½“ã¯çµ¶å¯¾ã«æ›¸ã‹ãªã„\n\
            - ã€Œã©ã†è§£ãã‹ã€ã§ã¯ãªãã€Œä½•ãŒèµ·ãã‚‹ã‹ã€ã ã‘ã‚’æ›¸ã\n\n\nã€ç‰©èªã®å°å…¥ã€‘\n{{#1768602757091.premise#}}\n\
            \n\nã€ã‚¹ãƒãƒƒãƒˆæƒ…å ±ã€‘\n{{#1768603594197.spots_summary#}}\n\n\nã€ãƒ«ãƒ¼ãƒˆæƒ…å ±ã€‘\nç·è·é›¢: {{#1768602131448.total_distance_m#}}m\n\
            æ­©è¡Œæ™‚é–“: {{#1768602131448.walking_time_min#}}åˆ†\nã‚¹ãƒãƒƒãƒˆæ•°: {{#1768558472266.spot_count#}}ç®‡æ‰€\n\
            \n\nã€é›£æ˜“åº¦ã€‘\n{{#1768558472266.difficulty#}}\n\n\nã€å‡ºåŠ›å½¢å¼ã€‘JSON\n{\n  \"title\"\
            : \"ã‚¯ã‚¨ã‚¹ãƒˆã‚¿ã‚¤ãƒˆãƒ«ï¼ˆé­…åŠ›çš„ã«ï¼‰\",\n  \"one_liner\": \"30ã€œ45æ–‡å­—ã®ã‚­ãƒ£ãƒƒãƒã‚³ãƒ”ãƒ¼\",\n  \"trailer\"\
            : \"80ã€œ140æ–‡å­—ã®äºˆå‘Šæ–‡\",\n  \"mission\": \"ã‚ãªãŸã¯ã€‡ã€‡ã—ã¦æœ€å¾Œã«ã€‡ã€‡ã‚’çªãæ­¢ã‚ã‚‹\",\n  \"teasers\"\
            : [\n    \"ã‚¹ãƒãƒƒãƒˆåã§ã€‡ã€‡ã™ã‚‹ã¨â–³â–³ãŒè¦‹ãˆã¦ãã‚‹\",\n    \"åˆ¥ã®ã‚¹ãƒãƒƒãƒˆã§ã€‡ã€‡ã™ã‚‹ã¨â–³â–³ãŒèµ·ãã‚‹\",\n    \"\
            æœ€å¾Œã«ã€‡ã€‡ã™ã‚‹ã¨â–³â–³ãŒç¾ã‚Œã‚‹\"\n  ],\n  \"summary_actions\": [\"æ­©ã\", \"é›†ã‚ã‚‹\", \"ç…§åˆã™ã‚‹\"\
            ],\n  \"route_meta\": {\n    \"area_start\": \"é–‹å§‹ã‚¨ãƒªã‚¢å\",\n    \"area_end\"\
            : \"çµ‚äº†ã‚¨ãƒªã‚¢å\",\n    \"distance_km\": \"è·é›¢km\",\n    \"estimated_time_min\"\
            : \"æ‰€è¦æ™‚é–“\",\n    \"spots_count\": ã‚¹ãƒãƒƒãƒˆæ•°,\n    \"difficulty_label\": \"\
            é›£æ˜“åº¦ãƒ©ãƒ™ãƒ«\",\n    \"weather_note\": \"å¤©å€™ã®æ³¨æ„\"\n  },\n  \"tags\": [\"ã‚¿ã‚°1\"\
            , \"ã‚¿ã‚°2\", \"ã‚¿ã‚°3\"],\n  \"cta_copy\": {\n    \"primary\": \"å†’é™ºã‚’å§‹ã‚ã‚‹\",\n\
            \    \"secondary\": \"è©³ã—ãè¦‹ã‚‹\"\n  }\n}"
        selected: false
        title: LLM_ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆ
        type: llm
        vision:
          enabled: false
      height: 88
      id: '1768603963490'
      position:
        x: 5522.714311289415
        y: 302.04736200195606
      positionAbsolute:
        x: 5522.714311289415
        y: 302.04736200195606
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        code: "import json\nimport re\n\ndef main(llm_output: str) -> dict:\n    json_match\
          \ = re.search(r'\\{[\\s\\S]*\\}', llm_output)\n    if json_match:\n    \
          \    try:\n            preview = json.loads(json_match.group())\n      \
          \      return {\n                \"player_preview_json\": json.dumps(preview,\
          \ ensure_ascii=False),\n                \"quest_title\": preview.get(\"\
          title\", \"ç„¡é¡Œã®ã‚¯ã‚¨ã‚¹ãƒˆ\"),\n                \"one_liner\": preview.get(\"one_liner\"\
          , \"\"),\n                \"trailer\": preview.get(\"trailer\", \"\")\n\
          \            }\n        except:\n            pass\n    \n    return {\n\
          \        \"player_preview_json\": \"{}\",\n        \"quest_title\": \"ç„¡é¡Œã®ã‚¯ã‚¨ã‚¹ãƒˆ\"\
          ,\n        \"one_liner\": \"\",\n        \"trailer\": \"\"\n    }"
        code_language: python3
        outputs:
          one_liner:
            children: null
            type: string
          player_preview_json:
            children: null
            type: string
          quest_title:
            children: null
            type: string
          trailer:
            children: null
            type: string
        selected: false
        title: CODE_ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆãƒ‘ãƒ¼ã‚¹
        type: code
        variables:
        - value_selector:
          - '1768603963490'
          - text
          value_type: string
          variable: llm_output
      height: 52
      id: '1768604146459'
      position:
        x: 5824.714311289415
        y: 302.04736200195606
      positionAbsolute:
        x: 5824.714311289415
        y: 302.04736200195606
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        outputs:
        - value_selector:
          - '1768605957312'
          - output_json
          value_type: string
          variable: result
        selected: false
        title: å‡ºåŠ›
        type: end
      height: 88
      id: '1768604222640'
      position:
        x: 6452.952248502118
        y: 302.04736200195606
      positionAbsolute:
        x: 6452.952248502118
        y: 302.04736200195606
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        code: "import json\nfrom datetime import datetime\n\ndef main(\n    player_preview_json:\
          \ str,\n    quest_title: str,\n    premise: str,\n    goal: str,\n    mystery:\
          \ str,\n    final_reveal: str,\n    spot_scenes_json: str,\n    meta_puzzle_json:\
          \ str,\n    optimized_spots_json: str,\n    validation_passed: bool,\n \
          \   quality_score: int\n) -> dict:\n    \n    # JSONãƒ‘ãƒ¼ã‚¹\n    try:\n    \
          \    player_preview = json.loads(player_preview_json)\n        spot_scenes\
          \ = json.loads(spot_scenes_json)\n        meta_puzzle = json.loads(meta_puzzle_json)\n\
          \        optimized_spots = json.loads(optimized_spots_json)\n    except:\n\
          \        return {\n            \"output_json\": \"{}\",\n            \"\
          error\": \"JSONãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ\"\n        }\n    \n    # optimized_spotsã‚’è¤‡æ•°ã‚­ãƒ¼ã§ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŒ–\n    \
          spots_by_id = {}\n    spots_by_name = {}\n    for i, spot in enumerate(optimized_spots):\n        \
          sid = spot.get('spot_id', f'S{i+1}')\n        name = spot.get('name', '')\n        \
          spots_by_id[sid] = spot\n        if name:\n            spots_by_name[name] = spot\n    \n    # ã‚¹ãƒãƒƒãƒˆã‚·ãƒ¼ãƒ³ã«åº§æ¨™ã‚’è¿½åŠ ï¼ˆæ•°å€¤ã¨ã—ã¦ç¢ºä¿ï¼‰\n    \
          matched_count = 0\n    for scene in spot_scenes:\n        spot_id = scene.get('spot_id', '')\n        \
          spot_name = scene.get('spot_name', '')\n        matched_spot = None\n        \n        \
          # å„ªå…ˆé †ä½1: spot_idã§ãƒãƒƒãƒãƒ³ã‚°\n        if spot_id in spots_by_id:\n            \
          matched_spot = spots_by_id[spot_id]\n        # å„ªå…ˆé †ä½2: spot_nameã§ãƒãƒƒãƒãƒ³ã‚°\n        \
          elif spot_name in spots_by_name:\n            matched_spot = spots_by_name[spot_name]\n        \n        \
          if matched_spot:\n            matched_count += 1\n            lat = matched_spot.get('lat', 0)\n            \
          lng = matched_spot.get('lng', 0)\n            scene['lat'] = float(lat) if lat else 0.0\n            \
          scene['lng'] = float(lng) if lng else 0.0\n            scene['place_id'] = matched_spot.get('place_id', '')\n            \
          scene['address'] = matched_spot.get('address', '')\n        else:\n            \
          # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šåº§æ¨™ãŒãªã„å ´åˆã¯0ã‚’è¨­å®š\n            scene['lat'] = float(scene.get('lat', 0)) if scene.get('lat') else 0.0\n            \
          scene['lng'] = float(scene.get('lng', 0)) if scene.get('lng') else 0.0\n    \n    # creator_payloadæ§‹ç¯‰\n    creator_payload =\
          \ {\n        \"quest_id\": f\"quest-{int(datetime.now().timestamp())}\"\
          ,\n        \"quest_title\": quest_title,\n        \"main_plot\": {\n   \
          \         \"premise\": premise,\n            \"goal\": goal,\n         \
          \   \"antagonist_or_mystery\": mystery,\n            \"final_reveal_outline\"\
          : final_reveal\n        },\n        \"spots\": spot_scenes,\n        \"\
          meta_puzzle\": meta_puzzle,\n        \"generation_metadata\": {\n      \
          \      \"generated_at\": datetime.now().isoformat(),\n            \"pipeline_version\"\
          : \"2.2.0-dify\",\n            \"validation_passed\": validation_passed,\n\
          \            \"quality_score\": quality_score,\n            \"spots_count\": len(spot_scenes),\n\
          \            \"coords_matched\": matched_count,\n            \"coords_match_rate\": round(matched_count / len(spot_scenes) * 100, 1) if spot_scenes else 0\n\
          \        }\n    }\n    \n    # æœ€çµ‚å‡ºåŠ›\n    output = {\n        \"player_preview\": player_preview,\n\
          \        \"creator_payload\": creator_payload\n    }\n    \n    return {\n\
          \        \"output_json\": json.dumps(output, ensure_ascii=False, indent=2)\n\
          \    }"
        code_language: python3
        outputs:
          output_json:
            children: null
            type: string
        selected: false
        title: CODE_å‡ºåŠ›çµåˆ
        type: code
        variables:
        - value_selector:
          - '1768604146459'
          - player_preview_json
          value_type: string
          variable: player_preview_json
        - value_selector:
          - '1768604146459'
          - quest_title
          value_type: string
          variable: quest_title
        - value_selector:
          - '1768602757091'
          - premise
          value_type: string
          variable: premise
        - value_selector:
          - '1768602757091'
          - goal
          value_type: string
          variable: goal
        - value_selector:
          - '1768602757091'
          - mystery
          value_type: string
          variable: mystery
        - value_selector:
          - '1768602757091'
          - final_reveal
          value_type: string
          variable: final_reveal
        - value_selector:
          - '1768603594197'
          - spot_scenes_json
          value_type: string
          variable: spot_scenes_json
        - value_selector:
          - '1768603767065'
          - meta_puzzle_json
          value_type: string
          variable: meta_puzzle_json
        - value_selector:
          - '1768602131448'
          - optimized_spots_json
          value_type: string
          variable: optimized_spots_json
        - value_selector:
          - '1768603843069'
          - validation_passed
          value_type: boolean
          variable: validation_passed
        - value_selector:
          - '1768603843069'
          - quality_score
          value_type: number
          variable: quality_score
      height: 52
      id: '1768605957312'
      position:
        x: 6142.948042252686
        y: 302.04736200195606
      positionAbsolute:
        x: 6142.948042252686
        y: 302.04736200195606
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    viewport:
      x: -4332.174545427862
      y: 85.76988903914202
      zoom: 0.7361134310840899
  rag_pipeline_variables: []
