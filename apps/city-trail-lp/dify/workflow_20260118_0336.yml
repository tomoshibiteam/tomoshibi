app:
  description: ''
  icon: ğŸ¤–
  icon_background: '#FFEAD5'
  mode: workflow
  name: tomoshibi
  use_icon_as_answer_icon: false
dependencies:
- current_identifier: null
  type: marketplace
  value:
    marketplace_plugin_unique_identifier: langgenius/gemini:0.7.4@5faf411e694e0da130a337347a625a3812b1b7502a0183382d66d92c841bf05a
    version: null
kind: app
version: 0.5.0
workflow:
  conversation_variables: []
  environment_variables: []
  features:
    file_upload:
      allowed_file_extensions:
      - .JPG
      - .JPEG
      - .PNG
      - .GIF
      - .WEBP
      - .SVG
      allowed_file_types:
      - image
      allowed_file_upload_methods:
      - local_file
      - remote_url
      enabled: false
      fileUploadConfig:
        attachment_image_file_size_limit: 2
        audio_file_size_limit: 50
        batch_count_limit: 5
        file_size_limit: 15
        file_upload_limit: 20
        image_file_batch_limit: 10
        image_file_size_limit: 10
        single_chunk_attachment_limit: 10
        video_file_size_limit: 100
        workflow_file_upload_limit: 10
      image:
        enabled: false
        number_limits: 3
        transfer_methods:
        - local_file
        - remote_url
      number_limits: 3
    opening_statement: ''
    retriever_resource:
      enabled: true
    sensitive_word_avoidance:
      enabled: false
    speech_to_text:
      enabled: false
    suggested_questions: []
    suggested_questions_after_answer:
      enabled: false
    text_to_speech:
      enabled: false
      language: ''
      voice: ''
  graph:
    edges:
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: llm
        targetType: code
      id: 1768603963490-source-1768604146459-target
      source: '1768603963490'
      sourceHandle: source
      target: '1768604146459'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: code
        targetType: code
      id: 1768604146459-source-1768605957312-target
      source: '1768604146459'
      sourceHandle: source
      target: '1768605957312'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: code
        targetType: end
      id: 1768605957312-source-1768604222640-target
      source: '1768605957312'
      sourceHandle: source
      target: '1768604222640'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: start
        targetType: llm
      id: 1768558472266-source-1768597790579-target
      source: '1768558472266'
      sourceHandle: source
      target: '1768597790579'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: llm
        targetType: code
      id: 1768597790579-source-1768599287614-target
      source: '1768597790579'
      sourceHandle: source
      target: '1768599287614'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: code
        targetType: code
      id: 1768599287614-source-1768700000001-target
      source: '1768599287614'
      sourceHandle: source
      target: '1768700000001'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: code
        targetType: if-else
      id: 1768700000001-source-1768700000010-target
      source: '1768700000001'
      sourceHandle: source
      target: '1768700000010'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: if-else
        targetType: if-else
      id: 1768700000010-false-1768700000011-target
      source: '1768700000010'
      sourceHandle: 'false'
      target: '1768700000011'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: if-else
        targetType: knowledge-retrieval
      id: 1768700000010-true-1768700000002-target
      source: '1768700000010'
      sourceHandle: 'true'
      target: '1768700000002'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: if-else
        targetType: llm
      id: 1768700000011-false-1768599416646-target
      source: '1768700000011'
      sourceHandle: 'false'
      target: '1768599416646'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: if-else
        targetType: knowledge-retrieval
      id: 1768700000011-true-1768700000003-target
      source: '1768700000011'
      sourceHandle: 'true'
      target: '1768700000003'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: knowledge-retrieval
        targetType: if-else
      id: 1768700000002-source-1768700000011-target
      source: '1768700000002'
      sourceHandle: source
      target: '1768700000011'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: knowledge-retrieval
        targetType: llm
      id: 1768700000003-source-1768599416646-target
      source: '1768700000003'
      sourceHandle: source
      target: '1768599416646'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: llm
        targetType: http-request
      id: 1768599416646-source-1768600394819-target
      source: '1768599416646'
      sourceHandle: source
      target: '1768600394819'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: http-request
        targetType: code
      id: 1768600394819-source-1768601299799-target
      source: '1768600394819'
      sourceHandle: source
      target: '1768601299799'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: code
        targetType: llm
      id: 1768601299799-source-1768601846740-target
      source: '1768601299799'
      sourceHandle: source
      target: '1768601846740'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: llm
        targetType: code
      id: 1768601846740-source-1768602035766-target
      selected: false
      source: '1768601846740'
      sourceHandle: source
      target: '1768602035766'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: code
        targetType: code
      id: 1768602035766-source-1768602131448-target
      source: '1768602035766'
      sourceHandle: source
      target: '1768602131448'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: code
        targetType: llm
      id: 1768602131448-source-1768602371187-target
      source: '1768602131448'
      sourceHandle: source
      target: '1768602371187'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: llm
        targetType: code
      id: 1768602371187-source-1768602505042-target
      source: '1768602371187'
      sourceHandle: source
      target: '1768602505042'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: code
        targetType: llm
      id: 1768602505042-source-1768602602678-target
      source: '1768602505042'
      sourceHandle: source
      target: '1768602602678'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: llm
        targetType: code
      id: 1768602602678-source-1768602757091-target
      source: '1768602602678'
      sourceHandle: source
      target: '1768602757091'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: code
        targetType: llm
      id: 1768602757091-source-1768603485259-target
      source: '1768602757091'
      sourceHandle: source
      target: '1768603485259'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: llm
        targetType: code
      id: 1768603485259-source-1768603594197-target
      source: '1768603485259'
      sourceHandle: source
      target: '1768603594197'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: code
        targetType: llm
      id: 1768603594197-source-1768603666915-target
      source: '1768603594197'
      sourceHandle: source
      target: '1768603666915'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: llm
        targetType: code
      id: 1768603666915-source-1768603767065-target
      source: '1768603666915'
      sourceHandle: source
      target: '1768603767065'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: code
        targetType: code
      id: 1768603767065-source-1768603843069-target
      source: '1768603767065'
      sourceHandle: source
      target: '1768603843069'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: code
        targetType: llm
      id: 1768603843069-source-1768603963490-target
      source: '1768603843069'
      sourceHandle: source
      target: '1768603963490'
      targetHandle: target
      type: custom
      zIndex: 0
    nodes:
    - data:
        selected: false
        title: ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›
        type: start
        variables:
        - hint: ''
          label: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
          max_length: 2000
          options: []
          placeholder: ''
          required: true
          type: paragraph
          variable: prompt
        - default: medium
          hint: ''
          label: difficulty
          max_length: 48
          options:
          - easy
          - medium
          - hard
          placeholder: ''
          required: true
          type: select
          variable: difficulty
        - default: '7'
          hint: ''
          label: spot_count
          max_length: 48
          options: []
          placeholder: ''
          required: true
          type: number
          variable: spot_count
        - hint: ''
          label: theme_tags
          max_length: 256
          options: []
          placeholder: ''
          required: false
          type: text-input
          variable: theme_tags
        - hint: ''
          label: genre_support
          max_length: 100
          options: []
          placeholder: ''
          required: false
          type: text-input
          variable: genre_support
        - hint: ''
          label: tone_support
          max_length: 100
          options: []
          placeholder: ''
          required: false
          type: text-input
          variable: tone_support
        - hint: ''
          label: protagonist
          max_length: 200
          options: []
          placeholder: ''
          required: false
          type: text-input
          variable: protagonist
        - hint: ''
          label: objective
          max_length: 200
          options: []
          placeholder: ''
          required: false
          type: text-input
          variable: objective
        - hint: ''
          label: ending
          max_length: 200
          options: []
          placeholder: ''
          required: false
          type: text-input
          variable: ending
        - hint: ''
          label: when
          max_length: 100
          options: []
          placeholder: ''
          required: false
          type: text-input
          variable: when
        - hint: ''
          label: where
          max_length: 200
          options: []
          placeholder: ''
          required: false
          type: text-input
          variable: where
        - hint: ''
          label: purpose
          max_length: 200
          options: []
          placeholder: ''
          required: false
          type: text-input
          variable: purpose
        - hint: ''
          label: with_whom
          max_length: 100
          options: []
          placeholder: ''
          required: false
          type: text-input
          variable: with_whom
        - hint: ''
          label: center_lat
          max_length: 20
          options: []
          placeholder: ''
          required: false
          type: text-input
          variable: center_lat
        - hint: ''
          label: center_lng
          max_length: 20
          options: []
          placeholder: ''
          required: false
          type: text-input
          variable: center_lng
        - hint: ''
          label: radius_km
          max_length: 10
          options: []
          placeholder: ''
          required: false
          type: text-input
          variable: radius_km
        - default: 'false'
          hint: ç®¡ç†è€…æ¨©é™ãƒ•ãƒ©ã‚°ï¼ˆSPRæ¢åµäº‹å‹™æ‰€ã‚·ãƒªãƒ¼ã‚ºç”¨ï¼‰
          label: is_admin
          max_length: 10
          options:
          - 'true'
          - 'false'
          placeholder: ''
          required: false
          type: select
          variable: is_admin
      height: 525
      id: '1768558472266'
      position:
        x: 86.20166965207227
        y: 689.2243374673452
      positionAbsolute:
        x: 86.20166965207227
        y: 689.2243374673452
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        context:
          enabled: false
          variable_selector: []
        model:
          completion_params:
            max_output_tokens: 8192
            temperature: 0.3
            thinking_level: Low
          mode: chat
          name: gemini-3-flash-preview
          provider: langgenius/gemini/google
        prompt_template:
        - id: 0f5a1135-ce08-449f-b126-d96707e6967b
          role: system
          text: 'ã‚ãªãŸã¯å‘¨éŠå‹ä½“é¨“è¨­è¨ˆã®å°‚é–€å®¶ã§ã™ã€‚


            ã€åŒ—æ¥µæ˜Ÿã€‘è¡—ãŒä¸»å½¹ã€ç‰©èªãŒãƒ¬ãƒ³ã‚ºã€è¬ãŒå‹•æ©Ÿ

            - è¡—ï¼ˆå ´æ‰€ï¼‰ï¼ä¸»å½¹ã€‚è¦‹ä¸Šã’ã•ã›ã‚‹/æ­©ã‹ã›ã‚‹/æ°—ã¥ã‹ã›ã‚‹å¯¾è±¡

            - ç‰©èªï¼è¡—ã‚’è¦‹ã‚‹ãŸã‚ã®ãƒ¬ãƒ³ã‚ºã€‚æ„å‘³ã¥ã‘ã¨æ„Ÿæƒ…ã‚’ä»˜ä¸

            - è¬/ãƒŸãƒƒã‚·ãƒ§ãƒ³ï¼æ¬¡ã®å ´æ‰€ã¸å‹•ãå‹•æ©Ÿã€‚æ­©è¡Œã®æ¨é€²åŠ›


            ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚‰ã€Œæ­©ãä½“é¨“ã¨ã—ã¦ã®æœ¬è³ªã€ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚

            å‡ºåŠ›ã¯å¿…ãšJSONå½¢å¼ã§ã€‚'
        - id: 46db2956-1745-4cd3-aa4a-bcd7c8fb97ca
          role: user
          text: "ä»¥ä¸‹ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’åˆ†æã—ã€è¡—æ­©ãä½“é¨“ã¨ã—ã¦ã®è¨­è¨ˆè¦ç´ ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚\n\n\nã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆã€‘\nãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ:\
            \ {{#1768558472266.prompt#}}\né›£æ˜“åº¦: {{#1768558472266.difficulty#}}\nã‚¹ãƒãƒƒãƒˆæ•°:\
            \ {{#1768558472266.spot_count#}}\nã‚¸ãƒ£ãƒ³ãƒ«: {{#1768558472266.genre_support#}}\n\
            ãƒˆãƒ¼ãƒ³: {{#1768558472266.tone_support#}}\nã„ã¤: {{#1768558472266.when#}}\n\
            ã©ã“ã§: {{#1768558472266.where#}}\nç›®çš„: {{#1768558472266.purpose#}}\nèª°ã¨: {{#1768558472266.with_whom#}}\n\
            \n\nã€æŠ½å‡ºã™ã‚‹4ã¤ã®æ ¸å¿ƒè¦ç´ ï¼ˆä¼ãˆã‚‹ã¹ãã“ã¨ï¼‰ã€‘\n\n1. player_roleï¼ˆã‚ãªãŸã¯èª°ã¨ã—ã¦æ­©ãã‹ï¼‰\n   ä¾‹ï¼šè¡—ã®è¨˜æ†¶ã‚’å›åã™ã‚‹èª¿æŸ»å“¡ï¼å¤±ã‚ã‚ŒãŸæ‰‹ç´™ã‚’å±Šã‘ã‚‹é…é”äººï¼å°å°ã•ã‚ŒãŸè¬ã‚’è¿½ã†æ¢æ±‚è€…\n\
            \   â€»å…·ä½“çš„ã§æ²¡å…¥ã§ãã‚‹å½¹å‰²ã€‚ã€Œè¦³å…‰å®¢ã€ã¯é¿ã‘ã‚‹\n\n2. experience_promiseï¼ˆä½•ã‚’é”æˆã™ã‚‹ã¨æ°—æŒã¡ã„ã„ã‹ï¼‰\n \
            \  ä¾‹ï¼šæœ€å¾Œã«è¡—ã®è¦‹ãˆæ–¹ãŒå¤‰ã‚ã‚‹ï¼éš ã•ã‚ŒãŸç‰©èªãŒæ˜ã‚‰ã‹ã«ãªã‚‹ï¼æ•£ã‚‰ã°ã£ãŸæ–­ç‰‡ãŒ1ã¤ã«ç¹‹ãŒã‚‹\n   â€»ãƒã‚¿ãƒãƒ¬ã›ãšæœŸå¾…ã ã‘ç½®ãã€Œç´„æŸã€\n\
            \n3. atmosphere_toneï¼ˆã©ã‚“ãªç©ºæ°—ã®ç‰©èªã‹ï¼‰\n   é™ã‹/åˆ‡ãªã„/ãƒã‚¹ã‚¿ãƒ«ã‚¸ãƒƒã‚¯/ã‚¹ãƒªãƒªãƒ³ã‚°/è»½ã‚„ã‹/ãƒŸã‚¹ãƒ†ãƒªã‚¢ã‚¹/æ¸©ã‹ã„\
            \ ãªã©3ã¤ã¾ã§\n\n4. effort_expectationï¼ˆã©ã‚Œãã‚‰ã„ã®è² è·ã‹ï¼‰\n   - walking_intensity:\
            \ è»½ã‚/æ™®é€š/ã—ã£ã‹ã‚Š\n   - puzzle_difficulty: è¦³å¯Ÿãƒ¡ã‚¤ãƒ³/è€ƒå¯Ÿã‚‚å¿…è¦/æœ¬æ ¼è¬è§£ã\n   - time_estimate:\
            \ æ¨å®šæ‰€è¦æ™‚é–“ï¼ˆåˆ†ï¼‰\n\n\nã€è¿½åŠ ã®åˆ†æé …ç›®ã€‘\n- primary_themes: æ­´å²/ã‚¢ãƒ¼ãƒˆ/ã‚°ãƒ«ãƒ¡/è‡ªç„¶/å»ºç¯‰/æ–‡å­¦/ãƒŸã‚¹ãƒ†ãƒªãƒ¼\
            \ ã‹ã‚‰æœ€å¤§3ã¤\n- inferred_area: æ¨æ¸¬ã•ã‚Œã‚‹ã‚¨ãƒªã‚¢åï¼ˆåœ°åï¼‰\n- story_hook: ç‰©èªã®å°å…¥ãƒ•ãƒƒã‚¯ï¼ˆ30ç§’ã§æ´ã‚€ä¸€è¡Œï¼‰\n\
            - forbidden_elements: çµ¶å¯¾ã«é¿ã‘ã‚‹ã¹ãè¦ç´ \n\n\nã€å‡ºåŠ›å½¢å¼ã€‘JSON\n{\n  \"player_role\"\
            : \"ã‚ãªãŸã¯ã€‡ã€‡ã¨ã—ã¦æ­©ã\",\n  \"experience_promise\": \"æœ€å¾Œã«ã€‡ã€‡ãŒæ˜ã‚‰ã‹ã«ãªã‚‹\",\n  \"\
            atmosphere_tone\": [\"å½¢å®¹è©1\", \"å½¢å®¹è©2\", \"å½¢å®¹è©3\"],\n  \"effort_expectation\"\
            : {\n    \"walking_intensity\": \"æ™®é€š\",\n    \"puzzle_difficulty\": \"\
            è¦³å¯Ÿãƒ¡ã‚¤ãƒ³\",\n    \"time_estimate\": 90\n  },\n  \"primary_themes\": [\"ãƒ†ãƒ¼ãƒ1\"\
            , \"ãƒ†ãƒ¼ãƒ2\"],\n  \"inferred_area\": \"ã‚¨ãƒªã‚¢å\",\n  \"story_hook\": \"æ´ã¿ã®ä¸€è¡Œ\"\
            ,\n  \"forbidden_elements\": [\"é¿ã‘ã‚‹ã‚‚ã®\"]\n}"
        selected: false
        title: LLM_ãƒ¦ãƒ¼ã‚¶ãƒ¼æ„å›³åˆ†æ
        type: llm
        vision:
          enabled: false
      height: 88
      id: '1768597790579'
      position:
        x: 427.23059927736153
        y: 710.2243374673452
      positionAbsolute:
        x: 427.23059927736153
        y: 710.2243374673452
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        code: "import json\nimport re\n\ndef main(llm_output: str) -> dict:\n    json_match\
          \ = re.search(r'\\{[\\s\\S]*\\}', llm_output)\n    if json_match:\n    \
          \    try:\n            parsed = json.loads(json_match.group())\n       \
          \     effort = parsed.get('effort_expectation', {})\n            return\
          \ {\n                'player_role': parsed.get('player_role', 'ã‚ãªãŸã¯è¬ã‚’è¿½ã†æ¢æ±‚è€…ã¨ã—ã¦æ­©ã'),\n\
          \                'experience_promise': parsed.get('experience_promise',\
          \ 'æœ€å¾Œã«ã“ã®è¡—ã®è¦‹ãˆæ–¹ãŒå¤‰ã‚ã‚‹'),\n                'atmosphere_tone': ', '.join(parsed.get('atmosphere_tone',\
          \ ['ãƒŸã‚¹ãƒ†ãƒªã‚¢ã‚¹'])),\n                'walking_intensity': effort.get('walking_intensity',\
          \ 'æ™®é€š'),\n                'puzzle_difficulty': effort.get('puzzle_difficulty',\
          \ 'è¦³å¯Ÿãƒ¡ã‚¤ãƒ³'),\n                'time_estimate': str(effort.get('time_estimate',\
          \ 90)),\n                'primary_themes': ', '.join(parsed.get('primary_themes',\
          \ ['æ­´å²'])),\n                'inferred_area': parsed.get('inferred_area',\
          \ ''),\n                'story_hook': parsed.get('story_hook', ''),\n  \
          \              'forbidden_elements': ', '.join(parsed.get('forbidden_elements',\
          \ []))\n            }\n        except:\n            pass\n    return {\n\
          \        'player_role': 'ã‚ãªãŸã¯è¬ã‚’è¿½ã†æ¢æ±‚è€…ã¨ã—ã¦æ­©ã',\n        'experience_promise':\
          \ 'æœ€å¾Œã«ã“ã®è¡—ã®è¦‹ãˆæ–¹ãŒå¤‰ã‚ã‚‹',\n        'atmosphere_tone': 'ãƒŸã‚¹ãƒ†ãƒªã‚¢ã‚¹',\n        'walking_intensity':\
          \ 'æ™®é€š',\n        'puzzle_difficulty': 'è¦³å¯Ÿãƒ¡ã‚¤ãƒ³',\n        'time_estimate':\
          \ '90',\n        'primary_themes': 'æ­´å²',\n        'inferred_area': '',\n\
          \        'story_hook': '',\n        'forbidden_elements': ''\n    }"
        code_language: python3
        outputs:
          atmosphere_tone:
            children: null
            type: string
          experience_promise:
            children: null
            type: string
          forbidden_elements:
            children: null
            type: string
          inferred_area:
            children: null
            type: string
          player_role:
            children: null
            type: string
          primary_themes:
            children: null
            type: string
          puzzle_difficulty:
            children: null
            type: string
          story_hook:
            children: null
            type: string
          time_estimate:
            children: null
            type: string
          walking_intensity:
            children: null
            type: string
        selected: false
        title: code_æ„å›³è§£æçµæœãƒ‘ãƒ¼ã‚¹
        type: code
        variables:
        - value_selector:
          - '1768597790579'
          - text
          value_type: string
          variable: llm_output
      height: 52
      id: '1768599287614'
      position:
        x: 779.7267199534922
        y: 710.2243374673452
      positionAbsolute:
        x: 779.7267199534922
        y: 710.2243374673452
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        code: "import re\n\ndef main(prompt: str, is_admin: str, inferred_area: str)\
          \ -> dict:\n    # SPRæ¢åµäº‹å‹™æ‰€ã‚·ãƒªãƒ¼ã‚ºåˆ¤å®š\n    is_spr = False\n    if is_admin ==\
          \ 'true':\n        spr_keywords = ['SPR', 'spr', 'SPRæ¢åµ', 'SPRæ¢åµäº‹å‹™æ‰€', 'ã‚¨ã‚¹ãƒ”ãƒ¼ã‚¢ãƒ¼ãƒ«']\n\
          \        for kw in spr_keywords:\n            if kw in prompt:\n       \
          \         is_spr = True\n                break\n    \n    # ä¼Šéƒ½ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹åˆ¤å®š\n   \
          \ ito_keywords = ['ä¼Šéƒ½ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹', 'ä¼Šéƒ½', 'ä¹å¤§ä¼Šéƒ½', 'ä¹å·å¤§å­¦ä¼Šéƒ½', 'Ito Campus', 'ito campus', 'ç³¸å³¶', 'å…ƒå²¡']\n\
          \    is_ito = False\n\
          \    check_text = prompt + ' ' + inferred_area\n    for kw in ito_keywords:\n        if kw in check_text:\n            is_ito\
          \ = True\n            break\n    \n    return {\n        'is_spr': 'true'\
          \ if is_spr else 'false',\n        'is_ito': 'true' if is_ito else\
          \ 'false',\n        'spr_context': 'SPRæ¢åµäº‹å‹™æ‰€ã‚·ãƒªãƒ¼ã‚ºç”¨ã®ãƒŠãƒ¬ãƒƒã‚¸æ¤œç´¢çµæœãŒã“ã“ã«å…¥ã‚Šã¾ã™' if is_spr\
          \ else '',\n        'ito_context': 'ä¼Šéƒ½ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ã®è©³ç´°æƒ…å ±ãŒã“ã“ã«å…¥ã‚Šã¾ã™' if is_ito else\
          \ ''\n    }\n"
        code_language: python3
        outputs:
          is_ito:
            children: null
            type: string
          is_spr:
            children: null
            type: string
          ito_context:
            children: null
            type: string
          spr_context:
            children: null
            type: string
        selected: false
        title: CODE_æ¡ä»¶åˆ¤å®š
        type: code
        variables:
        - value_selector:
          - '1768558472266'
          - prompt
          value_type: string
          variable: prompt
        - value_selector:
          - '1768558472266'
          - is_admin
          value_type: string
          variable: is_admin
        - value_selector:
          - '1768599287614'
          - inferred_area
          value_type: string
          variable: inferred_area
      height: 52
      id: '1768700000001'
      position:
        x: 1107.184734113128
        y: 710.2243374673452
      positionAbsolute:
        x: 1107.184734113128
        y: 710.2243374673452
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        dataset_ids: []
        multiple_retrieval_config:
          reranking_enable: true
          reranking_mode: weighted_score
          top_k: 5
          weights:
            keyword_setting:
              keyword_weight: 0.3
            vector_setting:
              embedding_model_name: text-embedding-3-small
              embedding_provider_name: openai
              vector_weight: 0.7
        query_attachment_selector: []
        query_variable_selector:
        - '1768558472266'
        - prompt
        retrieval_mode: multiple
        selected: false
        title: Knowledge_SPRæ¢åµäº‹å‹™æ‰€
        type: knowledge-retrieval
      height: 52
      id: '1768700000002'
      position:
        x: 1781.5781068041138
        y: 710.2243374673452
      positionAbsolute:
        x: 1781.5781068041138
        y: 710.2243374673452
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        dataset_ids: []
        multiple_retrieval_config:
          reranking_enable: true
          reranking_mode: weighted_score
          top_k: 10
          weights:
            keyword_setting:
              keyword_weight: 0.3
            vector_setting:
              embedding_model_name: text-embedding-3-small
              embedding_provider_name: openai
              vector_weight: 0.7
        query_attachment_selector: []
        query_variable_selector:
        - '1768599287614'
        - inferred_area
        retrieval_mode: multiple
        selected: false
        title: Knowledge_ä¼Šéƒ½ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹
        type: knowledge-retrieval
      height: 52
      id: '1768700000003'
      position:
        x: 2468.4759873404823
        y: 785.0329201554958
      positionAbsolute:
        x: 2468.4759873404823
        y: 785.0329201554958
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        cases:
        - case_id: 'true'
          conditions:
          - comparison_operator: is
            id: spr_check
            value: 'true'
            varType: string
            variable_selector:
            - '1768700000001'
            - is_spr
          id: 'true'
          logical_operator: and
        selected: false
        title: IF_SPRåˆ¤å®š
        type: if-else
      height: 124
      id: '1768700000010'
      position:
        x: 1441.225412916363
        y: 710.2243374673452
      positionAbsolute:
        x: 1441.225412916363
        y: 710.2243374673452
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        cases:
        - case_id: 'true'
          conditions:
          - comparison_operator: is
            id: ito_check
            value: 'true'
            varType: string
            variable_selector:
            - '1768700000001'
            - is_ito
          id: 'true'
          logical_operator: and
        selected: false
        title: IF_ä¼Šéƒ½ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹åˆ¤å®š
        type: if-else
      height: 124
      id: '1768700000011'
      position:
        x: 2122.4269213679954
        y: 790.2331715641016
      positionAbsolute:
        x: 2122.4269213679954
        y: 790.2331715641016
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        context:
          enabled: false
          variable_selector: []
        model:
          completion_params:
            max_output_tokens: 8192
            temperature: 0.3
            thinking_level: Low
          mode: chat
          name: gemini-3-flash-preview
          provider: langgenius/gemini/google
        prompt_template:
        - id: 72c5350b-9813-4e99-a96c-81edf38a45ee
          role: system
          text: 'ã‚ãªãŸã¯æ—¥æœ¬ã®åœ°ç†ã¨æ­´å²ã«è©³ã—ã„å°‚é–€å®¶ã§ã™ã€‚

            æŒ‡å®šã•ã‚ŒãŸã‚¨ãƒªã‚¢ã«ã¤ã„ã¦ã€è¡—æ­©ãã‚¯ã‚¨ã‚¹ãƒˆã«å½¹ç«‹ã¤æƒ…å ±ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚

            å‡ºåŠ›ã¯å¿…ãšJSONå½¢å¼ã§è¡Œã£ã¦ãã ã•ã„ã€‚'
        - id: 780f826a-e979-4a5d-88b4-e1dbf7433398
          role: user
          text: "ä»¥ä¸‹ã®ã‚¨ãƒªã‚¢ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚\n\n\nã€ã‚¨ãƒªã‚¢æƒ…å ±ã€‘\næ¨æ¸¬ã‚¨ãƒªã‚¢å: {{#1768599287614.inferred_area#}}\n\
            å…¥åŠ›ã•ã‚ŒãŸå ´æ‰€: {{#1768558472266.where#}}\nãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: {{#1768558472266.prompt#}}\n\
            ä¸­å¿ƒåº§æ¨™: ç·¯åº¦{{#1768558472266.center_lat#}}, çµŒåº¦{{#1768558472266.center_lng#}}\n\
            æ¤œç´¢åŠå¾„: {{#1768558472266.radius_km#}}km\næ±‚ã‚ã‚‰ã‚Œã‚‹ãƒ†ãƒ¼ãƒ: {{#1768599287614.primary_themes#}}\n\
            \n\nã€åˆ†æé …ç›®ã€‘\n1. area_name: æ­£å¼ãªã‚¨ãƒªã‚¢å\n2. area_history: æ­´å²çš„èƒŒæ™¯ï¼ˆ100-200å­—ï¼‰\n\
            3. cultural_significance: æ–‡åŒ–çš„ãªé‡è¦æ€§\n4. typical_spots: å…¸å‹çš„ãªã‚¹ãƒãƒƒãƒˆã‚¿ã‚¤ãƒ—\n5. hidden_gems:\
            \ ç©´å ´çš„è¦ç´ \n6. walking_characteristics: æ­©è¡Œã®ç‰¹å¾´\n7. local_stories: ä¼èª¬ã‚„é€¸è©±\n\
            8. connection_points: ã‚¹ãƒãƒƒãƒˆã‚’ç¹‹ããƒ†ãƒ¼ãƒ\n\n\nã€å‡ºåŠ›å½¢å¼ã€‘JSON\n{\n  \"area_name\":\
            \ \"string\",\n  \"area_history\": \"string\",\n  \"cultural_significance\"\
            : \"string\",\n  \"typical_spots\": [\"string\"],\n  \"hidden_gems\":\
            \ [\"string\"],\n  \"walking_characteristics\": \"string\",\n  \"local_stories\"\
            : [\"string\"],\n  \"connection_points\": [\"string\"]\n}"
        selected: false
        title: LLM_ã‚¨ãƒªã‚¢ç‰¹æ€§åˆ†æ
        type: llm
        vision:
          enabled: false
      height: 88
      id: '1768599416646'
      position:
        x: 2819.8448270452245
        y: 870.1287196084256
      positionAbsolute:
        x: 2819.8448270452245
        y: 870.1287196084256
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        authorization:
          config: null
          type: no-auth
        body:
          data: []
          type: none
        headers: ''
        method: get
        params: 'query:{{#1768599287614.inferred_area#}} è¦³å…‰ã‚¹ãƒãƒƒãƒˆ

          type:tourist_attraction

          language:ja

          key:AIzaSyBdjMNtxtVjl2rivvMSkBnhqMGJAeLYwGQ'
        retry_config:
          max_retries: 3
          retry_enabled: true
          retry_interval: 100
        selected: false
        ssl_verify: true
        timeout:
          connect: 10
          max_connect_timeout: 0
          max_read_timeout: 0
          max_write_timeout: 0
          read: 10
          write: 10
        title: HTTP_å®Ÿåœ¨ã‚¹ãƒãƒƒãƒˆæ¤œç´¢
        type: http-request
        url: https://maps.googleapis.com/maps/api/place/textsearch/json
        variables: []
      height: 137
      id: '1768600394819'
      position:
        x: 3167.2023468636507
        y: 870.1287196084256
      positionAbsolute:
        x: 3167.2023468636507
        y: 870.1287196084256
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        code: "import json\nfrom urllib.parse import quote\n\ndef main(body: str)\
          \ -> dict:\n    data = json.loads(body)\n    spots = []\n    \n    for i,\
          \ result in enumerate(data.get(\"results\", [])):\n        name = result.get(\"\
          name\", \"\")\n        lat = result.get(\"geometry\", {}).get(\"location\"\
          , {}).get(\"lat\", 0)\n        lng = result.get(\"geometry\", {}).get(\"\
          location\", {}).get(\"lng\", 0)\n        place_id = result.get(\"place_id\"\
          , \"\")\n        \n        # textsearchã¯formatted_addressã€nearbysearchã¯vicinity\n\
          \        address = result.get(\"formatted_address\", result.get(\"vicinity\"\
          , \"\"))\n        \n        # Google Maps URLã‚’ç”Ÿæˆ\n        if place_id:\n\
          \            google_maps_url = f'https://www.google.com/maps/search/?api=1&query={quote(name)}&query_place_id={place_id}'\n\
          \        else:\n            google_maps_url = f'https://www.google.com/maps/search/?api=1&query={lat},{lng}'\n\
          \        \n        spot = {\n            \"spot_id\": f\"S{i+1}\",\n   \
          \         \"name\": name,\n            \"lat\": float(lat),\n          \
          \  \"lng\": float(lng),\n            \"place_id\": place_id,\n         \
          \   \"rating\": result.get(\"rating\", 0),\n            \"reviews\": result.get(\"\
          user_ratings_total\", 0),\n            \"types\": \", \".join(result.get(\"\
          types\", [])),\n            \"address\": address,\n            \"google_maps_url\"\
          : google_maps_url\n        }\n        spots.append(spot)\n    \n    # ã‚¹ãƒãƒƒãƒˆã®æƒ…å ±ã‚’å€‹åˆ¥å¤‰æ•°ã¨ã—ã¦å‡ºåŠ›ï¼ˆåº§æ¨™ä»˜ãï¼‰\n\
          \    spots_summary = \"\"\n    for s in spots:\n        spots_summary +=\
          \ f\"{s['spot_id']}: {s['name']}\\n\"\n        spots_summary += f\"  ä½æ‰€:\
          \ {s['address']}\\n\"\n        spots_summary += f\"  åº§æ¨™: {s['lat']}, {s['lng']}\\\
          n\"\n        spots_summary += f\"  place_id: {s['place_id']}\\n\"\n    \
          \    spots_summary += f\"  è©•ä¾¡: {s['rating']} ({s['reviews']}ä»¶)\\n\\n\"\n\
          \    \n    return {\n        \"spots_json\": json.dumps(spots, ensure_ascii=False),\n\
          \        \"spots_count\": len(spots),\n        \"spots_summary\": spots_summary\n\
          \    }"
        code_language: python3
        outputs:
          spots_count:
            children: null
            type: number
          spots_json:
            children: null
            type: string
          spots_summary:
            children: null
            type: string
        selected: false
        title: CODE_å®Ÿåœ¨ã‚¹ãƒãƒƒãƒˆæ¤œç´¢ãƒ‘ãƒ¼ã‚¹
        type: code
        variables:
        - value_selector:
          - '1768600394819'
          - body
          value_type: string
          variable: body
      height: 52
      id: '1768601299799'
      position:
        x: 3519.1740524432817
        y: 870.1287196084256
      positionAbsolute:
        x: 3519.1740524432817
        y: 870.1287196084256
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        context:
          enabled: false
          variable_selector: []
        model:
          completion_params:
            max_output_tokens: 8192
            temperature: 0.3
            thinking_level: Low
          mode: chat
          name: gemini-3-flash-preview
          provider: langgenius/gemini/google
        prompt_template:
        - id: 9056441e-e9cf-4194-a354-32cb56ec70fa
          role: system
          text: 'ã‚ãªãŸã¯å‘¨éŠå‹ã‚¯ã‚¨ã‚¹ãƒˆã®ã‚¹ãƒãƒƒãƒˆé¸å®šå°‚é–€å®¶ã§ã™ã€‚


            ã€åŒ—æ¥µæ˜Ÿã€‘è¡—ãŒä¸»å½¹ã€ç‰©èªãŒãƒ¬ãƒ³ã‚ºã€è¬ãŒå‹•æ©Ÿ


            ã€ã‚¹ãƒãƒƒãƒˆé¸å®šã®7æ¡ä»¶ï¼ˆå¼·ã„ã‚¹ãƒãƒƒãƒˆã®æ¡ä»¶ï¼‰ã€‘

            1. åŒå®šæ€§ï¼šä¸€ç›®ã§ã€Œã“ã“ã ã€ã¨åˆ†ã‹ã‚‹

            2. å®‰å…¨æ€§ï¼šåˆ°é”ã—ã‚„ã™ãå±é™ºãŒå°‘ãªã„

            3. ç‰©èªå¿…ç„¶æ€§ï¼šãã“ã«è¡Œãç†ç”±ãŒä½œã‚Œã‚‹

            4. è¦³å¯Ÿç´ æï¼šè¦‹ã‚‹ã¹ããƒ‡ã‚£ãƒ†ãƒ¼ãƒ«ãŒã‚ã‚‹ï¼ˆç´‹ç« /æ•°/éŠ˜æ¿/å½¢çŠ¶/æ–¹è§’ï¼‰

            5. æ™‚é–“å¸¯è€æ€§ï¼šå¤œ/é›¨/é–‰é¤¨ã§ã‚‚æˆç«‹ã™ã‚‹

            6. æ»åœ¨æ€§ï¼šç«‹ã¡æ­¢ã¾ã‚Œã‚‹/æ··é›‘ã§è©°ã¾ã‚‰ãªã„

            7. é€£ç¶šæ€§ï¼šæ¬¡ã¸ã®ç§»å‹•ãŒæ°—æŒã¡ã„ã„


            å‡ºåŠ›ã¯å¿…ãšJSONå½¢å¼ã§ã€‚'
        - id: 3739734d-7858-49c7-bfc2-7f6e8908a2e5
          role: user
          text: "ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å½¹å‰²ã€‘\n{{#1768599287614.player_role#}}\n\nã€ä½“é¨“ã®ç´„æŸã€‘\n{{#1768599287614.experience_promise#}}\n\
            \nã€é›°å›²æ°—ã€‘\n{{#1768599287614.atmosphere_tone#}}\n\nã€ãƒ†ãƒ¼ãƒã€‘\n{{#1768599287614.primary_themes#}}\n\
            \nã€ã‚¨ãƒªã‚¢æƒ…å ±ã€‘\n{{#1768599416646.text#}}\n\nã€ã‚¹ãƒãƒƒãƒˆå€™è£œã€‘\n{{#1768601299799.spots_summary#}}\n\
            \nã€å¿…è¦ãªã‚¹ãƒãƒƒãƒˆæ•°ã€‘\n{{#1768558472266.spot_count#}}ä»¶\n\n\nã€ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°åŸºæº–ï¼ˆå„0-100ç‚¹ï¼‰ã€‘\n\
            \n1. observation_materialï¼ˆè¦³å¯Ÿç´ æï¼‰\n   ç¾åœ°ã§è¦‹ã¦ç™ºè¦‹ã§ãã‚‹ã‚‚ã®ãŒã‚ã‚‹ã‹ï¼Ÿ\n   - ç´‹ç« /åˆ»å°/éŠ˜æ¿/ç¢‘æ–‡\n\
            \   - æ•°ãˆã‚‰ã‚Œã‚‹ã‚‚ã®ï¼ˆæŸ±/çŸ³æ®µ/ç¯ç± ï¼‰\n   - æ–¹è§’/é…ç½®/å½¢çŠ¶ã®ç‰¹å¾´\n   - 100ç‚¹ï¼è¦‹ã‚‹ã¹ãå…·ä½“çš„ãƒ‡ã‚£ãƒ†ãƒ¼ãƒ«ãŒè¤‡æ•°ã‚ã‚‹\n\
            \n2. heads_up_potentialï¼ˆãƒ˜ãƒƒã‚ºã‚¢ãƒƒãƒ—åº¦ï¼‰\n   ã‚¹ãƒãƒ›ã‚’è¦‹ãšã«æ¥½ã—ã‚ã‚‹ã‹ï¼Ÿ\n   - ã€Œæ­£é¢ã®â—‹â—‹ã‚’è¦‹ã¦ã€ã¨è¨€ãˆã‚‹æ˜ç¢ºãªå¯¾è±¡ãŒã‚ã‚‹ã‹\n\
            \   - è¦‹ä¸Šã’ã‚‹/è¦‹æ¸¡ã™/æ¢ã™å‹•ä½œãŒè‡ªç„¶ã«ã§ãã‚‹ã‹\n   - 100ç‚¹ï¼å®Œå…¨ã«ç¾åœ°ã‚’è¦‹ã¦ä½“é¨“ã§ãã‚‹\n\n3. story_anchorï¼ˆç‰©èªã‚¢ãƒ³ã‚«ãƒ¼åº¦ï¼‰\n\
            \   ç‰©èªä¸Šã®å½¹å‰²ã‚’1ã¤æ˜ç¢ºã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã‚‹ã‹ï¼Ÿ\n   å½¹å‰²ä¾‹ï¼šè¨¼æ‹ ç™ºè¦‹/ç›®æ’ƒåœ°ç‚¹/æš—å·éš åŒ¿/è¨˜æ†¶ã®æºã‚‰ã/å˜˜ã®éœ²å‘ˆ/çœŸå®Ÿã®ç¢ºèª\n \
            \  - 100ç‚¹ï¼ç‰©èªä¸Šã®å¿…ç„¶ãŒã‚ã‚‹\n\n4. walkabilityï¼ˆãƒ«ãƒ¼ãƒˆé©æ€§ï¼‰\n   ä½ç½®é–¢ä¿‚/ã‚¢ã‚¯ã‚»ã‚¹/å®‰å…¨æ€§\n   - 100ç‚¹ï¼è¿·ã„ã«ããå®‰å…¨ã§æ°—æŒã¡ã„ã„å‹•ç·š\n\
            \n5. resilienceï¼ˆæ™‚é–“å¸¯è€æ€§ï¼‰\n   å¤œ/é›¨/æ··é›‘/é–‰é¤¨ã§ã‚‚æˆç«‹ã™ã‚‹ã‹ï¼Ÿ\n   - 100ç‚¹ï¼ã„ã¤è¡Œã£ã¦ã‚‚æˆç«‹ã™ã‚‹\n\n\
            \nã€å„ã‚¹ãƒãƒƒãƒˆã«å¿…ãšå«ã‚ã‚‹ã‚‚ã®ã€‘\n- look_at_directionï¼šã€Œâ—‹â—‹ã®æ–¹ã‚’è¦‹ã¦ã€ï¼ˆè¦‹ã‚‹ã¹ãå…·ä½“çš„æ–¹å‘ï¼‰\n- observable_detailsï¼šç¾åœ°ã§ç¢ºèªã§ãã‚‹å…·ä½“çš„ãƒ‡ã‚£ãƒ†ãƒ¼ãƒ«ï¼ˆ3ã¤ä»¥ä¸Šï¼‰\n\
            - story_role_candidateï¼šã“ã®ã‚¹ãƒãƒƒãƒˆã«é©ã—ãŸç‰©èªä¸Šã®å½¹å‰²ï¼ˆ1ã¤ï¼‰\n\n\nã€å‡ºåŠ›å½¢å¼ã€‘JSONé…åˆ—ï¼ˆå¿…è¦æ•°+äºˆå‚™3ä»¶ï¼‰\n\
            [\n  {\n    \"name\": \"ã‚¹ãƒãƒƒãƒˆå\",\n    \"lat\": ç·¯åº¦,\n    \"lng\": çµŒåº¦,\n\
            \    \"place_id\": \"place_id\",\n    \"address\": \"ä½æ‰€\",\n    \"observation_material\"\
            : ç‚¹æ•°,\n    \"heads_up_potential\": ç‚¹æ•°,\n    \"story_anchor\": ç‚¹æ•°,\n  \
            \  \"walkability\": ç‚¹æ•°,\n    \"resilience\": ç‚¹æ•°,\n    \"total\": åˆè¨ˆç‚¹,\n\
            \    \"look_at_direction\": \"æ­£é¢ã®çŸ³ç¢‘ã®ä¸Šéƒ¨ã«æ³¨ç›®\",\n    \"observable_details\"\
            : [\"å±‹æ ¹ã®å½¢çŠ¶\", \"æŸ±ã®æœ¬æ•°\", \"å…¥å£ã®ç´‹ç« \"],\n    \"story_role_candidate\": \"\
            è¨¼æ‹ ç™ºè¦‹åœ°ç‚¹\",\n    \"selection_reason\": \"é¸ã‚“ã ç†ç”±ï¼ˆ1æ–‡ï¼‰\"\n  }\n]\n\ntotalãŒé«˜ã„é †ã«ä¸¦ã¹ã¦ãã ã•ã„ã€‚"
        selected: false
        title: LLM_ãƒ†ãƒ¼ãƒã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°
        type: llm
        vision:
          enabled: false
      height: 88
      id: '1768601846740'
      position:
        x: 3865.9692308779363
        y: 870.1287196084256
      positionAbsolute:
        x: 3865.9692308779363
        y: 870.1287196084256
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        code: "import json\nimport re\n\ndef main(llm_output: str) -> dict:\n    #\
          \ JSONéƒ¨åˆ†ã‚’æŠ½å‡º\n    json_match = re.search(r'\\[[\\s\\S]*\\]', llm_output)\n\
          \    if json_match:\n        try:\n            spots = json.loads(json_match.group())\n\
          \            \n            # ã‚¹ãƒãƒƒãƒˆä¸€è¦§ã‚’ãƒ†ã‚­ã‚¹ãƒˆåŒ–\n            spots_text = \"\"\
          \n            for i, s in enumerate(spots):\n                spots_text\
          \ += f\"{i+1}. {s.get('name', '')} (ã‚¹ã‚³ã‚¢: {s.get('total', 0)})\\n\"\n   \
          \         \n            return {\n                \"scored_spots_json\"\
          : json.dumps(spots, ensure_ascii=False),\n                \"scored_spots_count\"\
          : len(spots),\n                \"scored_spots_text\": spots_text\n     \
          \       }\n        except:\n            pass\n    \n    return {\n     \
          \   \"scored_spots_json\": \"[]\",\n        \"scored_spots_count\": 0,\n\
          \        \"scored_spots_text\": \"ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ\"\n    }"
        code_language: python3
        outputs:
          scored_spots_count:
            children: null
            type: number
          scored_spots_json:
            children: null
            type: string
          scored_spots_text:
            children: null
            type: string
        selected: false
        title: CODE_ãƒ†ãƒ¼ãƒã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ãƒ‘ãƒ¼ã‚¹
        type: code
        variables:
        - value_selector:
          - '1768601846740'
          - text
          value_type: string
          variable: llm_output
      height: 52
      id: '1768602035766'
      position:
        x: 2200.7143112894146
        y: 302.04736200195606
      positionAbsolute:
        x: 2200.7143112894146
        y: 302.04736200195606
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        code: "import json\nimport math\n\n# ============= è·é›¢è¨ˆç®— =============\ndef\
          \ haversine_distance(lat1, lng1, lat2, lng2):\n    R = 6371000\n    phi1,\
          \ phi2 = math.radians(float(lat1)), math.radians(float(lat2))\n    delta_phi\
          \ = math.radians(float(lat2) - float(lat1))\n    delta_lambda = math.radians(float(lng2)\
          \ - float(lng1))\n    a = math.sin(delta_phi/2)**2 + math.cos(phi1) * math.cos(phi2)\
          \ * math.sin(delta_lambda/2)**2\n    return R * 2 * math.atan2(math.sqrt(a),\
          \ math.sqrt(1-a))\n\ndef calculate_total_distance(route):\n    total = 0\n\
          \    for i in range(1, len(route)):\n        total += haversine_distance(\n\
          \            route[i-1].get('lat', 0), route[i-1].get('lng', 0),\n     \
          \       route[i].get('lat', 0), route[i].get('lng', 0)\n        )\n    return\
          \ total\n\n# ============= ãƒ¡ã‚¤ãƒ³é–¢æ•° =============\ndef main(scored_spots_json,\
          \ spot_count, center_lat, center_lng):\n    spots = json.loads(scored_spots_json)\n\
          \    \n    if not spots:\n        return {\n            'optimized_spots_json':\
          \ '[]',\n            'optimized_spots_text': 'ã‚¹ãƒãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“',\n           \
          \ 'total_distance_m': 0,\n            'walking_time_min': 0,\n         \
          \   'route_quality': 'N/A'\n        }\n    \n    # Step 1: ä¸Šä½ã‚¹ãƒãƒƒãƒˆã‚’å–å¾—\n \
          \   target_count = int(spot_count)\n    top_spots = spots[:target_count\
          \ + 3]\n    \n    # Step 2: ã‚¹ãƒãƒƒãƒˆã®åˆ†å¸ƒã‚’åˆ†æ\n    lats = [s.get('lat', 0) for\
          \ s in top_spots]\n    lngs = [s.get('lng', 0) for s in top_spots]\n   \
          \ lat_range = max(lats) - min(lats)\n    lng_range = max(lngs) - min(lngs)\n\
          \    \n    # Step 3: åˆ†å¸ƒã®åºƒãŒã‚Šã‹ã‚‰æ–¹å‘ã‚’æ±ºå®š\n    # ç·¯åº¦å¹… > çµŒåº¦å¹… Ã— 1.5 ãªã‚‰å—åŒ—ã€ãã‚Œä»¥å¤–ã¯æ±è¥¿\n\
          \    if lat_range > lng_range * 1.5:\n        axis = 'lat'  # å—åŒ—æ–¹å‘\n   \
          \ elif lng_range > lat_range * 1.5:\n        axis = 'lng'  # æ±è¥¿æ–¹å‘\n    else:\n\
          \        # åŒç¨‹åº¦ã®å ´åˆã€ä¸¡æ–¹è©¦ã—ã¦çŸ­ã„æ–¹ã‚’é¸æŠ\n        axis = 'both'\n    \n    # Step 4:\
          \ åŸºæº–ç‚¹ã‚’è¨­å®š\n    avg_lat = sum(lats) / len(lats)\n    avg_lng = sum(lngs) /\
          \ len(lngs)\n    ref_lat = float(center_lat) if center_lat else avg_lat\n\
          \    ref_lng = float(center_lng) if center_lng else avg_lng\n    \n    #\
          \ Step 5: å„è»¸ã§ãƒ«ãƒ¼ãƒˆã‚’ç”Ÿæˆ\n    routes = {}\n    \n    # åŒ—â†’å—ãƒ«ãƒ¼ãƒˆ\n    ns_route =\
          \ sorted(top_spots, key=lambda s: -s.get('lat', 0))[:target_count]\n   \
          \ routes['north_to_south'] = ns_route\n    \n    # å—â†’åŒ—ãƒ«ãƒ¼ãƒˆ\n    sn_route\
          \ = sorted(top_spots, key=lambda s: s.get('lat', 0))[:target_count]\n  \
          \  routes['south_to_north'] = sn_route\n    \n    # æ±â†’è¥¿ãƒ«ãƒ¼ãƒˆ\n    ew_route\
          \ = sorted(top_spots, key=lambda s: -s.get('lng', 0))[:target_count]\n \
          \   routes['east_to_west'] = ew_route\n    \n    # è¥¿â†’æ±ãƒ«ãƒ¼ãƒˆ\n    we_route\
          \ = sorted(top_spots, key=lambda s: s.get('lng', 0))[:target_count]\n  \
          \  routes['west_to_east'] = we_route\n    \n    # Step 6: æœ€é©ãªãƒ«ãƒ¼ãƒˆã‚’é¸æŠ\n  \
          \  if axis == 'lat':\n        # å—åŒ—æ–¹å‘ï¼šåŸºæº–ç‚¹ã«è¿‘ã„ç«¯ã‚’ã‚¹ã‚¿ãƒ¼ãƒˆ\n        north_spot =\
          \ max(top_spots, key=lambda s: s.get('lat', 0))\n        south_spot = min(top_spots,\
          \ key=lambda s: s.get('lat', 0))\n        if abs(north_spot.get('lat', 0)\
          \ - ref_lat) < abs(south_spot.get('lat', 0) - ref_lat):\n            best_key\
          \ = 'north_to_south'\n        else:\n            best_key = 'south_to_north'\n\
          \    elif axis == 'lng':\n        # æ±è¥¿æ–¹å‘ï¼šåŸºæº–ç‚¹ã«è¿‘ã„ç«¯ã‚’ã‚¹ã‚¿ãƒ¼ãƒˆ\n        east_spot\
          \ = max(top_spots, key=lambda s: s.get('lng', 0))\n        west_spot = min(top_spots,\
          \ key=lambda s: s.get('lng', 0))\n        if abs(east_spot.get('lng', 0)\
          \ - ref_lng) < abs(west_spot.get('lng', 0) - ref_lng):\n            best_key\
          \ = 'east_to_west'\n        else:\n            best_key = 'west_to_east'\n\
          \    else:\n        # ä¸¡æ–¹è©¦ã—ã¦è·é›¢ãŒçŸ­ã„æ–¹ã‚’é¸æŠ\n        distances = {}\n        for\
          \ key, route in routes.items():\n            distances[key] = calculate_total_distance(route)\n\
          \        best_key = min(distances, key=distances.get)\n    \n    route =\
          \ routes[best_key]\n    \n    # Step 7: éš£æ¥ã‚¹ãƒ¯ãƒƒãƒ—ã§å±€æ‰€æœ€é©åŒ–\n    improved = True\n\
          \    max_iter = 20\n    iter_count = 0\n    while improved and iter_count\
          \ < max_iter:\n        improved = False\n        iter_count += 1\n     \
          \   for i in range(len(route) - 1):\n            current_dist = calculate_total_distance(route)\n\
          \            route[i], route[i+1] = route[i+1], route[i]\n            new_dist\
          \ = calculate_total_distance(route)\n            if new_dist >= current_dist:\n\
          \                route[i], route[i+1] = route[i+1], route[i]\n         \
          \   else:\n                improved = True\n    \n    # Step 8: ã‚¹ãƒãƒƒãƒˆIDä»˜ä¸ã¨è·é›¢è¨ˆç®—\n\
          \    total_distance = 0\n    segment_info = []\n    \n    for i, spot in\
          \ enumerate(route):\n        spot['spot_index'] = i + 1\n        spot['spot_id']\
          \ = 'S' + str(i + 1)\n        \n        if i > 0:\n            dist = haversine_distance(\n\
          \                route[i-1].get('lat', 0), route[i-1].get('lng', 0),\n \
          \               spot.get('lat', 0), spot.get('lng', 0)\n            )\n\
          \            total_distance += dist\n            spot['distance_from_prev_m']\
          \ = int(dist)\n            spot['walking_time_from_prev_min'] = round(dist\
          \ / 67, 1)\n            segment_info.append(int(dist))\n    \n    # Step\
          \ 9: ãƒ«ãƒ¼ãƒˆå“è³ªè©•ä¾¡\n    max_segment = max(segment_info) if segment_info else 0\n\
          \    if max_segment < 500 and total_distance < 3000:\n        quality =\
          \ 'æœ€é©'\n    elif max_segment < 800 and total_distance < 5000:\n        quality\
          \ = 'è‰¯å¥½'\n    else:\n        quality = 'è¦æ”¹å–„'\n    \n    # Step 10: æ­©è¡Œæ™‚é–“è¨ˆç®—\n\
          \    walking_time = total_distance / 67 + len(route) * 0.5\n    \n    #\
          \ Step 11: æ–¹å‘ãƒ©ãƒ™ãƒ«\n    direction_labels = {\n        'north_to_south': 'åŒ—â†’å—',\n\
          \        'south_to_north': 'å—â†’åŒ—',\n        'east_to_west': 'æ±â†’è¥¿',\n    \
          \    'west_to_east': 'è¥¿â†’æ±'\n    }\n    direction_label = direction_labels.get(best_key,\
          \ best_key)\n    \n    # Step 12: ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼å‡ºåŠ›\n    spots_text = 'ã€ãƒ«ãƒ¼ãƒˆå“è³ª: '\
          \ + quality + 'ã€‘\\n'\n    spots_text += 'ã€æ–¹å‘: ' + direction_label + 'ã€‘\\\
          n'\n    spots_text += 'ã€ç·¯åº¦å¹…: ' + str(round(lat_range * 111000)) + 'm, çµŒåº¦å¹…:\
          \ ' + str(round(lng_range * 111000 * 0.8)) + 'mã€‘\\n\\n'\n    for i, s in\
          \ enumerate(route):\n        spots_text += s['spot_id'] + ': ' + s['name']\
          \ + '\\n'\n        spots_text += '   ä½æ‰€: ' + s.get('address', '') + '\\\
          n'\n        spots_text += '   åº§æ¨™: ' + str(round(s.get('lat', 0), 6)) + ',\
          \ ' + str(round(s.get('lng', 0), 6)) + '\\n'\n        if i > 0:\n      \
          \      spots_text += '   â† å‰ã‚¹ãƒãƒƒãƒˆã‹ã‚‰ ' + str(s.get('distance_from_prev_m',\
          \ 0)) + 'm\\n'\n        spots_text += '   é¸å®šç†ç”±: ' + s.get('selection_reason',\
          \ '') + '\\n\\n'\n    spots_text += 'ã€ç·è·é›¢ã€‘' + str(int(total_distance)) +\
          \ 'm\\n'\n    spots_text += 'ã€æ¨å®šæ­©è¡Œæ™‚é–“ã€‘' + str(int(walking_time)) + 'åˆ†\\n'\n\
          \    \n    return {\n        'optimized_spots_json': json.dumps(route, ensure_ascii=False),\n\
          \        'optimized_spots_text': spots_text,\n        'total_distance_m':\
          \ int(total_distance),\n        'walking_time_min': int(walking_time),\n\
          \        'route_quality': quality\n    }"
        code_language: python3
        outputs:
          optimized_spots_json:
            children: null
            type: string
          optimized_spots_text:
            children: null
            type: string
          route_quality:
            children: null
            type: string
          total_distance_m:
            children: null
            type: number
          walking_time_min:
            children: null
            type: number
        selected: false
        title: CODE_ãƒ«ãƒ¼ãƒˆæœ€é©åŒ–
        type: code
        variables:
        - value_selector:
          - '1768602035766'
          - scored_spots_json
          value_type: string
          variable: scored_spots_json
        - value_selector:
          - '1768558472266'
          - spot_count
          value_type: number
          variable: spot_count
        - value_selector:
          - '1768558472266'
          - center_lat
          value_type: string
          variable: center_lat
        - value_selector:
          - '1768558472266'
          - center_lng
          value_type: string
          variable: center_lng
      height: 52
      id: '1768602131448'
      position:
        x: 2502.7143112894146
        y: 302.04736200195606
      positionAbsolute:
        x: 2502.7143112894146
        y: 302.04736200195606
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        context:
          enabled: false
          variable_selector: []
        model:
          completion_params:
            max_output_tokens: 8192
            temperature: 0.3
            thinking_level: Low
          mode: chat
          name: gemini-3-flash-preview
          provider: langgenius/gemini/google
        prompt_template:
        - id: 3c994e36-28b1-420b-911c-6b112e4c2ef4
          role: system
          text: 'ã‚ãªãŸã¯å‘¨éŠå‹ç‰©èªÃ—è¬è§£ãã®ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒˆã§ã™ã€‚


            ã€åŒ—æ¥µæ˜Ÿã€‘è¡—ãŒä¸»å½¹ã€ç‰©èªãŒãƒ¬ãƒ³ã‚ºã€è¬ãŒå‹•æ©Ÿ


            ã€ã‚±ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«å‹ã®ç‰©èªæ§‹é€ ã€‘

            å‘¨éŠå‹ã®ç‰©èªã¯ã€Œèµ·æ‰¿è»¢çµã€ã‚ˆã‚Šã€Œé€£ç¶šã™ã‚‹ç™ºè¦‹ã€ãŒé‡è¦ã§ã™ã€‚


            1. Hookï¼ˆå°å…¥ï¼‰ï¼šäº‹ä»¶/ä¾é ¼/é•å’Œæ„Ÿã€‚30ç§’ã§æ´ã‚€

            2. Trailï¼ˆæ¢ç´¢ï¼‰ï¼šã‚¹ãƒãƒƒãƒˆã”ã¨ã«ã€Œè¨¼æ‹ ã€ã‚’1ã¤è¿½åŠ ã€‚çŸ­ã„é”æˆã‚’ç©ã‚€

            3. Shiftï¼ˆè»¢æ›ï¼‰ï¼šä¸­ç›¤ã§è¦–ç‚¹ãŒå¤‰ã‚ã‚‹æƒ…å ±ã‚’æŠ•å…¥ã€‚é¢ç™½ã•ãŒè·³ã­ã‚‹

            4. Revealï¼ˆè§£æ±ºï¼‰ï¼šã€Œè¡—ã®æ„å‘³ãŒæ›´æ–°ã•ã‚Œã‚‹ã€ç€åœ°


            ã€ã‚¢ãƒ³ã‚«ãƒ¼ï¼ˆç‰©èªã®æ­ï¼‰ã€‘

            å„ã‚¹ãƒãƒƒãƒˆã«ã¯ç‰©èªä¸Šã®å½¹å‰²ã‚’1ã¤ã ã‘å‰²ã‚Šå½“ã¦ã¾ã™ï¼ˆè¤‡æ•°NGï¼‰ã€‚

            å½¹å‰²ãŒãƒ–ãƒ¬ã‚‹ã¨ã‚¹ãƒãƒƒãƒˆãŒå¼±ãæ„Ÿã˜ã¾ã™ã€‚


            å‡ºåŠ›ã¯å¿…ãšJSONå½¢å¼ã§ã€‚'
        - id: c097160a-c146-4b61-aab6-00ff1309abdb
          role: user
          text: "ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å½¹å‰²ã€‘\n{{#1768599287614.player_role#}}\n\nã€ä½“é¨“ã®ç´„æŸã€‘\n{{#1768599287614.experience_promise#}}\n\
            \nã€é›°å›²æ°—ã€‘\n{{#1768599287614.atmosphere_tone#}}\n\nã€ç‰©èªã®å°å…¥ãƒ•ãƒƒã‚¯ã€‘\n{{#1768599287614.story_hook#}}\n\
            \nã€ãƒ†ãƒ¼ãƒã€‘\n{{#1768599287614.primary_themes#}}\n\nã€ã‚¨ãƒªã‚¢æƒ…å ±ã€‘\n{{#1768599416646.text#}}\n\
            \nã€æœ€é©åŒ–ã•ã‚ŒãŸã‚¹ãƒãƒƒãƒˆä¸€è¦§ã€‘\n{{#1768602131448.optimized_spots_text#}}\n\n\nã€å„ã‚¹ãƒãƒƒãƒˆã«å‰²ã‚Šå½“ã¦ã‚‹ç‰©èªå½¹å‰²ï¼ˆstory_anchorï¼‰ã€‘\n\
            å¿…ãš1ã¤ã ã‘é¸ã¶ã“ã¨ã€‚\n\n- hook: äº‹ä»¶ç™ºç”Ÿ/ä¾é ¼å—è«¾ï¼ˆå¿…ãšæœ€åˆã®ã‚¹ãƒãƒƒãƒˆï¼‰\n- evidence: è¨¼æ‹ ãŒè¦‹ã¤ã‹ã‚‹å ´æ‰€\n-\
            \ witness: ç›®æ’ƒè€…/è¨¼è¨€ãŒã„ãŸå ´æ‰€\n- cipher: æš—å·/ç¬¦å·ãŒéš ã•ã‚ŒãŸå ´æ‰€\n- memory: è¨˜æ†¶ãŒæºã‚Œã‚‹/éå»ãŒè˜‡ã‚‹å ´æ‰€\n\
            - contradiction: çŸ›ç›¾/å˜˜ãŒéœ²å‘ˆã™ã‚‹å ´æ‰€\n- shift: è¦–ç‚¹ãŒå¤‰ã‚ã‚‹è»¢æ›ç‚¹ï¼ˆä¸­ç›¤ã«1ã¤ï¼‰\n- truth: çœŸå®Ÿã«è¿‘ã¥ãå ´æ‰€\n\
            - reveal: å…¨ã¦ãŒæ˜ã‚‰ã‹ã«ãªã‚‹å ´æ‰€ï¼ˆå¿…ãšæœ€å¾Œã®ã‚¹ãƒãƒƒãƒˆï¼‰\n\nã€è¬ã®ã‚¿ã‚¤ãƒ—ï¼ˆpuzzle_typeï¼‰ã€‘\nå¼·ã„é †ï¼ˆç¾åœ°ä¾å­˜åº¦é †ï¼‰\n\
            \n- observation: ç¾åœ°ã‚’è¦‹ã¦è§£ãï¼ˆæ•°/å½¢/æ–¹è§’/ç´‹ç« ï¼‰æœ€å¼·\n- comparison: åœ°å›³ã‚„å†™çœŸã¨ç¾åœ°ã‚’ç…§ã‚‰ã—åˆã‚ã›ã‚‹\n\
            - testimony: è¨¼è¨€ã®çŸ›ç›¾ã‚’è¦‹æŠœãï¼ˆé¸æŠå¼ï¼‰\n- cipher_light: ç¾åœ°ã®æ–‡å­—/éŠ˜æ¿ã‚’ä½¿ã†è»½ã„æš—å·\n- logic:\
            \ æƒ…å ±ã‚’æ•´ç†ã—ã¦æ¨ç†ï¼ˆç§»å‹•ä¸­å‘ã‘ï¼‰\n\nã€å‡ºåŠ›å½¢å¼ã€‘JSON\n{\n  \"narrative_structure\": {\n  \
            \  \"case_title\": \"äº‹ä»¶/è¬ã®åå‰ï¼ˆé­…åŠ›çš„ã«ï¼‰\",\n    \"case_premise\": \"ã“ã®äº‹ä»¶/è¬ã¯ä½•ã‹ï¼ˆ2-3æ–‡ï¼‰\"\
            ,\n    \"evidence_chain\": \"è¨¼æ‹ ãŒã©ã†ç¹‹ãŒã‚‹ã‹ï¼ˆ2æ–‡ï¼‰\",\n    \"shift_moment\": \"\
            ã©ã“ã§è¦–ç‚¹ãŒå¤‰ã‚ã‚‹ã‹ï¼ˆ1æ–‡ï¼‰\",\n    \"final_revelation\": \"æœ€å¾Œã«ä½•ãŒåˆ†ã‹ã‚‹ã‹ï¼ˆãƒã‚¿ãƒãƒ¬ãªã—ã€æ›–æ˜§ã«ï¼‰\"\
            \n  },\n  \"spots\": [\n    {\n      \"spot_id\": \"S1\",\n      \"spot_name\"\
            : \"ã‚¹ãƒãƒƒãƒˆå\",\n      \"story_anchor\": \"hook\",\n      \"puzzle_type\"\
            : \"observation\",\n      \"what_player_finds\": \"ã“ã“ã§è¦‹ã¤ã‹ã‚‹è¨¼æ‹ /æƒ…å ±ï¼ˆå…·ä½“çš„ã«ï¼‰\"\
            ,\n      \"look_at_instruction\": \"æ­£é¢ã®â—‹â—‹ã‚’è¦‹ã¦ï¼ˆãƒ˜ãƒƒã‚ºã‚¢ãƒƒãƒ—æŒ‡ç¤ºï¼‰\",\n      \"emotional_beat\"\
            : \"ã“ã®åœ°ç‚¹ã§ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒæ„Ÿã˜ã‚‹ã“ã¨\",\n      \"small_reward\": \"è§£ã‘ãŸã¨ãã«å¾—ã‚‰ã‚Œã‚‹å°å ±é…¬ï¼ˆæƒ…å ±/ã‚¢ã‚¤ãƒ†ãƒ åï¼‰\"\
            ,\n      \"next_push\": \"æ¬¡ã®ã‚¹ãƒãƒƒãƒˆã¸ã®å‹•æ©Ÿä»˜ã‘ï¼ˆ1æ–‡ï¼‰\"\n    }\n  ],\n  \"reward_structure\"\
            : {\n    \"small_rewards\": \"å„ã‚¹ãƒãƒƒãƒˆã§å¾—ã‚‹å°å ±é…¬ã®ãƒªã‚¹ãƒˆ\",\n    \"medium_reward_spot\"\
            : \"ä¸­å ±é…¬ãŒã‚ã‚‹è»¢æ›ç‚¹ã®ã‚¹ãƒãƒƒãƒˆID\",\n    \"final_reward\": \"æœ€å¾Œã«å¾—ã‚‰ã‚Œã‚‹å¤§å ±é…¬ï¼ˆè¡—ã®æ„å‘³ã®æ›´æ–°ï¼‰\"\
            \n  }\n}\n\nã€é‡è¦ãƒ«ãƒ¼ãƒ«ã€‘\n- æœ€åˆã®ã‚¹ãƒãƒƒãƒˆï¼å¿…ãšã€Œhookã€\n- æœ€å¾Œã®ã‚¹ãƒãƒƒãƒˆï¼å¿…ãšã€Œrevealã€\n- ä¸­ç›¤ã«ã€Œshiftã€ã‚’1ã¤é…ç½®\n\
            - å„ã‚¹ãƒãƒƒãƒˆã®å½¹å‰²ã¯é‡è¤‡ã•ã›ãªã„"
        selected: false
        title: LLMãƒ¢ãƒãƒ¼ãƒ•é¸å®š
        type: llm
        vision:
          enabled: false
      height: 88
      id: '1768602371187'
      position:
        x: 2804.7143112894146
        y: 302.04736200195606
      positionAbsolute:
        x: 2804.7143112894146
        y: 302.04736200195606
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        code: "import json\nimport re\n\ndef main(llm_output: str) -> dict:\n    json_match\
          \ = re.search(r'\\{[\\s\\S]*\\}', llm_output)\n    if json_match:\n    \
          \    try:\n            data = json.loads(json_match.group())\n         \
          \   motifs = data.get(\"motifs\", [])\n            \n            # ãƒ¢ãƒãƒ¼ãƒ•ãƒ†ã‚­ã‚¹ãƒˆåŒ–\n\
          \            motifs_text = \"\"\n            for m in motifs:\n        \
          \        motifs_text += f\"{m.get('spot_id')}: {m.get('spot_name')}\\n\"\
          \n                motifs_text += f\"  å½¹å‰²: {m.get('scene_role')}\\n\"\n \
          \               motifs_text += f\"  è¬ã‚¿ã‚¤ãƒ—: {m.get('puzzle_type')}\\n\"\n\
          \                motifs_text += f\"  éµã‚¿ã‚¤ãƒ—: {m.get('plot_key_type')}\\n\"\
          \n                motifs_text += f\"  å­¦ã³: {', '.join(m.get('learning_elements',\
          \ []))}\\n\"\n                motifs_text += f\"  ç‰©èª: {m.get('story_beat')}\\\
          n\"\n                motifs_text += f\"  è¬ã‚³ãƒ³ã‚»ãƒ—ãƒˆ: {m.get('puzzle_concept')}\\\
          n\\n\"\n            \n            return {\n                \"motifs_json\"\
          : json.dumps(motifs, ensure_ascii=False),\n                \"motifs_text\"\
          : motifs_text,\n                \"overall_narrative\": data.get(\"overall_narrative\"\
          , \"\"),\n                \"meta_puzzle_concept\": data.get(\"meta_puzzle_concept\"\
          , \"\"),\n                \"motifs_count\": len(motifs)\n            }\n\
          \        except:\n            pass\n    \n    return {\n        \"motifs_json\"\
          : \"[]\",\n        \"motifs_text\": \"ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ\",\n        \"overall_narrative\"\
          : \"\",\n        \"meta_puzzle_concept\": \"\",\n        \"motifs_count\"\
          : 0\n    }"
        code_language: python3
        outputs:
          meta_puzzle_concept:
            children: null
            type: string
          motifs_count:
            children: null
            type: number
          motifs_json:
            children: null
            type: string
          motifs_text:
            children: null
            type: string
          overall_narrative:
            children: null
            type: string
        selected: false
        title: CODE_ãƒ¢ãƒãƒ¼ãƒ•é¸å®šãƒ‘ãƒ¼ã‚¹
        type: code
        variables:
        - value_selector:
          - '1768602371187'
          - text
          value_type: string
          variable: llm_output
      height: 52
      id: '1768602505042'
      position:
        x: 3106.7143112894146
        y: 302.04736200195606
      positionAbsolute:
        x: 3106.7143112894146
        y: 302.04736200195606
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        context:
          enabled: false
          variable_selector: []
        model:
          completion_params:
            max_output_tokens: 8192
            temperature: 0.3
            thinking_level: Low
          mode: chat
          name: gemini-3-flash-preview
          provider: langgenius/gemini/google
        prompt_template:
        - id: 7659cb48-ffe5-4179-8f71-b2216b5825db
          role: system
          text: 'ã‚ãªãŸã¯å‘¨éŠå‹ç‰©èªã®è„šæœ¬å®¶ã§ã™ã€‚


            ã€åŒ—æ¥µæ˜Ÿã€‘è¡—ãŒä¸»å½¹ã€ç‰©èªãŒãƒ¬ãƒ³ã‚ºã€è¬ãŒå‹•æ©Ÿ


            ã€ã‚±ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«å‹ã®ç‰©èªæ§‹é€ ã€‘

            1. Hookï¼ˆå°å…¥ï¼‰ï¼šäº‹ä»¶/ä¾é ¼/é•å’Œæ„Ÿã€‚30ç§’ã§æ´ã‚€

            2. Trailï¼ˆæ¢ç´¢ï¼‰ï¼šã‚¹ãƒãƒƒãƒˆã”ã¨ã«ã€Œè¨¼æ‹ ã€ã‚’1ã¤è¿½åŠ 

            3. Shiftï¼ˆè»¢æ›ï¼‰ï¼šä¸­ç›¤ã§è¦–ç‚¹ãŒå¤‰ã‚ã‚‹

            4. Revealï¼ˆè§£æ±ºï¼‰ï¼šè¡—ã®æ„å‘³ãŒæ›´æ–°ã•ã‚Œã‚‹


            ã€ãƒ­ãƒ¼ã‚«ãƒ«äº‹å®Ÿã¯ã€Œãƒ‰ãƒ©ãƒã®ç‡ƒæ–™ã€ã«ã™ã‚‹ã€‘

            è¦³å…‰ã‚¬ã‚¤ãƒ‰ã®èª¬æ˜ã‚’ãã®ã¾ã¾å…¥ã‚Œã‚‹ã¨ä½“é¨“ãŒæ­¢ã¾ã‚‹ã€‚

            äº‹å®Ÿã¯ã“ã†å¤‰æ›ã™ã‚‹ï¼š

            - æƒ…å ± â†’ ç·Šå¼µï¼ˆãªãœéš ã•ã‚ŒãŸï¼Ÿï¼‰

            - æƒ…å ± â†’ é¸æŠï¼ˆä¿¡ã˜ã‚‹ï¼Ÿç–‘ã†ï¼Ÿï¼‰

            - æƒ…å ± â†’ è¦–ç‚¹ï¼ˆåŒã˜æ™¯è‰²ãŒé•ã£ã¦è¦‹ãˆã‚‹ï¼‰


            å‡ºåŠ›ã¯å¿…ãšJSONå½¢å¼ã§ã€‚'
        - id: 31be4b35-8c27-45ae-bcbe-995b273aba67
          role: user
          text: "ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å½¹å‰²ã€‘\n{{#1768599287614.player_role#}}\n\nã€ä½“é¨“ã®ç´„æŸã€‘\n{{#1768599287614.experience_promise#}}\n\
            \nã€é›°å›²æ°—ã€‘\n{{#1768599287614.atmosphere_tone#}}\n\nã€ãƒ†ãƒ¼ãƒã€‘\n{{#1768599287614.primary_themes#}}\n\
            \nã€ã‚¹ãƒãƒƒãƒˆã¨ãƒ¢ãƒãƒ¼ãƒ•ã€‘\n{{#1768602505042.motifs_text#}}\n\nã€äº‹ä»¶/è¬ã®æ§‹é€ ã€‘\n{{#1768602505042.overall_narrative#}}\n\
            \nã€ã‚¨ãƒªã‚¢ã®æ­´å²ã€‘\n{{#1768599416646.text#}}\n\n\nã€premiseï¼ˆå‰æèª¬æ˜ï¼‰ã®å¿…é ˆãƒ«ãƒ¼ãƒ«ã€‘\n- 300ã€œ500å­—ã€3ã€œ4æ®µè½\n\
            - äºŒäººç§°ï¼ˆã‚ãªãŸï¼‰ä¸­å¿ƒã€ç¾åœ¨å½¢\n- æœ€å¾Œã®1æ–‡ã¯å•ã„ã‹ã‘ã§ç· ã‚ã‚‹\n- ãƒã‚¿ãƒãƒ¬ç¦æ­¢ï¼ˆç­”ãˆã€çŠ¯äººã€ã©ã‚“ã§ã‚“è¿”ã—ã¯æ›¸ã‹ãªã„ï¼‰\n- æ­´å²çš„äº‹å®Ÿã‹ã‚‰é€¸è„±ã—ãªã„\n\
            \nã€premiseã«å¿…ãšå«ã‚ã‚‹8è¦ç´ ã€‘\n1. é›°å›²æ°—ã®ä¸€æ’ƒç›®ï¼ˆæ˜ ç”»ã®ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°æ„Ÿï¼‰\n2. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å½¹å‰²ï¼ˆãªã‚Šãã‚Šï¼‰\n3. èˆå°ã®æå†™ï¼ˆå…·ä½“çš„ãªå ´æ‰€ï¼‰\n\
            4. äº‹ä»¶ãƒ»ç•°å¤‰ï¼ˆå°å…¥ãƒ•ãƒƒã‚¯ï¼‰\n5. ç—•è·¡ï¼ˆã‚·ãƒ³ãƒœãƒ«/æš—å·/ä¼æ‰¿/æ‰‹ãŒã‹ã‚Šï¼‰\n6. è³­ã‘é‡‘ï¼ˆã‚¿ã‚¤ãƒ ãƒªãƒŸãƒƒãƒˆ/å±æ©Ÿ/å¤±æ•—ç¤ºå”†ï¼‰\n7. ä½“é¨“ã®ç´„æŸï¼ˆãŸã ã®æ•£æ­©ã§ã¯ãªã„ï¼‰\n\
            8. CTAï¼ˆå•ã„ã‹ã‘ã§ç· ã‚ï¼‰\n\n\nã€å‡ºåŠ›å½¢å¼ã€‘JSON\n{\n  \"main_plot\": {\n    \"premise\"\
            : \"300ã€œ500å­—ã®å°å…¥æ–‡\",\n    \"goal\": \"ä¸»äººå…¬ã®ç›®çš„ï¼ˆ1æ–‡ï¼‰\",\n    \"antagonist_or_mystery\"\
            : \"å¯¾ç«‹è¦ç´ ã¾ãŸã¯ä¸­å¿ƒã®è¬ï¼ˆ1æ–‡ï¼‰\",\n    \"final_reveal_outline\": \"æœ€å¾Œã«è¡—ã®è¦‹ãˆæ–¹ãŒã©ã†å¤‰ã‚ã‚‹ã‹ï¼ˆãƒã‚¿ãƒãƒ¬ãªã—ã€æ›–æ˜§ã«ï¼‰\"\
            \n  },\n  \"spot_story_beats\": [\n    {\n      \"spot_id\": \"S1\",\n\
            \      \"story_beat\": \"ã“ã®åœ°ç‚¹ã§èµ·ã“ã‚‹ç‰©èªä¸Šã®å‡ºæ¥äº‹ï¼ˆ1æ–‡ï¼‰\",\n      \"emotional_arc\"\
            : \"ã“ã®åœ°ç‚¹ã§ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒæ„Ÿã˜ã‚‹ã“ã¨ï¼ˆ1èªï¼‰\",\n      \"key_discovery\": \"ã“ã®åœ°ç‚¹ã§ç™ºè¦‹ã™ã‚‹è¨¼æ‹ /æƒ…å ±ï¼ˆå…·ä½“çš„ã«ï¼‰\"\
            \n    }\n  ],\n  \"reward_design\": {\n    \"small_rewards\": \"å„ã‚¹ãƒãƒƒãƒˆã§å¾—ã‚‹å°å ±é…¬ã®ç¨®é¡\"\
            ,\n    \"medium_reward_description\": \"ä¸­ç›¤ã§å¾—ã‚‹ä¸­å ±é…¬ï¼ˆè¦–ç‚¹ã®å¤‰åŒ–ï¼‰\",\n    \"final_reward_description\"\
            : \"æœ€å¾Œã«å¾—ã‚‹å¤§å ±é…¬ï¼ˆè¡—ã®æ„å‘³ã®æ›´æ–°ï¼‰\"\n  }\n}"
        selected: false
        title: LLM_ç‰©èªéª¨æ ¼ç”Ÿæˆ
        type: llm
        vision:
          enabled: false
      height: 88
      id: '1768602602678'
      position:
        x: 3408.7143112894146
        y: 302.04736200195606
      positionAbsolute:
        x: 3408.7143112894146
        y: 302.04736200195606
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        code: "import json\nimport re\n\ndef main(llm_output: str) -> dict:\n    json_match\
          \ = re.search(r'\\{[\\s\\S]*\\}', llm_output)\n    if json_match:\n    \
          \    try:\n            data = json.loads(json_match.group())\n         \
          \   main_plot = data.get(\"main_plot\", {})\n            spot_beats = data.get(\"\
          spot_story_beats\", [])\n            \n            # ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ“ãƒ¼ãƒˆãƒ†ã‚­ã‚¹ãƒˆåŒ–\n   \
          \         beats_text = \"\"\n            for b in spot_beats:\n        \
          \        beats_text += f\"{b.get('spot_id')}: {b.get('story_beat')}\\n\"\
          \n                beats_text += f\"  æ„Ÿæƒ…: {b.get('emotional_arc')}\\n\"\n\
          \                beats_text += f\"  ç™ºè¦‹: {b.get('key_discovery')}\\n\\n\"\
          \n            \n            return {\n                \"premise\": main_plot.get(\"\
          premise\", \"\"),\n                \"goal\": main_plot.get(\"goal\", \"\"\
          ),\n                \"mystery\": main_plot.get(\"antagonist_or_mystery\"\
          , \"\"),\n                \"final_reveal\": main_plot.get(\"final_reveal_outline\"\
          , \"\"),\n                \"spot_beats_json\": json.dumps(spot_beats, ensure_ascii=False),\n\
          \                \"spot_beats_text\": beats_text\n            }\n      \
          \  except:\n            pass\n    \n    return {\n        \"premise\": \"\
          ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ\",\n        \"goal\": \"\",\n        \"mystery\": \"\",\n   \
          \     \"final_reveal\": \"\",\n        \"spot_beats_json\": \"[]\",\n  \
          \      \"spot_beats_text\": \"\"\n    }"
        code_language: python3
        outputs:
          final_reveal:
            children: null
            type: string
          goal:
            children: null
            type: string
          mystery:
            children: null
            type: string
          premise:
            children: null
            type: string
          spot_beats_json:
            children: null
            type: string
          spot_beats_text:
            children: null
            type: string
        selected: false
        title: CODE_ç‰©èªéª¨æ ¼ç”Ÿæˆãƒ‘ãƒ¼ã‚¹
        type: code
        variables:
        - value_selector:
          - '1768602602678'
          - text
          value_type: string
          variable: llm_output
      height: 52
      id: '1768602757091'
      position:
        x: 3710.7143112894146
        y: 302.04736200195606
      positionAbsolute:
        x: 3710.7143112894146
        y: 302.04736200195606
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        context:
          enabled: false
          variable_selector: []
        model:
          completion_params:
            max_output_tokens: 8192
            temperature: 0.3
            thinking_level: Low
          mode: chat
          name: gemini-3-flash-preview
          provider: langgenius/gemini/google
        prompt_template:
        - id: 06727bcd-26e0-4eae-bf9c-095f88e2b36e
          role: system
          text: 'ã‚ãªãŸã¯å‘¨éŠå‹è¬è§£ãã®è¨­è¨ˆå£«ã§ã™ã€‚


            ã€åŒ—æ¥µæ˜Ÿã€‘è¡—ãŒä¸»å½¹ã€ç‰©èªãŒãƒ¬ãƒ³ã‚ºã€è¬ãŒå‹•æ©Ÿ


            ã€è¬ã®æ­£è§£æ¡ä»¶ï¼šã‚¹ãƒˆãƒ¼ãƒªãƒ¼ä¸Šã®è¡Œç‚ºã«ãªã£ã¦ã„ã‚‹ã€‘

            - æ¢åµãªã‚‰ã€Œè¦³å¯Ÿã€ã€Œç…§åˆã€ã€Œæ¨ç†ã€

            - æ—…äººãªã‚‰ã€Œç™ºè¦‹ã€ã€Œåé›†ã€ã€Œè¨˜éŒ²ã€

            - èª¿æŸ»å“¡ãªã‚‰ã€Œç¢ºèªã€ã€Œæ¯”è¼ƒã€ã€Œå ±å‘Šã€


            ã€Œãƒ‘ã‚ºãƒ«ã ã‹ã‚‰è§£ãã€ã§ã¯ãªãã€Œç‰©èªã®è¡Œç‚ºã ã‹ã‚‰è§£ãã€ã«å¤‰ãˆã‚‹ã€‚


            ã€ç¾åœ°ä¾å­˜ã®è¬ã®å‹ï¼ˆå¼·ã„é †ï¼‰ã€‘

            1. è¦³å¯Ÿå‹ï¼šæ•°/ç´‹ç« /é…ç½®/æ–¹è§’/å½¢çŠ¶ï¼ˆæœ€å¼·ã€‚è¡—ãŒä¸»å½¹ã«ãªã‚‹ï¼‰

            2. ç…§åˆå‹ï¼šåœ°å›³ã¨ç¾åœ°ã‚’ç…§ã‚‰ã™ã€å†™çœŸã¨åŒã˜æ§‹å›³ã‚’æ¢ã™

            3. é¸æŠå‹ï¼šç›®æ’ƒè¨¼è¨€ã®çŸ›ç›¾ã‚’è¦‹æŠœã„ã¦é¸ã¶ï¼ˆä½è² è·ã§ãƒ‰ãƒ©ãƒå¼·ã„ï¼‰

            4. è»½æš—å·å‹ï¼šç¾åœ°ã®æ–‡å­—ãƒ»éŠ˜æ¿ã‚’ææ–™ã«ï¼ˆå®Œå…¨ãªç”»é¢å®Œçµã¯é¿ã‘ã‚‹ï¼‰


            ã€çµ¶å¯¾ãƒ«ãƒ¼ãƒ«ã€‘

            - åŒã˜å ´æ‰€ã§ã‚¹ãƒãƒ›æ³¨è¦–ãŒé•·ããªã‚‹è¬ã¯é¿ã‘ã‚‹

            - ã€Œé¡”ã‚’ä¸Šã’ã¦è¡—ã‚’è¦‹ã‚‹ã€ä½“é¨“ã‚’å®ˆã‚‹


            å‡ºåŠ›ã¯å¿…ãšJSONå½¢å¼ã§ã€‚'
        - id: f6252950-9da1-4e16-877d-43ad42f02e1d
          role: user
          text: "ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å½¹å‰²ã€‘\n{{#1768599287614.player_role#}}\n\nã€ç‰©èªã®å‰æï¼ˆpremiseï¼‰ã€‘\n\
            {{#1768602757091.premise#}}\n\nã€ã‚¹ãƒãƒƒãƒˆã¨å½¹å‰²ã€‘\n{{#1768602505042.motifs_text#}}\n\
            \nã€å„ã‚¹ãƒãƒƒãƒˆã®ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ“ãƒ¼ãƒˆã€‘\n{{#1768602757091.spot_beats_text#}}\n\n\nã€è¬è¨­è¨ˆã®çµ¶å¯¾ãƒ«ãƒ¼ãƒ«ã€‘\n\
            \n1. ç¾åœ°ã‚’è¦‹ã‚Œã°è§£ã‘ã‚‹ï¼ˆå¤–éƒ¨çŸ¥è­˜ä¸è¦ï¼‰\n2. ã€Œé¡”ã‚’ä¸Šã’ã‚‹æŒ‡ç¤ºã€ã‚’å¿…ãšå«ã‚ã‚‹\n3. ç­”ãˆã¯æ˜ç¢ºã§1ã¤ã ã‘\n4. è§£ã„ãŸç¬é–“ã«ã€Œã¸ã‡ï¼ã€ã¨å­¦ã³ãŒã‚ã‚‹\n\
            5. è¬ãŒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å½¹å‰²ã«åˆã£ãŸè¡Œç‚ºã§ã‚ã‚‹\n\nã€ç¦æ­¢äº‹é …ã€‘\n- ã€Œâ—‹â—‹ã‚’å»ºã¦ãŸã®ã¯èª°ï¼Ÿã€ç³»ã®æš—è¨˜ã‚¯ã‚¤ã‚º\n- ã‚¹ãƒãƒƒãƒˆã¨é–¢ä¿‚ãªã„ä¸€èˆ¬ãƒ‘ã‚ºãƒ«\n\
            - ç­”ãˆãŒè¤‡æ•°é€šã‚Šã‚ã‚‹æ›–æ˜§ãªå•é¡Œ\n- é•·æ–‡ã‚’ã‚¹ãƒãƒ›ã§èª­ã¾ã›ã‚‹è¬\n\n\nã€å„ã‚¹ãƒãƒƒãƒˆã®è¬è¨­è¨ˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€‘\n\n1. åˆ°ç€æ™‚å°å…¥ï¼ˆ30ã€œ60ç§’ï¼‰\n\
            \   - arrival_text: åˆ°ç€æ™‚ã«è¡¨ç¤ºã™ã‚‹çŸ­ã„æ–‡ï¼ˆ2-3æ–‡ï¼‰\n   - look_up_instruction: ã€Œâ—‹â—‹ã®æ–¹ã‚’è¦‹ã¦ã€ï¼ˆé¡”ã‚’ä¸Šã’ã‚‹å…·ä½“çš„æŒ‡ç¤ºï¼‰\n\
            \n2. è¦³å¯ŸãƒŸãƒƒã‚·ãƒ§ãƒ³ï¼ˆ1ã€œ3åˆ†ï¼‰\n   - observation_target: ä½•ã‚’è¦‹ã‚‹ã‹ï¼ˆå…·ä½“çš„ã«ï¼‰\n   - puzzle_prompt:\
            \ è¬ã®å‡ºé¡Œæ–‡ï¼ˆ50-80å­—ã€ç¾ã—ãè¬ã‚ã„ãŸèªã‚Šå£ï¼‰\n   - answer: ç­”ãˆï¼ˆæ˜ç¢ºã«1ã¤ï¼‰\n   - action_verb:\
            \ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã‚„ã‚‹ã“ã¨ï¼ˆæ•°ãˆã‚‹/æ¢ã™/è¦‹ã¤ã‘ã‚‹/æ¯”ã¹ã‚‹ï¼‰\n\n3. 3æ®µéšãƒ’ãƒ³ãƒˆ\n   - hint_1: æ–¹å‘æ€§ï¼ˆä½•ã‚’è¦‹ã‚‹ï¼Ÿï¼‰\n\
            \   - hint_2: å…·ä½“çš„ï¼ˆã©ã“ã‚’è¦‹ã‚‹ï¼Ÿï¼‰\n   - hint_3: æ•‘æ¸ˆï¼ˆã»ã¼ç­”ãˆï¼‰\n\n4. å ±é…¬ï¼ˆ30ã€œ60ç§’ï¼‰\n  \
            \ - solved_reveal: è§£ã‘ãŸã‚‰åˆ†ã‹ã‚‹è±†çŸ¥è­˜/èƒŒæ™¯ï¼ˆ2-3æ–‡ï¼‰\n   - evidence_item: æ‰‹ã«å…¥ã‚‹è¨¼æ‹ /ã‚¢ã‚¤ãƒ†ãƒ ã®åå‰\n\
            \   - next_push: æ¬¡ã®ã‚¹ãƒãƒƒãƒˆã¸ã®å‹•æ©Ÿï¼ˆ1æ–‡ï¼‰\n\n\nã€å‡ºåŠ›å½¢å¼ã€‘JSONé…åˆ—\n[\n  {\n    \"spot_id\"\
            : \"S1\",\n    \"spot_name\": \"ã‚¹ãƒãƒƒãƒˆå\",\n    \"story_anchor\": \"hook\"\
            ,\n    \"arrival\": {\n      \"arrival_text\": \"åˆ°ç€æ™‚ã®çŠ¶æ³èª¬æ˜ï¼ˆ2-3æ–‡ã€ç¾åœ¨å½¢ï¼‰\"\
            ,\n      \"look_up_instruction\": \"æ­£é¢ã®â—‹â—‹ã‚’è¦‹ä¸Šã’ã¦\"\n    },\n    \"mission\"\
            : {\n      \"observation_target\": \"å±‹æ ¹ã®ä¸Šã®â—‹â—‹\",\n      \"action_verb\"\
            : \"æ•°ãˆã‚‹\",\n      \"puzzle_prompt\": \"ç¾ã—ãè¬ã‚ã„ãŸå‡ºé¡Œæ–‡ï¼ˆ50-80å­—ï¼‰\",\n      \"\
            answer\": \"ç­”ãˆ\",\n      \"difficulty\": 2\n    },\n    \"hints\": {\n\
            \      \"hint_1\": \"æ–¹å‘æ€§ã®ãƒ’ãƒ³ãƒˆ\",\n      \"hint_2\": \"å…·ä½“çš„ãªãƒ’ãƒ³ãƒˆ\",\n    \
            \  \"hint_3\": \"æ•‘æ¸ˆã®ãƒ’ãƒ³ãƒˆï¼ˆã»ã¼ç­”ãˆï¼‰\"\n    },\n    \"reward\": {\n      \"solved_reveal\"\
            : \"è§£ã‘ãŸã‚‰åˆ†ã‹ã‚‹èƒŒæ™¯/è±†çŸ¥è­˜ï¼ˆ2-3æ–‡ï¼‰\",\n      \"evidence_item\": \"æ‰‹ã«å…¥ã‚‹è¨¼æ‹ ã®åå‰\",\n\
            \      \"plot_key\": \"ç‰©èªã®éµï¼ˆ1-5æ–‡å­—ï¼‰\",\n      \"next_push\": \"æ¬¡ã®ã‚¹ãƒãƒƒãƒˆã¸ã®å‹•æ©Ÿä»˜ã‘ï¼ˆ1æ–‡ï¼‰\"\
            \n    }\n  }\n]\n\nå…¨ã‚¹ãƒãƒƒãƒˆåˆ†ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚"
        selected: false
        title: LLM_è¬è¨­è¨ˆãƒ«ãƒ¼ãƒ—
        type: llm
        vision:
          enabled: false
      height: 88
      id: '1768603485259'
      position:
        x: 4012.7143112894146
        y: 302.04736200195606
      positionAbsolute:
        x: 4012.7143112894146
        y: 302.04736200195606
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        code: "import json\nimport re\n\ndef main(llm_output: str) -> dict:\n    json_match\
          \ = re.search(r'\\[[\\s\\S]*\\]', llm_output)\n    if json_match:\n    \
          \    try:\n            spots = json.loads(json_match.group())\n        \
          \    plot_keys = []\n            spots_summary = ''\n            converted_spots\
          \ = []\n            \n            for s in spots:\n                spot_id\
          \ = s.get('spot_id', '')\n                spot_name = s.get('spot_name',\
          \ '')\n                story_anchor = s.get('story_anchor', '')\n      \
          \          \n                # æ–°å½¢å¼ã‹ã‚‰æ—§å½¢å¼ã¸ã®å¤‰æ›\n                arrival = s.get('arrival',\
          \ {})\n                mission = s.get('mission', {})\n                hints\
          \ = s.get('hints', {})\n                reward = s.get('reward', {})\n \
          \               \n                # lore_cardã®æ§‹ç¯‰\n                lore_card\
          \ = {\n                    'short_story_text': arrival.get('arrival_text',\
          \ ''),\n                    'player_handout': arrival.get('look_up_instruction',\
          \ '') + ' ' + mission.get('observation_target', '')\n                }\n\
          \                \n                # puzzleã®æ§‹ç¯‰\n                puzzle =\
          \ {\n                    'type': 'observation',\n                    'prompt':\
          \ mission.get('puzzle_prompt', ''),\n                    'answer': mission.get('answer',\
          \ ''),\n                    'difficulty': mission.get('difficulty', 2),\n\
          \                    'hints': [\n                        hints.get('hint_1',\
          \ ''),\n                        hints.get('hint_2', ''),\n             \
          \           hints.get('hint_3', '')\n                    ],\n          \
          \          'solution_steps': [\n                        f\"ã‚¹ãƒ†ãƒƒãƒ—1: {arrival.get('look_up_instruction',\
          \ '')}\",\n                        f\"ã‚¹ãƒ†ãƒƒãƒ—2: {mission.get('observation_target',\
          \ '')}ã‚’{mission.get('action_verb', 'ç¢ºèªã™ã‚‹')}\",\n                       \
          \ f\"ã‚¹ãƒ†ãƒƒãƒ—3: ç­”ãˆã‚’å°ãå‡ºã™\"\n                    ]\n                }\n      \
          \          \n                # rewardã®æ§‹ç¯‰\n                reward_obj = {\n\
          \                    'lore_reveal': reward.get('solved_reveal', ''),\n \
          \                   'plot_key': reward.get('plot_key', ''),\n          \
          \          'next_hook': reward.get('next_push', '')\n                }\n\
          \                \n                # scene_roleã®ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆstory_anchor â†’ scene_roleï¼‰\n\
          \                scene_role_map = {\n                    'hook': 'å°å…¥',\n\
          \                    'evidence': 'å±•é–‹',\n                    'witness': 'å±•é–‹',\n\
          \                    'cipher': 'å±•é–‹',\n                    'memory': 'è»¢æ›',\n\
          \                    'contradiction': 'è»¢æ›',\n                    'shift':\
          \ 'è»¢æ›',\n                    'truth': 'çœŸç›¸æ¥è¿‘',\n                    'reveal':\
          \ 'çµæœ«'\n                }\n                scene_role = scene_role_map.get(story_anchor,\
          \ 'å±•é–‹')\n                \n                # å¤‰æ›æ¸ˆã¿ã‚¹ãƒãƒƒãƒˆ\n                converted\
          \ = {\n                    'spot_id': spot_id,\n                    'spot_name':\
          \ spot_name,\n                    'scene_role': scene_role,\n          \
          \          'story_anchor': story_anchor,\n                    'lore_card':\
          \ lore_card,\n                    'puzzle': puzzle,\n                  \
          \  'reward': reward_obj,\n                    'arrival': arrival,\n    \
          \                'mission': mission,\n                    'hints': hints\n\
          \                }\n                converted_spots.append(converted)\n\
          \                \n                # ã‚µãƒãƒªãƒ¼ä½œæˆ\n                plot_key =\
          \ reward.get('plot_key', '')\n                puzzle_prompt = mission.get('puzzle_prompt',\
          \ '')\n                answer = mission.get('answer', '')\n            \
          \    \n                plot_keys.append(f'{spot_id}: {plot_key}')\n    \
          \            spots_summary += f'{spot_id} ({spot_name})\\n'\n          \
          \      spots_summary += f'  å½¹å‰²: {scene_role}\\n'\n                spots_summary\
          \ += f'  è¬: {puzzle_prompt}\\n'\n                spots_summary += f'  ç­”ãˆ:\
          \ {answer}\\n'\n                spots_summary += f'  éµ: {plot_key}\\n\\\
          n'\n            \n            return {\n                'spot_scenes_json':\
          \ json.dumps(converted_spots, ensure_ascii=False),\n                'spot_scenes_count':\
          \ len(converted_spots),\n                'plot_keys_text': '\\n'.join(plot_keys),\n\
          \                'spots_summary': spots_summary\n            }\n       \
          \ except:\n            pass\n    \n    return {\n        'spot_scenes_json':\
          \ '[]',\n        'spot_scenes_count': 0,\n        'plot_keys_text': 'ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ',\n\
          \        'spots_summary': ''\n    }\n"
        code_language: python3
        outputs:
          plot_keys_text:
            children: null
            type: string
          spot_scenes_count:
            children: null
            type: number
          spot_scenes_json:
            children: null
            type: string
          spots_summary:
            children: null
            type: string
        selected: false
        title: CODE_è¬è¨­è¨ˆçµæœçµåˆ
        type: code
        variables:
        - value_selector:
          - '1768603485259'
          - text
          value_type: string
          variable: llm_output
      height: 52
      id: '1768603594197'
      position:
        x: 4314.714311289415
        y: 302.04736200195606
      positionAbsolute:
        x: 4314.714311289415
        y: 302.04736200195606
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        context:
          enabled: false
          variable_selector: []
        model:
          completion_params:
            max_output_tokens: 8192
            temperature: 0.3
            thinking_level: Low
          mode: chat
          name: gemini-3-flash-preview
          provider: langgenius/gemini/google
        prompt_template:
        - id: dafc3445-0350-4b98-9b93-3b4d78991d8b
          role: system
          text: 'ã‚ãªãŸã¯ã²ã‚‰ã‚ãå‹ãƒ‘ã‚ºãƒ«ã®è¬ä½œå®¶ã§ã™ã€‚

            å…¨ã‚¹ãƒãƒƒãƒˆã§é›†ã‚ãŸã€Œéµã€ã‚’ä½¿ã£ã¦è§£ãã€æ„Ÿå‹•ã®æœ€çµ‚è¬ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

            å‡ºåŠ›ã¯å¿…ãšJSONå½¢å¼ã§è¡Œã£ã¦ãã ã•ã„ã€‚'
        - id: e6d6a840-9132-41d3-8bad-82aecbb32abc
          role: user
          text: "ã“ã‚Œã¾ã§ã®ã‚¹ãƒãƒƒãƒˆã§é›†ã‚ãŸã€Œéµã€ã‚’å…¨ã¦ä½¿ã£ã¦è§£ãã€æœ€çµ‚è¬ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚\n\n\nã€é›†ã‚ãŸéµã€‘\n{{#1768603594197.plot_keys_text#}}\n\
            \n\nã€ç‰©èªã®çœŸç›¸ã€‘\n{{#1768602757091.final_reveal#}}\n\n\nã€ãƒ¡ã‚¿ãƒ‘ã‚ºãƒ«ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆã€‘\n{{#1768602505042.meta_puzzle_concept#}}\n\
            \n\nã€è¨­è¨ˆåŸå‰‡ã€‘\n1. å…¨ã¦ã®plot_keyã‚’ä½¿ã†ã“ã¨\n2. è§£ã‘ãŸæ™‚ã«ã€Œãã†ã„ã†ã“ã¨ã ã£ãŸã®ã‹ï¼ã€ã¨å…¨ä½“ãŒç¹‹ãŒã‚‹æ„Ÿè¦š\n3. è¬è‡ªä½“ã¯é›£ã—ã™ããªã„ï¼ˆéµã‚’ä¸¦ã¹ã‚Œã°è¦‹ãˆã¦ãã‚‹ï¼‰\n\
            4. çœŸç›¸ãŒæ•™è‚²çš„ä¾¡å€¤ã‚’æŒã¤ã“ã¨\n\n\nã€å‡ºåŠ›å½¢å¼ã€‘JSON\n{\n  \"meta_puzzle\": {\n    \"inputs\"\
            : [\"S1ã®éµ\", \"S2ã®éµ\", ...],\n    \"prompt\": \"æœ€çµ‚è¬ã®å‡ºé¡Œæ–‡ï¼ˆ50-100å­—ï¼‰\",\n\
            \    \"answer\": \"æœ€çµ‚çš„ãªç­”ãˆ\",\n    \"solution_steps\": [\n      \"ã‚¹ãƒ†ãƒƒãƒ—1\"\
            ,\n      \"ã‚¹ãƒ†ãƒƒãƒ—2\",\n      \"ã‚¹ãƒ†ãƒƒãƒ—3\"\n    ],\n    \"explanation\": \"\
            çœŸç›¸ã¨ã®æ¥ç¶šèª¬æ˜ï¼ˆ2-3æ–‡ï¼‰\"\n  }\n}"
        selected: false
        title: LLM_ãƒ¡ã‚¿ãƒ‘ã‚ºãƒ«ç”Ÿæˆ
        type: llm
        vision:
          enabled: false
      height: 88
      id: '1768603666915'
      position:
        x: 4618.539442266502
        y: 302.04736200195606
      positionAbsolute:
        x: 4618.539442266502
        y: 302.04736200195606
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        code: "import json\nimport re\n\ndef main(llm_output: str) -> dict:\n    json_match\
          \ = re.search(r'\\{[\\s\\S]*\\}', llm_output)\n    if json_match:\n    \
          \    try:\n            data = json.loads(json_match.group())\n         \
          \   meta = data.get(\"meta_puzzle\", data)\n            \n            return\
          \ {\n                \"meta_puzzle_json\": json.dumps(meta, ensure_ascii=False),\n\
          \                \"meta_prompt\": meta.get(\"prompt\", \"\"),\n        \
          \        \"meta_answer\": meta.get(\"answer\", \"\"),\n                \"\
          meta_explanation\": meta.get(\"explanation\", \"\")\n            }\n   \
          \     except:\n            pass\n    \n    return {\n        \"meta_puzzle_json\"\
          : \"{}\",\n        \"meta_prompt\": \"ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ\",\n        \"meta_answer\"\
          : \"\",\n        \"meta_explanation\": \"\"\n    }"
        code_language: python3
        outputs:
          meta_answer:
            children: null
            type: string
          meta_explanation:
            children: null
            type: string
          meta_prompt:
            children: null
            type: string
          meta_puzzle_json:
            children: null
            type: string
        selected: false
        title: CODE_ãƒ¡ã‚¿ãƒ‘ã‚ºãƒ«ç”Ÿæˆãƒ‘ãƒ¼ã‚¹
        type: code
        variables:
        - value_selector:
          - '1768603666915'
          - text
          value_type: string
          variable: llm_output
      height: 52
      id: '1768603767065'
      position:
        x: 4918.714311289415
        y: 302.04736200195606
      positionAbsolute:
        x: 4918.714311289415
        y: 302.04736200195606
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        code: "import json\n\ndef main(spot_scenes_json: str, meta_puzzle_json: str,\
          \ spot_count: int) -> dict:\n    errors = []\n    warnings = []\n    \n\
          \    try:\n        spots = json.loads(spot_scenes_json)\n        meta =\
          \ json.loads(meta_puzzle_json)\n    except:\n        return {\n        \
          \    \"validation_passed\": False,\n            \"errors_text\": \"JSONãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—\"\
          ,\n            \"warnings_text\": \"\",\n            \"quality_score\":\
          \ 0\n        }\n    \n    # ã‚¹ãƒãƒƒãƒˆæ•°ãƒã‚§ãƒƒã‚¯\n    if len(spots) < int(spot_count):\n\
          \        errors.append(f\"ã‚¹ãƒãƒƒãƒˆæ•°ãŒä¸è¶³: {len(spots)} / {spot_count}\")\n   \
          \ \n    # å„ã‚¹ãƒãƒƒãƒˆæ¤œè¨¼\n    for scene in spots:\n        spot_id = scene.get('spot_id',\
          \ 'unknown')\n        \n        # player_handoutãƒã‚§ãƒƒã‚¯\n        handout =\
          \ scene.get('lore_card', {}).get('player_handout', '')\n        if len(handout)\
          \ < 30:\n            warnings.append(f\"{spot_id}: player_handoutãŒçŸ­ã„\")\n\
          \        \n        # ç­”ãˆãƒã‚§ãƒƒã‚¯\n        answer = scene.get('puzzle', {}).get('answer',\
          \ '')\n        if not answer:\n            errors.append(f\"{spot_id}: ç­”ãˆãŒãªã„\"\
          )\n        \n        # plot_keyãƒã‚§ãƒƒã‚¯\n        plot_key = scene.get('reward',\
          \ {}).get('plot_key', '')\n        if not plot_key:\n            errors.append(f\"\
          {spot_id}: plot_keyãŒãªã„\")\n    \n    # ãƒ¡ã‚¿ãƒ‘ã‚ºãƒ«ãƒã‚§ãƒƒã‚¯\n    if not meta.get('answer'):\n\
          \        errors.append(\"ãƒ¡ã‚¿ãƒ‘ã‚ºãƒ«ã®ç­”ãˆãŒãªã„\")\n    \n    # ã‚¹ã‚³ã‚¢è¨ˆç®—\n    score =\
          \ 100 - (len(errors) * 20) - (len(warnings) * 5)\n    score = max(0, score)\n\
          \    \n    return {\n        \"validation_passed\": len(errors) == 0,\n\
          \        \"errors_text\": \"\\n\".join(errors) if errors else \"ãªã—\",\n\
          \        \"warnings_text\": \"\\n\".join(warnings) if warnings else \"ãªã—\"\
          ,\n        \"quality_score\": score\n    }"
        code_language: python3
        outputs:
          errors_text:
            children: null
            type: string
          quality_score:
            children: null
            type: number
          validation_passed:
            children: null
            type: boolean
          warnings_text:
            children: null
            type: string
        selected: false
        title: CODE_æ¤œè¨¼
        type: code
        variables:
        - value_selector:
          - '1768603594197'
          - spot_scenes_json
          value_type: string
          variable: spot_scenes_json
        - value_selector:
          - '1768603767065'
          - meta_puzzle_json
          value_type: string
          variable: meta_puzzle_json
        - value_selector:
          - '1768558472266'
          - spot_count
          value_type: number
          variable: spot_count
      height: 52
      id: '1768603843069'
      position:
        x: 5220.714311289415
        y: 302.04736200195606
      positionAbsolute:
        x: 5220.714311289415
        y: 302.04736200195606
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        context:
          enabled: false
          variable_selector: []
        model:
          completion_params:
            max_output_tokens: 8192
            temperature: 0.3
            thinking_level: Low
          mode: chat
          name: gemini-3-flash-preview
          provider: langgenius/gemini/google
        prompt_template:
        - id: 957b4dd1-bae4-4b16-bab2-8583c9e68797
          role: system
          text: 'ã‚ãªãŸã¯å‘¨éŠå‹ã‚¯ã‚¨ã‚¹ãƒˆã®ç´¹ä»‹æ–‡ãƒ©ã‚¤ã‚¿ãƒ¼ã§ã™ã€‚


            ã€åŒ—æ¥µæ˜Ÿã€‘è¡—ãŒä¸»å½¹ã€ç‰©èªãŒãƒ¬ãƒ³ã‚ºã€è¬ãŒå‹•æ©Ÿ


            ã€ä¼ãˆã‚‹ã¹ãã¯4ã¤ã ã‘ã€‘

            1. ã‚ãªãŸã¯èª°ã¨ã—ã¦æ­©ãã‹ï¼ˆå½¹å‰²ï¼‰

            2. ä½•ã‚’é”æˆã™ã‚‹ã¨æ°—æŒã¡ã„ã„ã‹ï¼ˆå ±é…¬ï¼‰

            3. ã©ã‚“ãªç©ºæ°—ã®ç‰©èªã‹ï¼ˆãƒˆãƒ¼ãƒ³ï¼‰

            4. ã©ã‚Œãã‚‰ã„ã®è² è·ã‹ï¼ˆæ™‚é–“/è·é›¢/é›£æ˜“åº¦ï¼‰


            ã€çµ¶å¯¾ã«è¨€ã‚ãªã„æ–¹ãŒã„ã„ã‚‚ã®ã€‘

            - ã©ã“ã§ä½•ãŒèµ·ãã‚‹ã‹ï¼ˆè»¢æ›ç‚¹ã®å ´æ‰€ï¼‰

            - çŠ¯äºº/çœŸç›¸ã®ç¤ºå”†

            - é©šããƒã‚¤ãƒ³ãƒˆã®åˆ—æŒ™


            ä»£ã‚ã‚Šã«ã€Œç´„æŸï¼ˆPromiseï¼‰ã€ã ã‘ç½®ãã€‚

            ä¾‹ï¼šã€Œæœ€å¾Œã«ã“ã®åƒã®æ„å‘³ãŒæ›´æ–°ã•ã‚Œã‚‹ã€


            å‡ºåŠ›ã¯å¿…ãšJSONå½¢å¼ã§ã€‚'
        - id: 7e53383b-10a8-4410-9bd8-72d951a5c735
          role: user
          text: "ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å½¹å‰²ã€‘\n{{#1768599287614.player_role#}}\n\nã€ä½“é¨“ã®ç´„æŸã€‘\n{{#1768599287614.experience_promise#}}\n\
            \nã€é›°å›²æ°—ã€‘\n{{#1768599287614.atmosphere_tone#}}\n\nã€ç‰©èªã®å°å…¥ã€‘\n{{#1768602757091.premise#}}\n\
            \nã€ã‚¹ãƒãƒƒãƒˆæƒ…å ±ã€‘\n{{#1768603594197.spots_summary#}}\n\nã€ãƒ«ãƒ¼ãƒˆæƒ…å ±ã€‘\nç·è·é›¢: {{#1768602131448.total_distance_m#}}m\n\
            æ­©è¡Œæ™‚é–“: {{#1768602131448.walking_time_min#}}åˆ†\nã‚¹ãƒãƒƒãƒˆæ•°: {{#1768558472266.spot_count#}}ç®‡æ‰€\n\
            é›£æ˜“åº¦: {{#1768558472266.difficulty#}}\n\n\nã€å‡ºåŠ›å½¢å¼ã€‘JSON\n{\n  \"title\": \"\
            ã‚¯ã‚¨ã‚¹ãƒˆã‚¿ã‚¤ãƒˆãƒ«ï¼ˆ10å­—ä»¥å†…ã€é­…åŠ›çš„ã«ï¼‰\",\n  \"subtitle\": \"ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆ20å­—ä»¥å†…ï¼‰\",\n  \"one_liner\"\
            : \"30ã€œ45æ–‡å­—ã®ã‚­ãƒ£ãƒƒãƒã‚³ãƒ”ãƒ¼ï¼ˆç´„æŸã‚’å«ã‚ã‚‹ï¼‰\",\n  \"premise_short\": \"100ã€œ150å­—ã®ã‚ã‚‰ã™ã˜ï¼ˆãƒã‚¿ãƒãƒ¬ãªã—ã€æœŸå¾…ã ã‘ï¼‰\"\
            ,\n  \n  \"four_things\": {\n    \"role\": \"ã‚ãªãŸã¯ã€‡ã€‡ã¨ã—ã¦æ­©ãï¼ˆ1æ–‡ï¼‰\",\n    \"\
            reward\": \"æœ€å¾Œã«ã€‡ã€‡ãŒæ˜ã‚‰ã‹ã«ãªã‚‹ï¼ˆ1æ–‡ï¼‰\",\n    \"tone\": \"ã“ã®ç‰©èªã®ç©ºæ°—ã‚’è¡¨ã™è¨€è‘‰ï¼ˆ3èªï¼‰\",\n\
            \    \"effort\": {\n      \"time\": \"æ¨å®šæ‰€è¦æ™‚é–“ï¼ˆã€‡ã€‡åˆ†ï¼‰\",\n      \"distance\"\
            : \"è·é›¢ï¼ˆã€‡ã€‡kmï¼‰\",\n      \"difficulty\": \"é›£æ˜“åº¦ï¼ˆåˆå¿ƒè€…å‘ã‘/æ™®é€š/æœ¬æ ¼æ´¾ï¼‰\",\n      \"\
            safety_note\": \"æ³¨æ„äº‹é …ï¼ˆ1æ–‡ã€ã‚ã‚Œã°ï¼‰\"\n    }\n  },\n  \n  \"teasers\": [\n \
            \   \"æœŸå¾…ã‚’é«˜ã‚ã‚‹1æ–‡ç›®ï¼ˆå ´æ‰€åãªã—ï¼‰\",\n    \"æœŸå¾…ã‚’é«˜ã‚ã‚‹2æ–‡ç›®ï¼ˆå ´æ‰€åãªã—ï¼‰\",\n    \"æœŸå¾…ã‚’é«˜ã‚ã‚‹3æ–‡ç›®ï¼ˆå ´æ‰€åãªã—ï¼‰\"\
            \n  ],\n  \n  \"route_meta\": {\n    \"area_name\": \"ã‚¨ãƒªã‚¢å\",\n    \"\
            distance_km\": \"è·é›¢km\",\n    \"estimated_time_min\": æ‰€è¦æ™‚é–“ï¼ˆæ•°å­—ï¼‰,\n    \"\
            spots_count\": ã‚¹ãƒãƒƒãƒˆæ•°ï¼ˆæ•°å­—ï¼‰,\n    \"difficulty_label\": \"é›£æ˜“åº¦ãƒ©ãƒ™ãƒ«\"\n  },\n\
            \  \n  \"tags\": [\"ã‚¿ã‚°1\", \"ã‚¿ã‚°2\", \"ã‚¿ã‚°3\"],\n  \n  \"cta_copy\": {\n\
            \    \"primary\": \"å†’é™ºã‚’å§‹ã‚ã‚‹\",\n    \"secondary\": \"è©³ã—ãè¦‹ã‚‹\"\n  }\n}"
        selected: false
        title: LLM_ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆ
        type: llm
        vision:
          enabled: false
      height: 88
      id: '1768603963490'
      position:
        x: 5616.887974994035
        y: 302.04736200195606
      positionAbsolute:
        x: 5616.887974994035
        y: 302.04736200195606
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        code: "import json\nimport re\n\ndef main(llm_output: str) -> dict:\n    json_match\
          \ = re.search(r'\\{[\\s\\S]*\\}', llm_output)\n    if json_match:\n    \
          \    try:\n            preview = json.loads(json_match.group())\n      \
          \      return {\n                \"player_preview_json\": json.dumps(preview,\
          \ ensure_ascii=False),\n                \"quest_title\": preview.get(\"\
          title\", \"ç„¡é¡Œã®ã‚¯ã‚¨ã‚¹ãƒˆ\"),\n                \"one_liner\": preview.get(\"one_liner\"\
          , \"\"),\n                \"trailer\": preview.get(\"trailer\", \"\")\n\
          \            }\n        except:\n            pass\n    \n    return {\n\
          \        \"player_preview_json\": \"{}\",\n        \"quest_title\": \"ç„¡é¡Œã®ã‚¯ã‚¨ã‚¹ãƒˆ\"\
          ,\n        \"one_liner\": \"\",\n        \"trailer\": \"\"\n    }"
        code_language: python3
        outputs:
          one_liner:
            children: null
            type: string
          player_preview_json:
            children: null
            type: string
          quest_title:
            children: null
            type: string
          trailer:
            children: null
            type: string
        selected: false
        title: CODE_ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆãƒ‘ãƒ¼ã‚¹
        type: code
        variables:
        - value_selector:
          - '1768603963490'
          - text
          value_type: string
          variable: llm_output
      height: 52
      id: '1768604146459'
      position:
        x: 5967.9501944221265
        y: 302.04736200195606
      positionAbsolute:
        x: 5967.9501944221265
        y: 302.04736200195606
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        outputs:
        - value_selector:
          - '1768605957312'
          - output_json
          value_type: string
          variable: result
        selected: false
        title: å‡ºåŠ›
        type: end
      height: 88
      id: '1768604222640'
      position:
        x: 6659.542464558915
        y: 302.04736200195606
      positionAbsolute:
        x: 6659.542464558915
        y: 302.04736200195606
      selected: true
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        code: "import json\nfrom datetime import datetime\nfrom urllib.parse import\
          \ quote\n\ndef main(\n    player_preview_json: str,\n    quest_title: str,\n\
          \    premise: str,\n    goal: str,\n    mystery: str,\n    final_reveal:\
          \ str,\n    spot_scenes_json: str,\n    meta_puzzle_json: str,\n    optimized_spots_json:\
          \ str,\n    original_spots_json: str,\n    validation_passed: bool,\n  \
          \  quality_score: int\n) -> dict:\n    \n    # JSONãƒ‘ãƒ¼ã‚¹\n    try:\n     \
          \   player_preview = json.loads(player_preview_json)\n        spot_scenes\
          \ = json.loads(spot_scenes_json)\n        meta_puzzle = json.loads(meta_puzzle_json)\n\
          \        optimized_spots = json.loads(optimized_spots_json)\n        original_spots\
          \ = json.loads(original_spots_json) if original_spots_json else []\n   \
          \ except:\n        return {\n            \"output_json\": \"{}\",\n    \
          \        \"error\": \"JSONãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ\"\n        }\n    \n    # Google Mapsã‹ã‚‰ã®å…ƒãƒ‡ãƒ¼ã‚¿ã‚’è¤‡æ•°ã‚­ãƒ¼ã§ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŒ–ï¼ˆæœ€å„ªå…ˆï¼‰\n\
          \    spots_by_id = {}\n    spots_by_name = {}\n    \n    # ã¾ãšå…ƒãƒ‡ãƒ¼ã‚¿ã§ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ§‹ç¯‰\n\
          \    for i, spot in enumerate(original_spots):\n        sid = spot.get('spot_id',\
          \ f'S{i+1}')\n        name = spot.get('name', '')\n        spots_by_id[sid]\
          \ = spot\n        if name:\n            spots_by_name[name] = spot\n   \
          \ \n    # optimized_spotsã§ã‚‚æ§‹ç¯‰ï¼ˆå…ƒãƒ‡ãƒ¼ã‚¿ã«ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰\n    for i, spot in enumerate(optimized_spots):\n\
          \        sid = spot.get('spot_id', f'S{i+1}')\n        name = spot.get('name',\
          \ '')\n        if sid not in spots_by_id:\n            spots_by_id[sid]\
          \ = spot\n        if name and name not in spots_by_name:\n            spots_by_name[name]\
          \ = spot\n    \n    # ã‚¹ãƒãƒƒãƒˆã‚·ãƒ¼ãƒ³ã«åº§æ¨™ã¨Google Maps URLã‚’è¿½åŠ \n    matched_count =\
          \ 0\n    for scene in spot_scenes:\n        spot_id = scene.get('spot_id',\
          \ '')\n        spot_name = scene.get('spot_name', '')\n        matched_spot\
          \ = None\n        \n        # å„ªå…ˆé †ä½1: spot_idã§ãƒãƒƒãƒãƒ³ã‚°\n        if spot_id in\
          \ spots_by_id:\n            matched_spot = spots_by_id[spot_id]\n      \
          \  # å„ªå…ˆé †ä½2: spot_nameã§ãƒãƒƒãƒãƒ³ã‚°\n        elif spot_name in spots_by_name:\n\
          \            matched_spot = spots_by_name[spot_name]\n        \n       \
          \ if matched_spot:\n            matched_count += 1\n            lat = matched_spot.get('lat',\
          \ 0)\n            lng = matched_spot.get('lng', 0)\n            place_id\
          \ = matched_spot.get('place_id', '')\n            original_name = matched_spot.get('name',\
          \ spot_name)\n            address = matched_spot.get('address', '')\n  \
          \          google_maps_url = matched_spot.get('google_maps_url', '')\n \
          \           \n            scene['lat'] = float(lat) if lat else 0.0\n  \
          \          scene['lng'] = float(lng) if lng else 0.0\n            scene['place_id']\
          \ = place_id\n            scene['address'] = address\n            scene['name']\
          \ = original_name\n            scene['spot_name'] = original_name\n    \
          \        \n            # Google Maps URLï¼ˆå…ƒãƒ‡ãƒ¼ã‚¿ã«ã‚ã‚Œã°ãã‚Œã‚’ä½¿ç”¨ï¼‰\n            if\
          \ google_maps_url:\n                scene['google_maps_url'] = google_maps_url\n\
          \            elif place_id:\n                scene['google_maps_url'] =\
          \ f'https://www.google.com/maps/search/?api=1&query={quote(original_name)}&query_place_id={place_id}'\n\
          \            elif lat and lng:\n                scene['google_maps_url']\
          \ = f'https://www.google.com/maps/search/?api=1&query={lat},{lng}'\n   \
          \         else:\n                scene['google_maps_url'] = f'https://www.google.com/maps/search/?api=1&query={quote(spot_name)}'\n\
          \        else:\n            # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šåº§æ¨™ãŒãªã„å ´åˆ\n            scene['lat']\
          \ = float(scene.get('lat', 0)) if scene.get('lat') else 0.0\n          \
          \  scene['lng'] = float(scene.get('lng', 0)) if scene.get('lng') else 0.0\n\
          \            scene['google_maps_url'] = f'https://www.google.com/maps/search/?api=1&query={quote(spot_name)}'\n\
          \    \n    # creator_payloadæ§‹ç¯‰\n    creator_payload = {\n        \"quest_id\"\
          : f\"quest-{int(datetime.now().timestamp())}\",\n        \"quest_title\"\
          : quest_title,\n        \"main_plot\": {\n            \"premise\": premise,\n\
          \            \"goal\": goal,\n            \"antagonist_or_mystery\": mystery,\n\
          \            \"final_reveal_outline\": final_reveal\n        },\n      \
          \  \"spots\": spot_scenes,\n        \"meta_puzzle\": meta_puzzle,\n    \
          \    \"generation_metadata\": {\n            \"generated_at\": datetime.now().isoformat(),\n\
          \            \"pipeline_version\": \"3.0.0-dify\",\n            \"validation_passed\"\
          : validation_passed,\n            \"quality_score\": quality_score,\n  \
          \          \"spots_count\": len(spot_scenes),\n            \"original_spots_count\"\
          : len(original_spots),\n            \"coords_matched\": matched_count,\n\
          \            \"coords_match_rate\": round(matched_count / len(spot_scenes)\
          \ * 100, 1) if spot_scenes else 0\n        }\n    }\n    \n    # æœ€çµ‚å‡ºåŠ›\n\
          \    output = {\n        \"player_preview\": player_preview,\n        \"\
          creator_payload\": creator_payload\n    }\n    \n    return {\n        \"\
          output_json\": json.dumps(output, ensure_ascii=False, indent=2)\n    }"
        code_language: python3
        outputs:
          output_json:
            children: null
            type: string
        selected: false
        title: CODE_å‡ºåŠ›çµåˆ
        type: code
        variables:
        - value_selector:
          - '1768604146459'
          - player_preview_json
          value_type: string
          variable: player_preview_json
        - value_selector:
          - '1768604146459'
          - quest_title
          value_type: string
          variable: quest_title
        - value_selector:
          - '1768602757091'
          - premise
          value_type: string
          variable: premise
        - value_selector:
          - '1768602757091'
          - goal
          value_type: string
          variable: goal
        - value_selector:
          - '1768602757091'
          - mystery
          value_type: string
          variable: mystery
        - value_selector:
          - '1768602757091'
          - final_reveal
          value_type: string
          variable: final_reveal
        - value_selector:
          - '1768603594197'
          - spot_scenes_json
          value_type: string
          variable: spot_scenes_json
        - value_selector:
          - '1768603767065'
          - meta_puzzle_json
          value_type: string
          variable: meta_puzzle_json
        - value_selector:
          - '1768602131448'
          - optimized_spots_json
          value_type: string
          variable: optimized_spots_json
        - value_selector:
          - '1768601299799'
          - spots_json
          value_type: string
          variable: original_spots_json
        - value_selector:
          - '1768603843069'
          - validation_passed
          value_type: boolean
          variable: validation_passed
        - value_selector:
          - '1768603843069'
          - quality_score
          value_type: number
          variable: quality_score
      height: 52
      id: '1768605957312'
      position:
        x: 6324.747432382666
        y: 302.04736200195606
      positionAbsolute:
        x: 6324.747432382666
        y: 302.04736200195606
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    viewport:
      x: -1540.7884463624446
      y: 156.45346279030696
      zoom: 0.3630375214834998
  rag_pipeline_variables: []
