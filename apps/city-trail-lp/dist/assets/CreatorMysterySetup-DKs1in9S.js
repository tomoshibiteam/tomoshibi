import{u as P,a as z,r as o,j as e,s as S}from"./index-VJX5zWq_.js";import{A as D,M as T,u as F,b as R,a as U}from"./index.modern-DWtZusUZ.js";import{T as $}from"./TomoshibiLogo-BVN6SfG2.js";import{P as B}from"./PlaceAutocompleteInput-CVP4LFoI.js";import{U as O}from"./upload-cJ4x7Dhz.js";import{X as Q}from"./x-DLcRSZaz.js";import{L as K}from"./loader-circle-lzbaSVFX.js";import{c as Y}from"./createLucideIcon-Dxvw1eg7.js";/**
 * @license lucide-react v0.554.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const G=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]],H=Y("image",G),V="AIzaSyBR6o-tY4ewZA-FJigO1FoSE5FAEouYGcs",Z=({mapCenter:b,onMapClick:x,onReverseGeocode:m})=>{const c=F(),d=R("geocoding"),[h,j]=o.useState(!0),n=o.useRef(null);return o.useEffect(()=>{if(!c||!d)return;const p=new d.Geocoder,g=c.addListener("click",v=>{if(v.latLng){const N=v.latLng.lat(),k=v.latLng.lng();x(N,k),n.current&&clearTimeout(n.current),n.current=setTimeout(()=>{p.geocode({location:{lat:N,lng:k}},(y,f)=>{if(f==="OK"&&y&&y.length>0){let l="";for(const u of y){for(const a of u.address_components){if(a.types.includes("locality")){l=a.long_name;break}a.types.includes("sublocality_level_1")&&!l&&(l=a.long_name),a.types.includes("administrative_area_level_2")&&!l&&(l=a.long_name)}if(l)break}const w=l||y[0].formatted_address;m(w)}})},100)}});return()=>{g.remove(),n.current&&clearTimeout(n.current)}},[c,d,x,m]),e.jsx(e.Fragment,{children:h&&e.jsx(U,{position:b,children:e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-brand-gold border-3 border-white shadow-xl flex items-center justify-center",style:{animation:"markerPulse 2s ease-in-out infinite"},children:e.jsx("div",{className:"w-3 h-3 rounded-full bg-white"})}),e.jsx("div",{className:"absolute -bottom-1 left-1/2 -translate-x-1/2 w-6 h-2 bg-black/20 rounded-full blur-sm",style:{animation:"shadowPulse 2s ease-in-out infinite"}})]})})})};function ne(){const b=P(),{user:x}=z(),[m,c]=o.useState(""),[d,h]=o.useState(""),[j,n]=o.useState(""),[p,g]=o.useState({lat:35.6804,lng:139.769}),[v,N]=o.useState([]),[k,y]=o.useState(!1),[f,l]=o.useState(!1),[w,u]=o.useState(null),[a,J]=o.useState(localStorage.getItem("quest-id")),[_,I]=o.useState(""),[C,q]=o.useState(!1);o.useRef(null);const M=o.useRef(null);o.useEffect(()=>{if(console.log("[Mystery Setup] useEffect triggered, questId:",a),!a){console.log("[Mystery Setup] No questId, skipping load");return}const t=localStorage.getItem(`quest-init-status:${a}`);if(console.log("[Mystery Setup] Init status:",t),t==="pending"){console.log("[Mystery Setup] New quest, clearing fields"),c(""),h(""),n(""),g({lat:35.6804,lng:139.769}),localStorage.setItem(`quest-init-status:${a}`,"done");return}(async()=>{console.log("[Mystery Setup] Loading quest from DB, id:",a);const{data:s,error:i}=await S.from("quests").select("*").eq("id",a).maybeSingle();if(console.log("[Mystery Setup] DB response:",{data:s,error:i}),i){console.warn("[Mystery Setup] Quest fetch error:",i);return}s?(console.log("[Mystery Setup] Setting fields from data:",{title:s.title,description:s.description,area_name:s.area_name}),c(s.title||""),h(s.description||""),n(s.area_name||""),I(s.cover_image_url||""),s.location_lat&&s.location_lng&&g({lat:s.location_lat,lng:s.location_lng})):console.log("[Mystery Setup] No data found for questId:",a)})()},[a]);const E=async t=>{if(!(!a||!x)){q(!0);try{const r=t.name.split(".").pop(),s=`${a}/cover.${r}`,{error:i}=await S.storage.from("quest-images").upload(s,t,{upsert:!0});if(i)throw i;const{data:{publicUrl:A}}=S.storage.from("quest-images").getPublicUrl(s);I(A)}catch(r){console.error("Image upload failed:",r),u("ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ")}finally{q(!1)}}},L=async t=>{if(console.log("[Mystery Setup] handleSave called with status:",t),!x){u("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");return}if(!a){u("ã‚¯ã‚¨ã‚¹ãƒˆIDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");return}u(null),l(!0);const r={id:a,creator_id:x.id,title:m,description:d,area_name:j,location_lat:p.lat,location_lng:p.lng,cover_image_url:_,updated_at:new Date().toISOString(),created_at:new Date().toISOString()};console.log("[Mystery Setup] Data to save:",r);try{const{data:s,error:i}=await S.from("quests").upsert(r,{onConflict:"id"}).select();if(console.log("[Mystery Setup] Save response:",{data:s,error:i}),i)throw i;localStorage.setItem(`step-status:${a}:1`,t),console.log("[Mystery Setup] Save successful, navigating to workspace"),b("/creator/workspace")}catch(s){console.error("[Mystery Setup] Error saving quest:",s),u("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: "+(s.message||"ä¸æ˜ãªã‚¨ãƒ©ãƒ¼"))}finally{l(!1)}};return e.jsx(D,{apiKey:V,children:e.jsxs("section",{className:"min-h-screen bg-stone-50 flex flex-col",children:[e.jsx("div",{className:"bg-white/80 backdrop-blur-md border-b border-stone-200 sticky top-0 z-50",children:e.jsxs("div",{className:"container mx-auto px-4 md:px-8 py-3 flex items-center justify-between",children:[e.jsx("button",{onClick:()=>b("/"),className:"hover:opacity-80 transition-opacity",children:e.jsx($,{className:"h-7 w-auto"})}),e.jsxs("div",{className:"flex items-center gap-4 text-xs font-bold text-stone-400",children:[e.jsx("span",{className:"text-brand-dark px-2 py-1 bg-brand-gold/10 rounded",children:"Step 1: Basics"}),e.jsx("span",{children:"â€º"}),e.jsx("span",{children:"Step 2: Spots"}),e.jsx("span",{children:"â€º"}),e.jsx("span",{children:"Step 3: Story"})]})]})}),e.jsxs("div",{className:"flex-1 grid lg:grid-cols-12 min-h-0 bg-stone-50",children:[e.jsx("div",{className:"lg:col-span-5 xl:col-span-4 bg-white border-r border-stone-200 shadow-xl z-10 flex flex-col h-[calc(100vh-64px)] overflow-hidden",children:e.jsxs("div",{className:"p-6 md:p-8 overflow-y-auto flex-1 custom-scrollbar",children:[e.jsxs("button",{onClick:()=>b("/creator/workspace"),className:"text-xs font-bold text-stone-500 hover:text-brand-dark flex items-center gap-1 mb-6 transition-colors",children:[e.jsx("span",{className:"text-lg",children:"â€¹"})," Back to Workspace"]}),e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-3xl font-serif font-bold text-brand-dark mb-2",children:"åŸºæœ¬æƒ…å ±ã‚’å…¥åŠ›"}),e.jsx("p",{className:"text-sm text-stone-500 leading-relaxed",children:"ã‚¯ã‚¨ã‚¹ãƒˆã®ç¬¬ä¸€æ­©ã§ã™ã€‚èˆå°ã¨ãªã‚‹ã‚¨ãƒªã‚¢ã¨ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æƒ¹ãã¤ã‘ã‚‹ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ±ºã‚ã¾ã—ã‚‡ã†ã€‚"})]}),e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"space-y-2 group",children:[e.jsxs("label",{className:"text-sm font-bold text-brand-dark flex items-center gap-2",children:["é–‹å‚¬ã‚¨ãƒªã‚¢ ",e.jsx("span",{className:"text-[10px] text-rose-500 font-bold bg-rose-50 px-2 py-0.5 rounded-full",children:"å¿…é ˆ"})]}),e.jsxs("div",{className:"relative transition-all group-focus-within:ring-4 ring-brand-gold/10 rounded-xl",children:[e.jsx(B,{value:j,onPlaceSelect:t=>{var r;t.formatted_address&&n(t.formatted_address),(r=t.geometry)!=null&&r.location&&g({lat:t.geometry.location.lat(),lng:t.geometry.location.lng()}),N([])},placeholder:"éƒ½å¸‚åãƒ»é§…åã§æ¤œç´¢...",className:"w-full px-4 py-4 rounded-xl border-2 border-stone-100 bg-stone-50 text-sm font-bold text-brand-dark placeholder:text-stone-400 focus:outline-none focus:border-brand-gold/50 focus:bg-white transition-all shadow-sm"}),e.jsx("div",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-stone-400 pointer-events-none",children:"ğŸ”"})]}),e.jsx("p",{className:"text-[10px] text-stone-400 pl-1",children:"â€» åœ°å›³ä¸Šã®ã‚¯ãƒªãƒƒã‚¯ã§ã‚‚å ´æ‰€ã‚’æŒ‡å®šãƒ»ä¿®æ­£ã§ãã¾ã™"})]}),e.jsxs("div",{className:"space-y-2 group",children:[e.jsxs("label",{className:"text-sm font-bold text-brand-dark flex items-center gap-2",children:["ã‚¯ã‚¨ã‚¹ãƒˆå ",e.jsx("span",{className:"text-[10px] text-rose-500 font-bold bg-rose-50 px-2 py-0.5 rounded-full",children:"å¿…é ˆ"})]}),e.jsx("input",{type:"text",value:m,onChange:t=>c(t.target.value),placeholder:"ä¾‹ï¼šå¤éƒ½ã®å½±ã¨æ¶ˆãˆãŸæ™‚è¨ˆå°",className:"w-full px-4 py-4 rounded-xl border-2 border-stone-100 bg-stone-50 text-sm font-bold text-brand-dark placeholder:text-stone-400 focus:outline-none focus:border-brand-gold/50 focus:bg-white focus:ring-4 ring-brand-gold/10 transition-all shadow-sm"})]}),e.jsxs("div",{className:"space-y-2 group",children:[e.jsxs("label",{className:"text-sm font-bold text-brand-dark flex items-center gap-2",children:["å°å…¥ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ ",e.jsx("span",{className:"text-[10px] text-rose-500 font-bold bg-rose-50 px-2 py-0.5 rounded-full",children:"å¿…é ˆ"})]}),e.jsx("textarea",{value:d,onChange:t=>h(t.target.value),rows:4,placeholder:"100å¹´å‰ã‹ã‚‰ä¼ã‚ã‚‹å¥‡å¦™ãªå™‚...",className:"w-full px-4 py-4 rounded-xl border-2 border-stone-100 bg-stone-50 text-sm leading-relaxed text-brand-dark placeholder:text-stone-400 focus:outline-none focus:border-brand-gold/50 focus:bg-white focus:ring-4 ring-brand-gold/10 transition-all shadow-sm resize-none"})]}),e.jsxs("div",{className:"space-y-2 group",children:[e.jsxs("label",{className:"text-sm font-bold text-brand-dark flex items-center gap-2",children:["ã‚«ãƒãƒ¼ç”»åƒ ",e.jsx("span",{className:"text-[10px] text-stone-400 font-normal bg-stone-100 px-2 py-0.5 rounded-full",children:"ä»»æ„"})]}),e.jsx("input",{type:"file",ref:M,accept:"image/*",className:"hidden",onChange:t=>{var s;const r=(s=t.target.files)==null?void 0:s[0];r&&E(r)}}),_?e.jsxs("div",{className:"relative rounded-xl overflow-hidden border-2 border-stone-100",children:[e.jsx("img",{src:_,alt:"Cover",className:"w-full aspect-video object-cover"}),e.jsxs("div",{className:"absolute top-2 right-2 flex gap-2",children:[e.jsx("button",{onClick:()=>{var t;return(t=M.current)==null?void 0:t.click()},className:"p-2 rounded-lg bg-white/90 backdrop-blur text-stone-600 hover:bg-white transition-colors shadow-sm",children:e.jsx(O,{size:16})}),e.jsx("button",{onClick:()=>I(""),className:"p-2 rounded-lg bg-white/90 backdrop-blur text-rose-500 hover:bg-white transition-colors shadow-sm",children:e.jsx(Q,{size:16})})]})]}):e.jsx("button",{onClick:()=>{var t;return(t=M.current)==null?void 0:t.click()},disabled:C,className:"w-full aspect-video rounded-xl border-2 border-dashed border-stone-200 bg-stone-50 hover:bg-stone-100 hover:border-brand-gold/50 transition-all flex flex-col items-center justify-center gap-3 text-stone-400 disabled:opacity-50",children:C?e.jsxs(e.Fragment,{children:[e.jsx(K,{size:32,className:"animate-spin"}),e.jsx("span",{className:"text-sm font-medium",children:"ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(H,{size:32}),e.jsx("span",{className:"text-sm font-medium",children:"ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰"}),e.jsx("span",{className:"text-xs text-stone-400",children:"æ¨å¥¨: 1200x675px (16:9)"})]})})]}),(()=>{const t=j.trim()!==""&&m.trim()!==""&&d.trim()!=="";return e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsxs("button",{onClick:()=>L("in_progress"),disabled:f,className:"flex-1 py-3 rounded-xl bg-stone-100 text-stone-700 font-bold text-sm hover:bg-stone-200 transition-all disabled:opacity-70 flex items-center justify-center gap-2",children:[f?e.jsx("span",{className:"animate-spin",children:"â³"}):null,"ä¸€æ™‚ä¿å­˜ã™ã‚‹"]}),e.jsxs("button",{onClick:()=>L("completed"),disabled:f||!t,title:t?"":"å…¨ã¦ã®å…¥åŠ›æ¬„ã‚’åŸ‹ã‚ã¦ãã ã•ã„",className:`flex-1 py-3 rounded-xl font-bold text-sm transition-all flex items-center justify-center gap-2 ${t?"bg-brand-dark text-white hover:bg-brand-gold hover:shadow-lg hover:-translate-y-0.5 disabled:opacity-70":"bg-stone-200 text-stone-400 cursor-not-allowed"}`,children:[f?e.jsx("span",{className:"animate-spin",children:"â³"}):null,"å®Œäº†ã™ã‚‹"]})]})})()]}),w&&e.jsx("div",{className:"mt-4 p-3 rounded-lg bg-red-50 text-red-600 text-xs font-bold",children:w})]})}),e.jsxs("div",{className:"lg:col-span-7 xl:col-span-8 relative bg-stone-200",children:[e.jsx(T,{mapId:"bf51a910020fa25a",defaultCenter:p,defaultZoom:11,gestureHandling:"greedy",disableDefaultUI:!1,className:"w-full h-full",children:e.jsx(Z,{mapCenter:p,onMapClick:(t,r)=>g({lat:t,lng:r}),onReverseGeocode:t=>n(t)})}),e.jsx("div",{className:"absolute top-6 left-6 right-6 pointer-events-none md:flex justify-center hidden",children:e.jsx("div",{className:"bg-white/90 backdrop-blur px-4 py-2 rounded-full shadow-lg border border-white/50",children:e.jsxs("p",{className:"text-xs font-bold text-stone-600 flex items-center gap-2",children:[e.jsx("span",{children:"ğŸ“"})," ãƒãƒƒãƒ—ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä¸­å¿ƒåœ°ã‚’èª¿æ•´ã§ãã¾ã™"]})})})]})]})]})})}export{ne as default};
