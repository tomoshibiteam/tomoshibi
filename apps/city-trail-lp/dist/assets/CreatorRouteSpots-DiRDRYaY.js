import{j as e,u as Q,r as x,s as w}from"./index-VJX5zWq_.js";import{A as X,M as Z,a as P,u as J,b as U}from"./index.modern-DWtZusUZ.js";import{T as W}from"./TomoshibiLogo-BVN6SfG2.js";import{P as ee}from"./PlaceAutocompleteInput-CVP4LFoI.js";import{A as te,m as $}from"./proxy-CrgiBIYO.js";import{T as se}from"./triangle-alert-CAxn-Gzi.js";import{X as ne}from"./x-DLcRSZaz.js";import{G as oe,T as ae}from"./trash-2-CyB3FX1s.js";import"./createLucideIcon-Dxvw1eg7.js";function re({isOpen:m,onClose:d,onConfirm:y,title:s,message:g,confirmText:u="Confirm",cancelText:b="Cancel",isDanger:h=!1}){return e.jsx(te,{children:m&&e.jsxs(e.Fragment,{children:[e.jsx($.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:d,className:"fixed inset-0 bg-black/40 backdrop-blur-sm z-[100]"}),e.jsx("div",{className:"fixed inset-0 flex items-center justify-center z-[101] pointer-events-none p-4",children:e.jsxs($.div,{initial:{opacity:0,scale:.95,y:10},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.95,y:10},className:"bg-white rounded-2xl shadow-xl w-full max-w-md pointer-events-auto overflow-hidden border border-stone-100",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-stone-100",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[h&&e.jsx("div",{className:"p-2 bg-rose-100 text-rose-600 rounded-full",children:e.jsx(se,{size:20})}),e.jsx("h3",{className:"font-bold text-lg text-stone-800",children:s})]}),e.jsx("button",{onClick:d,className:"p-1 rounded-full text-stone-400 hover:bg-stone-100 hover:text-stone-600 transition-colors",children:e.jsx(ne,{size:20})})]}),e.jsx("div",{className:"p-6",children:e.jsx("p",{className:"text-stone-600 leading-relaxed text-sm",children:g})}),e.jsxs("div",{className:"p-4 bg-stone-50 border-t border-stone-100 flex justify-end gap-3",children:[e.jsx("button",{onClick:d,className:"px-4 py-2 rounded-lg text-sm font-bold text-stone-600 hover:bg-stone-200 transition-colors",children:b}),e.jsx("button",{onClick:y,className:`px-4 py-2 rounded-lg text-sm font-bold text-white shadow-md transition-all ${h?"bg-rose-500 hover:bg-rose-600 shadow-rose-200":"bg-brand-dark hover:bg-brand-gold shadow-stone-300"}`,children:u})]})]})})]})})}const le="AIzaSyBR6o-tY4ewZA-FJigO1FoSE5FAEouYGcs",de="CAI4T7uO84K4nuLMXMVQ",ie=({routeSpots:m,selectedCoords:d,onMapClick:y})=>{const s=J(),g=U("maps"),[u,b]=x.useState(null),h=x.useRef(!1);return x.useEffect(()=>{if(!(!s||!g)){if(u)u.setPath(m.map(i=>({lat:i.lat,lng:i.lng})));else{const i=new g.Polyline({path:m.map(c=>({lat:c.lat,lng:c.lng})),geodesic:!0,strokeColor:"#2563eb",strokeOpacity:.75,strokeWeight:4});i.setMap(s),b(i)}if(m.length>0&&!h.current){const i=new google.maps.LatLngBounds;m.forEach(c=>i.extend({lat:c.lat,lng:c.lng})),s.fitBounds(i,40),h.current=!0}return()=>{u&&m.length===0&&u.setMap(null)}}},[s,g,m,u]),x.useEffect(()=>{if(!s)return;const i=s.addListener("click",c=>{c.latLng&&y(c.latLng.lat(),c.latLng.lng())});return()=>i.remove()},[s,y]),e.jsx(e.Fragment,{children:m.map((i,c)=>e.jsx(P,{position:{lat:i.lat,lng:i.lng},title:i.name,children:e.jsx("div",{className:"w-8 h-8 rounded-full bg-brand-dark text-white text-sm font-bold flex items-center justify-center shadow-lg border-2 border-white",children:c+1})},i.id))})};function Se(){const m=Q(),[d,y]=x.useState(localStorage.getItem("quest-id")),[s,g]=x.useState([]),[u,b]=x.useState(""),[h,i]=x.useState(""),[c,k]=x.useState(null),[ce,xe]=x.useState([]),[me,pe]=x.useState(!1),[ge,A]=x.useState(!1),[I,M]=x.useState(null),[T,D]=x.useState(null),[q,_]=x.useState(!1),[E,C]=x.useState(null),[j,z]=x.useState({}),R=.5,L=async()=>{if(!d)return;A(!0);const{data:t,error:r}=await w.from("spots").select("*").eq("quest_id",d).order("order_index",{ascending:!0});if(!r&&t){g(t.map(o=>({id:o.id,name:o.name,address:o.address||"",lat:o.lat,lng:o.lng,orderIndex:o.order_index,status:o.status})));const a=t.map(o=>o.id);if(a.length>0){const{data:o}=await w.from("spot_details").select("spot_id, question_text, answer_text").in("spot_id",a),l={};o==null||o.forEach(n=>{var p,N;l[n.spot_id]=!!((p=n.question_text)!=null&&p.trim()||(N=n.answer_text)!=null&&N.trim())}),z(l)}}A(!1)};x.useEffect(()=>{if(!d)return;if(localStorage.getItem(`quest-init-status:${d}`)==="pending"){g([]),b(""),i(""),k(null),localStorage.setItem(`quest-init-status:${d}`,"done");return}L()},[d]);const O=(t,r)=>{k({lat:t,lng:r}),fetch(`https://api.maptiler.com/geocoding/${r},${t}.json?key=${de}&language=ja&limit=1`).then(a=>a.json()).then(a=>{var p;const o=(p=a==null?void 0:a.features)==null?void 0:p[0],l=o==null?void 0:o.place_name,n=o==null?void 0:o.text;l&&i(l),n&&b(n)}).catch(console.error)},F=async()=>{if(!u.trim()||!h.trim()||!c||!d)return;const t=s.length+1,r=`temp-${Date.now()}`,a={id:r,name:u.trim(),address:h.trim(),lat:c.lat,lng:c.lng,orderIndex:t};g(n=>[...n,a]),b(""),i(""),k(null);const{data:o,error:l}=await w.from("spots").insert({quest_id:d,name:a.name,address:a.address,lat:a.lat,lng:a.lng,order_index:t}).select().single();o&&g(n=>n.map(p=>p.id===r?{...p,id:o.id}:p))},K=(t,r)=>{const a=f=>f*Math.PI/180,l=a(r.lat-t.lat),n=a(r.lng-t.lng),p=a(t.lat),N=a(r.lat),S=Math.sin(l/2)*Math.sin(l/2)+Math.cos(p)*Math.cos(N)*Math.sin(n/2)*Math.sin(n/2);return 6371*(2*Math.atan2(Math.sqrt(S),Math.sqrt(1-S)))},B=t=>{C(t),_(!0)},G=async()=>{if(!E)return;const t=E;_(!1),C(null);const a=s.filter(l=>l.id!==t).map((l,n)=>({...l,orderIndex:n+1}));g(a);const{error:o}=await w.from("spots").delete().eq("id",t);if(o)console.error("Error deleting spot:",o),alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ"),L();else if(d){const l=a.map(n=>({id:n.id,quest_id:d,name:n.name,address:n.address,lat:n.lat,lng:n.lng,order_index:n.orderIndex||0}));await w.from("spots").upsert(l,{onConflict:"id"})}},Y=(t,r)=>{M(t),r.dataTransfer.effectAllowed="move"},V=(t,r)=>{r.preventDefault(),r.dataTransfer.dropEffect="move"},H=async(t,r)=>{if(r.preventDefault(),I&&I!==t){const a=I,o=t,l=[...s],n=l.findIndex(v=>v.id===a),p=l.findIndex(v=>v.id===o);if(n===-1||p===-1)return;const[N]=l.splice(n,1);l.splice(p,0,N);const S=l.map((v,f)=>({...v,orderIndex:f+1}));if(g(S),M(null),d){const v=S.map(f=>({id:f.id,quest_id:d,name:f.name,address:f.address,lat:f.lat,lng:f.lng,order_index:f.orderIndex||0}));await w.from("spots").upsert(v,{onConflict:"id"})}}};return e.jsx(X,{apiKey:le,children:e.jsxs("section",{className:"min-h-screen bg-stone-50 flex flex-col",children:[e.jsx("div",{className:"bg-white/80 backdrop-blur-md border-b border-stone-200 sticky top-0 z-50",children:e.jsxs("div",{className:"container mx-auto px-4 md:px-8 py-3 flex items-center justify-between",children:[e.jsx("button",{onClick:()=>m("/"),className:"hover:opacity-80 transition-opacity",children:e.jsx(W,{className:"h-7 w-auto"})}),e.jsxs("div",{className:"flex items-center gap-4 text-xs font-bold text-stone-400",children:[e.jsx("span",{className:"hidden md:inline",children:"Step 1: åŸºæœ¬æƒ…å ±"}),e.jsx("span",{className:"hidden md:inline",children:"â€º"}),e.jsx("span",{className:"text-brand-dark px-2 py-1 bg-brand-gold/10 rounded",children:"Step 2: ã‚¹ãƒãƒƒãƒˆ"}),e.jsx("span",{children:"â€º"}),e.jsx("span",{children:"Step 3: ã‚¹ãƒˆãƒ¼ãƒªãƒ¼"})]})]})}),e.jsxs("div",{className:"flex-1 grid lg:grid-cols-12 min-h-0 bg-stone-50 relative",children:[e.jsxs("div",{className:"lg:col-span-5 xl:col-span-4 bg-white border-r border-stone-200 shadow-xl z-20 flex flex-col h-[calc(100vh-64px)] overflow-hidden",children:[e.jsxs("div",{className:"flex-1 overflow-y-auto custom-scrollbar p-6 pb-32",children:[e.jsxs("button",{onClick:()=>m("/creator/workspace"),className:"text-xs font-bold text-stone-500 hover:text-brand-dark flex items-center gap-1 mb-6 transition-colors",children:[e.jsx("span",{className:"text-lg",children:"â€¹"})," ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã«æˆ»ã‚‹"]}),e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-3xl font-serif font-bold text-brand-dark mb-2",children:"ãƒ«ãƒ¼ãƒˆ & ã‚¹ãƒãƒƒãƒˆ"}),e.jsx("p",{className:"text-sm text-stone-500 leading-relaxed",children:"ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå·¡ã‚‹ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚é­…åŠ›çš„ãªã‚¹ãƒãƒƒãƒˆã‚’ã¤ãªãåˆã‚ã›ã€ä¸€æœ¬ã®ç·šã‚’æãã¾ã—ã‚‡ã†ã€‚"})]}),e.jsxs("div",{className:"space-y-6 relative mb-8",children:[s.length===0&&e.jsxs("div",{className:"text-center py-12 px-6 border-2 border-dashed border-stone-200 rounded-2xl bg-stone-50",children:[e.jsx("p",{className:"font-bold text-stone-400 mb-2",children:"ã‚¹ãƒãƒƒãƒˆãŒã¾ã ã‚ã‚Šã¾ã›ã‚“"}),e.jsx("p",{className:"text-xs text-stone-400",children:"ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒ ã‹åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦æœ€åˆã®ã‚¹ãƒãƒƒãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚"})]}),s.map((t,r)=>{const a=r>0?s[r-1]:null,o=a?K(a,t):0,l=a?o>R:!1;return e.jsxs("div",{draggable:!0,onDragStart:n=>Y(t.id,n),onDragOver:n=>V(t.id,n),onDrop:n=>H(t.id,n),onDragEnd:()=>M(null),onMouseEnter:()=>D(t.id),onMouseLeave:()=>D(null),className:"relative pl-6 group transition-all",children:[r<s.length-1&&e.jsx("div",{className:"absolute left-9 top-14 bottom-[-1.5rem] w-0.5 bg-stone-200 group-hover:bg-stone-300 transition-colors z-0"}),a&&e.jsxs("div",{className:`absolute -top-4 left-16 text-[10px] font-bold px-2 py-0.5 rounded-full z-10 ${l?"bg-rose-100 text-rose-600":"bg-stone-100 text-stone-500"}`,children:[o.toFixed(2)," km ",l&&"âš ï¸ è·é›¢è¶…é"]}),e.jsxs("div",{className:`relative z-10 bg-white rounded-xl border transition-all duration-200 p-2.5 flex items-center gap-2 ${T===t.id?"border-brand-gold shadow-md ring-1 ring-brand-gold/50":l?"border-rose-200 shadow-sm":"border-stone-200 shadow-sm hover:border-brand-gold/50 hover:shadow-md"}`,children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-6 h-6 rounded-full bg-brand-dark text-white text-xs font-bold flex items-center justify-center",children:r+1}),e.jsx("button",{className:"text-stone-300 hover:text-stone-500 cursor-move",children:e.jsx(oe,{size:12})})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"font-bold text-sm text-brand-dark truncate",children:t.name}),e.jsx("p",{className:"text-[10px] text-stone-400 truncate",children:t.address})]}),j[t.id]?e.jsx("span",{className:"px-1.5 py-0.5 bg-emerald-100 text-emerald-600 text-[10px] font-bold rounded",children:"âœ“æ¸ˆ"}):e.jsx("span",{className:"px-1.5 py-0.5 bg-amber-100 text-amber-600 text-[10px] font-bold rounded",children:"æœªå…¥åŠ›"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:n=>{n.stopPropagation(),m(`/creator/route-spots/${t.id}`)},className:"px-2 py-1 rounded bg-stone-100 text-stone-600 text-[10px] font-bold hover:bg-brand-gold hover:text-white transition-colors",children:"ç·¨é›†"}),e.jsx("button",{onClick:n=>{n.stopPropagation(),B(t.id)},className:"p-1 rounded text-stone-400 hover:bg-rose-50 hover:text-rose-600 transition-colors",children:e.jsx(ae,{size:12})})]})]})]},t.id)})]})]}),e.jsxs("div",{className:"border-t border-stone-200 bg-white/95 backdrop-blur-md p-3 shadow-[0_-4px_20px_rgba(0,0,0,0.05)]",children:[e.jsxs("div",{className:"flex gap-2 items-center mb-3",children:[e.jsx("input",{value:u,onChange:t=>b(t.target.value),placeholder:"ã‚¹ãƒãƒƒãƒˆå",className:"w-28 px-3 py-2 rounded-lg border border-stone-200 bg-stone-50 text-sm focus:outline-none focus:bg-white focus:border-brand-gold/50"}),e.jsx("div",{className:"flex-1",children:e.jsx(ee,{defaultValue:h,onPlaceSelect:t=>{var r;t.formatted_address&&i(t.formatted_address),t.name&&b(t.name),(r=t.geometry)!=null&&r.location&&k({lat:t.geometry.location.lat(),lng:t.geometry.location.lng()})},placeholder:"ä½æ‰€ã‚’æ¤œç´¢...",className:"w-full px-3 py-2 rounded-lg border border-stone-200 bg-stone-50 text-sm focus:outline-none focus:bg-white focus:border-brand-gold/50"})}),e.jsx("button",{onClick:F,disabled:!u.trim()||!h.trim()||!c,className:"px-3 py-2 rounded-lg bg-brand-dark text-white font-bold text-xs hover:bg-brand-gold disabled:opacity-50 transition-colors",children:"+è¿½åŠ "})]}),e.jsxs("div",{className:"flex items-center gap-4 px-2 py-1.5 bg-stone-50 rounded-lg mb-3",children:[e.jsx("span",{className:"text-[10px] font-bold text-stone-400 uppercase",children:"å®Œäº†æ¡ä»¶"}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:`w-4 h-4 rounded-full flex items-center justify-center text-[10px] ${s.length>=10?"bg-emerald-500 text-white":"border border-stone-300 text-stone-400"}`,children:s.length>=10?"âœ“":""}),e.jsxs("span",{className:`text-xs ${s.length>=10?"text-emerald-700":"text-stone-500"}`,children:["10ç®‡æ‰€ä»¥ä¸Š ",e.jsxs("span",{className:"font-mono",children:["(",s.length,"/10)"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:`w-4 h-4 rounded-full flex items-center justify-center text-[10px] ${s.length>0&&s.every(t=>j[t.id])?"bg-emerald-500 text-white":"border border-stone-300 text-stone-400"}`,children:s.length>0&&s.every(t=>j[t.id])?"âœ“":""}),e.jsxs("span",{className:`text-xs ${s.length>0&&s.every(t=>j[t.id])?"text-emerald-700":"text-stone-500"}`,children:["è©³ç´°å…¥åŠ›æ¸ˆ ",e.jsxs("span",{className:"font-mono",children:["(",s.filter(t=>j[t.id]).length,"/",s.length,")"]})]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>{d&&localStorage.setItem(`step-status:${d}:2`,"in_progress"),m("/creator/workspace")},className:"flex-1 py-2.5 rounded-lg border-2 border-brand-gold bg-white text-brand-gold font-bold text-sm hover:bg-brand-gold/5 transition-all",children:"ä¸€æ™‚ä¿å­˜ã™ã‚‹"}),e.jsx("button",{onClick:()=>{d&&localStorage.setItem(`step-status:${d}:2`,"completed"),m("/creator/workspace")},disabled:!(s.length>=10&&s.every(t=>j[t.id])),title:s.length>=10&&s.every(t=>j[t.id])?"":"å®Œäº†æ¡ä»¶ã‚’æº€ãŸã—ã¦ãã ã•ã„",className:`flex-1 py-2.5 rounded-lg font-bold text-sm transition-all ${s.length>=10&&s.every(t=>j[t.id])?"bg-brand-dark text-white hover:bg-brand-gold hover:shadow-lg":"bg-stone-200 text-stone-400 cursor-not-allowed"}`,children:"å®Œäº†ã™ã‚‹"})]})]})]}),e.jsxs("div",{className:"lg:col-span-7 xl:col-span-8 relative bg-stone-100 hidden lg:block",children:[e.jsxs(Z,{mapId:"4f910f9227657629",defaultCenter:{lat:35.6804,lng:139.769},defaultZoom:13,gestureHandling:"greedy",disableDefaultUI:!1,className:"w-full h-full",children:[e.jsx(ie,{routeSpots:s,selectedCoords:c,onMapClick:O}),c&&e.jsxs(P,{position:c,children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-brand-gold text-white text-lg font-bold flex items-center justify-center shadow-xl border-3 border-white",style:{animation:"markerAppear 0.3s ease-out, markerPulse 2s ease-in-out infinite 0.3s"},children:"+"}),e.jsx("div",{className:"absolute -bottom-1 left-1/2 -translate-x-1/2 w-6 h-2 bg-black/20 rounded-full blur-sm",style:{animation:"shadowPulse 2s ease-in-out infinite 0.3s"}})]})]}),e.jsx("div",{className:"absolute top-6 left-6 bg-white/90 backdrop-blur px-4 py-2 rounded-full shadow-lg border border-white/50 pointer-events-none",children:e.jsxs("p",{className:"text-xs font-bold text-stone-600 flex items-center gap-2",children:[e.jsx("span",{children:"ğŸ“"})," åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å ´æ‰€ã‚’é¸æŠ"]})})]})]}),e.jsx(re,{isOpen:q,onClose:()=>{_(!1),C(null)},onConfirm:G,title:"ã‚¹ãƒãƒƒãƒˆã®å‰Šé™¤",message:"ã“ã®ã‚¹ãƒãƒƒãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿå‰Šé™¤ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã¯å¾©å…ƒã§ãã¾ã›ã‚“ã€‚",confirmText:"å‰Šé™¤ã™ã‚‹",cancelText:"ã‚­ãƒ£ãƒ³ã‚»ãƒ«",isDanger:!0})]})})}export{Se as default};
