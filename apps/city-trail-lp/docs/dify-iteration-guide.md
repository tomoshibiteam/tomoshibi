# Dify ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ãƒ‰è©³ç´°ã‚¬ã‚¤ãƒ‰

## ğŸ¤” ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã¯ï¼Ÿ

**é…åˆ—ã®å„è¦ç´ ã«å¯¾ã—ã¦ã€åŒã˜å‡¦ç†ã‚’ç¹°ã‚Šè¿”ã™ãƒãƒ¼ãƒ‰**ã§ã™ã€‚

### ä¾‹ï¼šã‚¹ãƒãƒƒãƒˆé…åˆ—ã«å¯¾ã—ã¦Wikipediaæƒ…å ±ã‚’å–å¾—

```
å…¥åŠ›: [ã‚¹ãƒãƒƒãƒˆ1, ã‚¹ãƒãƒƒãƒˆ2, ã‚¹ãƒãƒƒãƒˆ3, ã‚¹ãƒãƒƒãƒˆ4, ã‚¹ãƒãƒƒãƒˆ5]

ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†:
  ã‚¹ãƒãƒƒãƒˆ1 â†’ Wikipedia APIå‘¼ã³å‡ºã— â†’ çµæœ1
  ã‚¹ãƒãƒƒãƒˆ2 â†’ Wikipedia APIå‘¼ã³å‡ºã— â†’ çµæœ2
  ã‚¹ãƒãƒƒãƒˆ3 â†’ Wikipedia APIå‘¼ã³å‡ºã— â†’ çµæœ3
  ã‚¹ãƒãƒƒãƒˆ4 â†’ Wikipedia APIå‘¼ã³å‡ºã— â†’ çµæœ4
  ã‚¹ãƒãƒƒãƒˆ5 â†’ Wikipedia APIå‘¼ã³å‡ºã— â†’ çµæœ5

å‡ºåŠ›: [çµæœ1, çµæœ2, çµæœ3, çµæœ4, çµæœ5]
```

---

## âš ï¸ é‡è¦ãªæ¨å¥¨äº‹é …

### ä»Šå›ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§ã¯ Node 2c (Wikipediaå–å¾—) ã¯ã‚¹ã‚­ãƒƒãƒ—ã‚’æ¨å¥¨

**ç†ç”±:**
1. è¨­å®šãŒè¤‡é›‘
2. ã‚¹ãƒãƒƒãƒˆåãŒæ­£ç¢ºã«Wikipediaã®è¨˜äº‹åã¨ä¸€è‡´ã—ãªã„ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹
3. LLMã§æ­´å²æƒ…å ±ã‚’ç”Ÿæˆã™ã‚‹æ–¹ãŒç°¡å˜ã§æŸ”è»Ÿ

### æ¨å¥¨ãƒ•ãƒ­ãƒ¼

```
[Node 2b: Google Places API]
         â†“
[Node 2b-parse: ã‚³ãƒ¼ãƒ‰ãƒãƒ¼ãƒ‰]  â† bodyã‚’ãƒ‘ãƒ¼ã‚¹
         â†“
[Node 2d: Theme Scoring]      â† ç›´æ¥LLMã§ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°
```

---

## ğŸ“‹ Node 2b-parse ã®å®Ÿè£…ï¼ˆå¿…é ˆï¼‰

Google Places APIã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆbodyï¼‰ã‚’ãƒ‘ãƒ¼ã‚¹ã™ã‚‹ã‚³ãƒ¼ãƒ‰ãƒãƒ¼ãƒ‰ã§ã™ã€‚

### ãƒãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ—
**ã‚³ãƒ¼ãƒ‰ãƒãƒ¼ãƒ‰**

### å…¥åŠ›å¤‰æ•°

| å¤‰æ•°å | å¤‰æ•°å€¤ |
|--------|--------|
| `body` | {{#node2b.body#}} |

### ã‚³ãƒ¼ãƒ‰ï¼ˆPythonï¼‰

```python
import json

def main(body: str) -> dict:
    data = json.loads(body)
    spots = []
    
    for result in data.get("results", []):
        spot = {
            "name": result.get("name", ""),
            "lat": result.get("geometry", {}).get("location", {}).get("lat", 0),
            "lng": result.get("geometry", {}).get("location", {}).get("lng", 0),
            "place_id": result.get("place_id", ""),
            "rating": result.get("rating", 0),
            "reviews": result.get("user_ratings_total", 0),
            "types": ", ".join(result.get("types", [])),
            "address": result.get("vicinity", "")
        }
        spots.append(spot)
    
    # ã‚¹ãƒãƒƒãƒˆã®æƒ…å ±ã‚’å€‹åˆ¥å¤‰æ•°ã¨ã—ã¦å‡ºåŠ›
    spots_summary = ""
    for i, s in enumerate(spots):
        spots_summary += f"{i+1}. {s['name']} (è©•ä¾¡: {s['rating']}, {s['address']})\n"
    
    return {
        "spots_json": json.dumps(spots, ensure_ascii=False),
        "spots_count": len(spots),
        "spots_summary": spots_summary
    }
```

### å‡ºåŠ›å¤‰æ•°

| å¤‰æ•°å | å‹ | èª¬æ˜ |
|--------|-----|------|
| `spots_json` | String | ã‚¹ãƒãƒƒãƒˆé…åˆ—ã®JSON |
| `spots_count` | Number | ã‚¹ãƒãƒƒãƒˆæ•° |
| `spots_summary` | String | ã‚¹ãƒãƒƒãƒˆä¸€è¦§ï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‰ |

---

## ğŸ”§ ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½¿ã†å ´åˆã®è©³ç´°æ‰‹é †

ã‚‚ã—Wikipedia APIã§ã®æƒ…å ±å–å¾—ã‚’å®Ÿè£…ã—ãŸã„å ´åˆï¼š

### ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ§‹é€ 

```
[Node 2b-parse]
      â†“
[Node 2c: ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³] â”€â”
      â”‚                   â”‚
      â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚   â”‚  ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å†…éƒ¨:           â”‚
      â”‚   â”‚                               â”‚
      â”‚   â”‚  [HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆ]             â”‚
      â”‚   â”‚   URL: Wikipedia API          â”‚
      â”‚   â”‚   å„ã‚¹ãƒãƒƒãƒˆã®æƒ…å ±ã‚’å–å¾—      â”‚
      â”‚   â”‚                               â”‚
      â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                   â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“ (ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœã¯è‡ªå‹•ã§é…åˆ—ã«)
[Node 2c-merge: ã‚³ãƒ¼ãƒ‰ãƒãƒ¼ãƒ‰]
      â†“
[Node 2d: Theme Scoring]
```

### Step 1: ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ãƒ‰ã‚’è¿½åŠ 

1. ãƒãƒ¼ãƒ‰ãƒ‘ãƒãƒ«ã‹ã‚‰ã€Œã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€ã‚’ãƒ‰ãƒ©ãƒƒã‚°
2. Node 2b-parse ã®å¾Œã«æ¥ç¶š

### Step 2: ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š

| é …ç›® | è¨­å®šå€¤ |
|------|--------|
| å…¥åŠ› | ï¼ˆé…åˆ—å¤‰æ•°ã‚’é¸æŠï¼‰ |
| ä¸¦åˆ—å®Ÿè¡Œ | ON |
| æœ€å¤§ä¸¦åˆ—æ•° | 3 |
| ä¾‹å¤–å‡¦ç† | ç¶šè¡Œ |

**æ³¨æ„**: Difyã§ã¯é…åˆ—ã‚’JSONã‹ã‚‰ç›´æ¥ãƒ‘ãƒ¼ã‚¹ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
äº‹å‰ã«ã‚³ãƒ¼ãƒ‰ãƒãƒ¼ãƒ‰ã§ãƒªã‚¹ãƒˆå½¢å¼ã«å¤‰æ›ãŒå¿…è¦ãªå ´åˆãŒã‚ã‚Šã¾ã™ã€‚

### Step 3: ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å†…ã«HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¿½åŠ 

ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ãƒ‰ã®**å†…éƒ¨**ã«HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒãƒ¼ãƒ‰ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¾ã™ã€‚

**åŸºæœ¬è¨­å®š:**
| é …ç›® | è¨­å®šå€¤ |
|------|--------|
| API | GET |
| URL | `https://ja.wikipedia.org/api/rest_v1/page/summary/{{#item.name#}}` |

**ãƒ˜ãƒƒãƒ€ãƒ¼:**
| ã‚­ãƒ¼ | å€¤ |
|------|-----|
| `Accept` | `application/json` |

**ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š:**
- æ¥ç¶šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: 10ç§’
- èª­ã¿å–ã‚Šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: 10ç§’

**å¤±æ•—æ™‚å†è©¦è¡Œ:**
- æœ€å¤§è©¦è¡Œå›æ•°: 1å›

**ä¾‹å¤–å‡¦ç†:**
- æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆã‚¨ãƒ©ãƒ¼ã§ã‚‚ç¶šè¡Œï¼‰

### Step 4: ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã®ãƒãƒ¼ã‚¸ï¼ˆã‚³ãƒ¼ãƒ‰ãƒãƒ¼ãƒ‰ï¼‰

ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœã¨ã‚¹ãƒãƒƒãƒˆæƒ…å ±ã‚’ãƒãƒ¼ã‚¸ã—ã¾ã™ã€‚

```python
import json

def main(iteration_results: list, original_spots: str) -> dict:
    spots = json.loads(original_spots)
    
    # ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœã‚’ã‚¹ãƒãƒƒãƒˆã«ãƒãƒ¼ã‚¸
    for i, spot in enumerate(spots):
        if i < len(iteration_results):
            wiki = iteration_results[i]
            if wiki and isinstance(wiki, dict):
                spot["wikipedia_summary"] = wiki.get("body", {}).get("extract", "")
    
    return {
        "enriched_spots": json.dumps(spots, ensure_ascii=False)
    }
```

---

## ğŸš€ ã‚·ãƒ³ãƒ—ãƒ«ãªä»£æ›¿æ¡ˆï¼ˆæ¨å¥¨ï¼‰

**ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½¿ã‚ãšã€LLMã«æƒ…å ±ã‚’ç”Ÿæˆã•ã›ã‚‹æ–¹æ³•ï¼š**

### Node 2d ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«è¿½åŠ 

```
ã€ã‚¹ãƒãƒƒãƒˆä¸€è¦§ã€‘
{{#node2b_parse.spots_summary#}}

å„ã‚¹ãƒãƒƒãƒˆã«ã¤ã„ã¦ä»¥ä¸‹ã‚‚æ¨æ¸¬ã—ã¦è¿½åŠ ã—ã¦ãã ã•ã„ï¼š
- æ­´å²çš„èƒŒæ™¯ï¼ˆãã®ã‚¹ãƒãƒƒãƒˆã®æ­´å²ï¼‰
- è¬è§£ãã«ä½¿ãˆã‚‹è¦ç´ ï¼ˆå»ºç¯‰çš„ç‰¹å¾´ã€ä¼èª¬ã€é€¸è©±ãªã©ï¼‰

ã€ã‚¨ãƒªã‚¢ã®æ­´å²æƒ…å ±ï¼ˆå‚è€ƒï¼‰ã€‘
{{#node2a_parse.area_history#}}
{{#node2a_parse.local_stories#}}
```

ã“ã‚Œã«ã‚ˆã‚Šï¼š
- Wikipedia APIãŒä¸è¦
- ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã«ãã„
- LLMãŒæ–‡è„ˆã«åˆã£ãŸæƒ…å ±ã‚’ç”Ÿæˆ

---

## âœ… çµè«–

1. **ä»Šã¯ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆNode 2cï¼‰ã‚’ã‚¹ã‚­ãƒƒãƒ—**
2. **Node 2b â†’ Node 2b-parse â†’ Node 2d** ã®æµã‚Œã§é€²ã‚ã‚‹
3. **å¾Œã‹ã‚‰å¿…è¦ã«å¿œã˜ã¦Wikipediaå–å¾—ã‚’è¿½åŠ **

ã“ã‚Œã§ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å…¨ä½“ã‚’æ—©ãå®Œæˆã§ãã¾ã™ï¼
